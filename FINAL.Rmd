---
title: "Final"
author: "Ayush Kris"
date: "2023-12-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Initialization

### Read in

```{r warning=FALSE, message=FALSE}
# import libraries and files
library(tidyverse)
library(survival)
library(survminer)
library(glmnet)
library(ggrepel)
library(forestploter)
library(ggsci)
library(grid)
library(DescTools)
library(data.table)
library(readxl)
library(ggpubr)
library(gridExtra)


MAF_final <- fread("data_mutations_extended.oncokb.txt")
fusions_final <- fread("data_sv.oncokb.txt")
CNA_final <- fread("data_CNA.oncokb.txt")
clinical_final <- read_excel("clinical_mss_anonymous_20240125.xlsx") #update from Paolo
clinical_final <-clinical_final %>% filter(sample_type3!="Liquid Biopsy")
ever_met_final <- fread("2023_08_28_IMPACT_Darwin_Sample_Summary_noPHI.csv")
met_sites_final <- fread("2023_08_28_table_met_site_summary_noPHI.csv")
#filter for only MSS CRC clean cohort: already done by Paolo
MAF_final <- MAF_final %>% filter(Tumor_Sample_Barcode %in% clinical_final$SAMPLE_ID)
fusions_final <- fusions_final %>% filter(Sample_ID %in% clinical_final$SAMPLE_ID)
CNA_final <- CNA_final %>% filter(SAMPLE_ID %in% clinical_final$SAMPLE_ID)
ever_met_final <- ever_met_final %>% filter(SAMPLE_ID %in% clinical_final$SAMPLE_ID)
ever_met_final <- distinct(ever_met_final)
met_sites_final <- met_sites_final %>% filter(DMP_ID %in% clinical_final$PATIENT_ID)
met_sites_final <- distinct(met_sites_final) # 5734 samples (1156 more sample than previous cohort)

#remove samples with no alteration calls
group11 <- setdiff(clinical_final$SAMPLE_ID, MAF_final$Tumor_Sample_Barcode)
group21 <- setdiff(clinical_final$SAMPLE_ID, CNA_final$SAMPLE_ID)
group31 <- setdiff(clinical_final$SAMPLE_ID, fusions_final$Sample_ID)
intersection1 <- intersect(group11, group21)
common_elements <- intersect(intersection1, group31)
rm(group11, group21, group31, intersection1)
```

```{r}
# get metastatic burden columns ready

columns_to_convert_final<- c("ADRENAL_GLANDS", "BONE","CNS_BRAIN","INTRA-ABDOMINAL","LIVER","LUNG", "LYMPH_NODES", "OTHER","PLEURA","REPRODUCTIVE_ORGANS")

clinical_final <- clinical_final %>%
  mutate_at(.vars = columns_to_convert_final, .funs = ~ifelse(. == "Yes", 1, 0))

clinical_final <- clinical_final %>%
  mutate(Met_Burden = rowSums(select(., columns_to_convert_final)))

```

### Update Gene Names

```{r warning=FALSE, message=FALSE}
impact_genes<-fread("impact_genes_upto505.txt")
#impact_genes <- impact_genes$`Approved Symbol`
impact_genes1<-impact_genes
#gene names in MAF1, CNA1, Fusions1 need to be updated (contains both old and new)
#GAM1 colnames need to be updated (contains both old and new)
updated_gene_names<-fread("Hugofied_Genes_to_Send.csv")

#MAF
# Use match to get the indices of the old_gene in gene_mapping$new_gene
indices <- match(MAF_final$Hugo_Symbol, updated_gene_names$PreviousName)
# Update the gene column in MAF1 with the corresponding new_gene values
MAF_final$Hugo_Symbol <- ifelse(!is.na(indices), updated_gene_names$Hugofied[indices], MAF_final$Hugo_Symbol)
#CNA
indices <- match(CNA_final$HUGO_SYMBOL, updated_gene_names$PreviousName)
# Update the gene column in CNA with the corresponding new_gene values
CNA_final$HUGO_SYMBOL <- ifelse(!is.na(indices), updated_gene_names$Hugofied[indices], CNA_final$HUGO_SYMBOL)
#Fusions
indices <- match(fusions_final$Site1_Hugo_Symbol, updated_gene_names$PreviousName)
# Update the gene column in Fusion with the corresponding new_gene values
fusions_final$Site1_Hugo_Symbol <- ifelse(!is.na(indices), updated_gene_names$Hugofied[indices], fusions_final$Site1_Hugo_Symbol)
indices <- match(fusions_final$Site2_Hugo_Symbol, updated_gene_names$PreviousName)
# Update the gene column in Fusion with the corresponding new_gene values
fusions_final$Site2_Hugo_Symbol <- ifelse(!is.na(indices), updated_gene_names$Hugofied[indices], fusions_final$Site2_Hugo_Symbol)

indices <- match(impact_genes1$`Approved Symbol`, updated_gene_names$PreviousName)
# Update the gene column in MAF1 with the corresponding new_gene values
impact_genes1$`Approved Symbol` <- ifelse(!is.na(indices), updated_gene_names$Hugofied[indices], impact_genes1$`Approved Symbol`)
```

remove matched from analysis

### Create Genes GAM

```{r message=FALSE, warning=FALSE}
combined_tumor_samples <- (clinical_final$SAMPLE_ID)
#impact_genes<-fread("impact_genes_upto505.txt")
#impact_genes <- impact_genes$`Approved Symbol`
MAF_genes <- unique(MAF_final$Hugo_Symbol)
CNA_genes <- unique(CNA_final$HUGO_SYMBOL)
Fusions_genes <- unique(c(fusions_final$Site1_Hugo_Symbol,fusions_final$Site2_Hugo_Symbol))
all_genes <- unique(c(MAF_genes, CNA_genes, Fusions_genes))

GAM_MAF <- matrix(0, nrow = length(combined_tumor_samples), ncol = length(all_genes)) #initialize matrix with 0s
rownames(GAM_MAF) <- combined_tumor_samples #set row and column names
colnames(GAM_MAF) <- all_genes

for (i in 1:nrow(MAF_final)){ # set value to 1 if mutation is present and is oncogenic
  if (MAF_final$ONCOGENIC[i]=="Oncogenic" | MAF_final$ONCOGENIC[i] == "Likely Oncogenic"){
    GAM_MAF[MAF_final$Tumor_Sample_Barcode[i], MAF_final$Hugo_Symbol[i]] <- 1
  }
}

GAM_CNA_onco <- matrix(0, nrow = length(combined_tumor_samples), ncol = length(all_genes))
rownames(GAM_CNA_onco) <- combined_tumor_samples #set row and column names
colnames(GAM_CNA_onco) <- all_genes
alter<- c("Amplification","Deletion")
for (i in 1:nrow(CNA_final)){ #set to 1 if CNA is present AND oncogenic
  if ((CNA_final$ALTERATION[i] %in% alter) & (CNA_final$ONCOGENIC[i]%in% c("Oncogenic", "Likely Oncogenic"))){
    GAM_CNA_onco[CNA_final$SAMPLE_ID[i], CNA_final$HUGO_SYMBOL[i]] <- 1
  }
}

GAM_Fusions_onco <- matrix(0, nrow = length(combined_tumor_samples), ncol = length(all_genes))
rownames(GAM_Fusions_onco) <- combined_tumor_samples #set row and column names
colnames(GAM_Fusions_onco) <- all_genes
for (i in 1:nrow(fusions_final)){
  if(fusions_final$ONCOGENIC[i] == "Oncogenic"| fusions_final$ONCOGENIC[i] == "Likely Oncogenic"){
  
    GAM_Fusions_onco[fusions_final$Sample_ID[i], fusions_final$Site1_Hugo_Symbol[i]] <- 1
    if(!is.na(fusions_final$Site2_Hugo_Symbol[i]) && fusions_final$Site2_Hugo_Symbol[i] != ""){
      GAM_Fusions_onco[fusions_final$Sample_ID[i], fusions_final$Site2_Hugo_Symbol[i]] <- 1}}}

GAM_final <-(GAM_Fusions_onco | GAM_CNA_onco | GAM_MAF)
GAM_final <- 1*GAM_final

GAM_matched_colnames <- colnames(GAM_final)

# Subset GAM_matched to keep only the selected columns
GAM_final<- GAM_final[, GAM_matched_colnames[GAM_matched_colnames %in% impact_genes1$`Approved Symbol`]]

impact_genes_341 <- impact_genes1 %>% filter(`First Design` == "IMPACT-341")
impact_genes_341 <- impact_genes_341$`Approved Symbol` # list of genes in first panel
impact_genes_410 <- impact_genes1 %>% filter(`First Design` == "IMPACT-341" | `First Design` == "IMPACT-410" )
impact_genes_410<-impact_genes_410$`Approved Symbol` 
impact_genes_468<-impact_genes1 %>% filter(`First Design` == "IMPACT-341" | `First Design` == "IMPACT-410" | `First Design` == "IMPACT-468" )
impact_genes_468<-impact_genes_468$`Approved Symbol` 

impact_genes_505<-impact_genes1 %>% filter(`First Design` == "IMPACT-341" | `First Design` == "IMPACT-410" | `First Design` == "IMPACT-468"| `First Design` == "IMPACT-505" )
impact_genes_505<-impact_genes_505$`Approved Symbol` 
#which(colnames(GAM_final) == "")
#GAM_final <- GAM_final[, -381]

for (row_name in row.names(GAM_final)) {
  if (endsWith(row_name, "IM3")) {
    for (column_name in colnames(GAM_final)) {
      if (!(column_name %in% impact_genes_341)) {
        GAM_final[row_name, column_name] <- NA
      }
    }
  }
  if (endsWith(row_name, "IM5")) {
    for (column_name in colnames(GAM_final)) {
      if (!(column_name %in% impact_genes_410)) {
        GAM_final[row_name, column_name] <- NA
      }
    }
  }
  if (endsWith(row_name, "IM6")) {
    for (column_name in colnames(GAM_final)) {
      if (!(column_name %in% impact_genes_468)) {
        GAM_final[row_name, column_name] <- NA
      }
    }
  }
  if (endsWith(row_name, "IM7")) {
    for (column_name in colnames(GAM_final)) {
      if (!(column_name %in% impact_genes_505)) {
        GAM_final[row_name, column_name] <- NA
      }
    }
  }
}
GAM_final <- as.data.frame(GAM_final)
GAM_final$Samples <- rownames(GAM_final)
GAM_final <- GAM_final %>%select(Samples, everything())
```

### Create Pathway GAM

```{r}
load("pathway_groupings.Rdata")
unique_pathways <- unique(pathway_groupings$pathway)
GAM_matched_f <- GAM_final %>% select(-Samples)
temp_GAM_f <- GAM_matched_f
temp_GAM_f[is.na(temp_GAM_f)] <- 0
# Create empty binary matrix
pathway_binary_matrix_f <- matrix(0, nrow = nrow(temp_GAM_f), ncol = length(unique_pathways),dimnames = list(rownames(temp_GAM_f), unique_pathways))

# Iterate over each gene in GAM_onco matrix
for (gene in colnames(temp_GAM_f)) {
  # Find corresponding pathway
  pathway <- pathway_groupings$pathway[pathway_groupings$gene == gene]

  # Update pathway column in binary matrix
  pathway_binary_matrix_f[, pathway] <- pathway_binary_matrix_f[, pathway] | temp_GAM_f[, gene]
}
pathway_binary_matrix_f <- as.data.frame(pathway_binary_matrix_f)
pathway_binary_matrix_f$Samples <- rownames(pathway_binary_matrix_f)
pathway_binary_matrix_f <- pathway_binary_matrix_f %>%select(Samples, everything())
pathway_GAM_final <- pathway_binary_matrix_f
rm(temp_GAM_f)
rm(GAM_matched_f)
rm(pathway_binary_matrix_f)

```

# Primary vs Met

```{r}

#select primary and metastasis sample IDs
MSS_primary<-clinical_final%>%filter(sample_type3 == "Primary")%>% filter(sidedness_mpt == "Rectum")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary<-MSS_primary$SAMPLE_ID
MSS_primary_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary, ]




#  MET GAM
MSS_primary_met<-clinical_final%>%filter(sample_type3 == "Metastasis")%>%filter(sidedness_mpt=="Rectum")%>%filter(metsite %in% c("Adrenal gland", "Bone", "Brain", "Liver", "Lung", "Ovary", "Peritoneum"))%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary_met<-MSS_primary_met$SAMPLE_ID
MSS_primary_met_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary_met, ]

#perform statistical comparisons 

#MSI Primary
MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats["Samples",]
MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats <- MSS_primary_stats %>% select(MSS_pri_WT, MSS_pri_Alt, MSS_pri_Alt_per)

#MSS mid primary
MSS_mid_stats<- data.frame(t(MSS_primary_met_GAM)) # transpose, each row = gene 
colnames(MSS_mid_stats)<-MSS_mid_stats["Samples",]
MSS_mid_stats <- MSS_mid_stats[rownames(MSS_mid_stats) != "Samples", ]
MSS_mid_stats <- MSS_mid_stats%>%mutate_all(as.numeric) #####

MSS_mid_stats <- MSS_mid_stats %>%mutate(MSS_mid_WT = rowSums(MSS_mid_stats == 0, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt= rowSums(across(!c(MSS_mid_WT))== 1, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt_per = MSS_mid_Alt/(MSS_mid_WT+MSS_mid_Alt))
MSS_mid_stats$MSS_mid_Alt_per[is.nan(MSS_mid_stats$MSS_mid_Alt_per)] <- 0
MSS_mid_stats <- MSS_mid_stats %>% select(MSS_mid_WT, MSS_mid_Alt, MSS_mid_Alt_per)

combined_df <- merge(MSS_primary_stats, MSS_mid_stats, by = "row.names", all = TRUE)
combined_df<- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per) 
colnames(combined_df)[1] <- "Gene" # df with MSS-primary and MSS_mid %Alt
rownames(combined_df)<-combined_df$Gene # rename rownames to Genes


for (gene in row.names(MSS_primary_stats)) {
  # Perform operations using the gene name
  contingency_table<-matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],MSS_mid_stats[[gene, "MSS_mid_Alt"]], MSS_mid_stats[[gene, "MSS_mid_WT"]]), nrow = 2, ncol = 2, byrow = TRUE)
  rownames(contingency_table) <- c("Primary", "Mid")
colnames(contingency_table) <- c("Altered", "Unaltered")
fisher_result <- fisher.test((contingency_table))
p_value <- fisher_result$p.value
combined_df[gene, "p_value"] <- p_value # add p_value to new column in df

}
######
#remove genes with 0% alteration for both conditions
combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per ==0 & combined_df$MSS_mid_Alt_per == 0))
#########
# Perform multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values


subset_data <- combined_df[order(combined_df$adjusted_p_value), ]
top_10_genes <- head(subset_data, 10) # top 10 most significant 


# Reshape data for plotting
primary_df<- top_10_genes%>% dplyr::select(Gene, MSS_pri_Alt_per)
colnames(primary_df)[2] <- "Percent"
mid_df<-top_10_genes%>% dplyr::select(Gene, MSS_mid_Alt_per)
colnames(mid_df)[2] <- "Percent"

plot_df_primary_mid <- rbind(transform(primary_df, Condition = "Primary"),
                     transform(mid_df, Condition = "Metastasis"))
plot_df_primary_mid$Percent <- as.numeric(plot_df_primary_mid$Percent)
plot_df_primary_mid$Condition <- factor(plot_df_primary_mid$Condition, levels = c("Primary", "Metastasis"))

# Create the bar plot
myplot<-ggplot(plot_df_primary_mid,aes(x = as.character(Gene), y =(Percent)*100, fill = Condition)) +
geom_bar(stat = "identity", position = "dodge")+labs(x = "Gene", y = "Percent Oncogenic Alterations") + theme_pubr()+scale_color_lancet() + scale_fill_lancet()
#+ theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))
myplot
#ggsave(filename = "my_plot.png", plot = myplot, width = 7, height = 7, dpi = 700)
top_MSS_genes <- combined_df[order(combined_df$MSS_pri_Alt_per, decreasing = TRUE), ]
top_MSS_genes<-head(top_MSS_genes, 20) #save this
top_MSS_genes<-top_MSS_genes%>% select(Gene)
```

Pathway: Primary vs Met in aggr

```{r}
MSS_primary<-clinical_final%>%filter(sample_type3 == "Primary") %>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary<-MSS_primary$SAMPLE_ID
MSS_primary_GAM<-pathway_GAM_final[pathway_GAM_final$Samples %in% MSS_primary, ]




#  MET GAM
MSS_primary_met<-clinical_final%>%filter(sample_type3 == "Metastasis")%>% filter(metsite %in% c("Adrenal gland", "Bone", "Brain", "Liver", "Lung", "Ovary", "Peritoneum"))%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary_met<-MSS_primary_met$SAMPLE_ID
MSS_primary_met_GAM<-pathway_GAM_final[pathway_GAM_final$Samples %in% MSS_primary_met, ]



#MSI Primary
MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats["Samples",]
MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats <- MSS_primary_stats %>% select(MSS_pri_WT, MSS_pri_Alt, MSS_pri_Alt_per)

#MSS mid primary
MSS_mid_stats<- data.frame(t(MSS_primary_met_GAM)) # transpose, each row = gene 
colnames(MSS_mid_stats)<-MSS_mid_stats["Samples",]
MSS_mid_stats <- MSS_mid_stats[rownames(MSS_mid_stats) != "Samples", ]
MSS_mid_stats <- MSS_mid_stats%>%mutate_all(as.numeric) #####

MSS_mid_stats <- MSS_mid_stats %>%mutate(MSS_mid_WT = rowSums(MSS_mid_stats == 0, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt= rowSums(across(!c(MSS_mid_WT))== 1, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt_per = MSS_mid_Alt/(MSS_mid_WT+MSS_mid_Alt))
MSS_mid_stats$MSS_mid_Alt_per[is.nan(MSS_mid_stats$MSS_mid_Alt_per)] <- 0
MSS_mid_stats <- MSS_mid_stats %>% select(MSS_mid_WT, MSS_mid_Alt, MSS_mid_Alt_per)

combined_df <- merge(MSS_primary_stats, MSS_mid_stats, by = "row.names", all = TRUE)
combined_df<- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per) 
colnames(combined_df)[1] <- "Gene" # df with MSS-primary and MSS_mid %Alt
rownames(combined_df)<-combined_df$Gene # rename rownames to Genes


for (gene in row.names(MSS_primary_stats)) {
  # Perform operations using the gene name
  contingency_table<-matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],MSS_mid_stats[[gene, "MSS_mid_Alt"]], MSS_mid_stats[[gene, "MSS_mid_WT"]]), nrow = 2, ncol = 2, byrow = TRUE)
  rownames(contingency_table) <- c("Primary", "Mid")
colnames(contingency_table) <- c("Altered", "Unaltered")
fisher_result <- fisher.test((contingency_table))
p_value <- fisher_result$p.value
combined_df[gene, "p_value"] <- p_value # add p_value to new column in df

}
######
#remove genes with 0% alteration for both conditions
combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per ==0 & combined_df$MSS_mid_Alt_per == 0))
#########
# Perform multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values


subset_data <- combined_df[order(combined_df$adjusted_p_value), ]
top_10_genes <- head(subset_data, 10) # top 10 most significant 


# Reshape data for plotting
primary_df<- top_10_genes%>% dplyr::select(Gene, MSS_pri_Alt_per)
colnames(primary_df)[2] <- "Percent"
mid_df<-top_10_genes%>% dplyr::select(Gene, MSS_mid_Alt_per)
colnames(mid_df)[2] <- "Percent"

plot_df_primary_mid <- rbind(transform(primary_df, Condition = "Primary"),
                     transform(mid_df, Condition = "Metastasis"))
plot_df_primary_mid$Percent <- as.numeric(plot_df_primary_mid$Percent)
plot_df_primary_mid$Condition <- factor(plot_df_primary_mid$Condition, levels = c("Primary", "Metastasis"))


# Create the bar plot
myplot<-ggplot(plot_df_primary_mid,aes(x = as.character(Gene), y =(Percent)*100, fill = Condition)) +
geom_bar(stat = "identity", position = "dodge")+labs(x = "Pathway", y = "Percent Oncogenic Alterations") + theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))+ theme_pubr()+scale_color_lancet() + scale_fill_lancet()#+ theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))
myplot
top_MSS_pathway <- combined_df[order(combined_df$MSS_pri_Alt_per, decreasing = TRUE), ]
top_MSS_pathway<-top_MSS_pathway%>% select(Gene)
```

privmet_aggr_path, privmet_aggr_path_left, privmet_aggr_path_right, privmet_aggr_path_rectum

Never vs LaterMet

```{r}
MSS_primary<-clinical_final%>%filter(sample_type3 == "Primary")%>% filter(any_ttm_event ==0)%>% filter(any_ttm >=24) %>% filter(stage2 == "Stage 1-3")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary<-MSS_primary$SAMPLE_ID
MSS_primary_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary, ]




#  MET GAM
MSS_primary_met<-clinical_final%>%filter(sample_type3 == "Primary")%>% filter(any_ttm_event==1)%>%filter(any_ttm >=6)%>% filter(stage2 =="Stage 1-3")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary_met<-MSS_primary_met$SAMPLE_ID
MSS_primary_met_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary_met, ]



#MSI Primary
MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats["Samples",]
MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats <- MSS_primary_stats %>% select(MSS_pri_WT, MSS_pri_Alt, MSS_pri_Alt_per)

#MSS mid primary
MSS_mid_stats<- data.frame(t(MSS_primary_met_GAM)) # transpose, each row = gene 
colnames(MSS_mid_stats)<-MSS_mid_stats["Samples",]
MSS_mid_stats <- MSS_mid_stats[rownames(MSS_mid_stats) != "Samples", ]
MSS_mid_stats <- MSS_mid_stats%>%mutate_all(as.numeric) #####

MSS_mid_stats <- MSS_mid_stats %>%mutate(MSS_mid_WT = rowSums(MSS_mid_stats == 0, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt= rowSums(across(!c(MSS_mid_WT))== 1, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt_per = MSS_mid_Alt/(MSS_mid_WT+MSS_mid_Alt))
MSS_mid_stats$MSS_mid_Alt_per[is.nan(MSS_mid_stats$MSS_mid_Alt_per)] <- 0
MSS_mid_stats <- MSS_mid_stats %>% select(MSS_mid_WT, MSS_mid_Alt, MSS_mid_Alt_per)

combined_df <- merge(MSS_primary_stats, MSS_mid_stats, by = "row.names", all = TRUE)
combined_df<- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per) 
colnames(combined_df)[1] <- "Gene" # df with MSS-primary and MSS_mid %Alt
rownames(combined_df)<-combined_df$Gene # rename rownames to Genes


for (gene in row.names(MSS_primary_stats)) {
  # Perform operations using the gene name
  contingency_table<-matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],MSS_mid_stats[[gene, "MSS_mid_Alt"]], MSS_mid_stats[[gene, "MSS_mid_WT"]]), nrow = 2, ncol = 2, byrow = TRUE)
  rownames(contingency_table) <- c("Primary", "Mid")
colnames(contingency_table) <- c("Altered", "Unaltered")
fisher_result <- fisher.test((contingency_table))
p_value <- fisher_result$p.value
combined_df[gene, "p_value"] <- p_value # add p_value to new column in df

}
######
#remove genes with 0% alteration for both conditions
combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per ==0 & combined_df$MSS_mid_Alt_per == 0))
#########
# Perform multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values


subset_data <- combined_df[order(combined_df$adjusted_p_value), ]
top_10_genes <- head(subset_data, 10) # top 10 most significant 


# Reshape data for plotting
primary_df<- top_10_genes%>% dplyr::select(Gene, MSS_pri_Alt_per)
colnames(primary_df)[2] <- "Percent"
mid_df<-top_10_genes%>% dplyr::select(Gene, MSS_mid_Alt_per)
colnames(mid_df)[2] <- "Percent"

plot_df_primary_mid <- rbind(transform(primary_df, Condition = "Never-Met"),
                     transform(mid_df, Condition = "Later_Met"))
plot_df_primary_mid$Percent <- as.numeric(plot_df_primary_mid$Percent)
plot_df_primary_mid$Condition <- factor(plot_df_primary_mid$Condition, levels = c("Never-Met", "Later_Met"))

# Create the bar plot
myplot<-ggplot(plot_df_primary_mid,aes(x = as.character(Gene), y =(Percent)*100, fill = Condition)) +
geom_bar(stat = "identity", position = "dodge")+labs(x = "Gene", y = "Percent Oncogenic Alterations") + theme_pubr()+scale_color_lancet() + scale_fill_lancet()
#+ theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))
myplot
#ggsave(filename = "my_plot.png", plot = myplot, width = 7, height = 7, dpi = 700)
top_MSS_genes <- combined_df[order(combined_df$MSS_pri_Alt_per, decreasing = TRUE), ]
top_MSS_genes<-head(top_MSS_genes, 20) #save this
top_MSS_genes<-top_MSS_genes%>% select(Gene)
```

Never vs Conc-Met

```{r}
MSS_primary<-clinical_final%>%filter(sample_type3 == "Primary")%>% filter(any_ttm_event ==0)%>% filter(any_ttm >=24) %>% filter(stage2 == "Stage 1-3")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary<-MSS_primary$SAMPLE_ID
MSS_primary_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary, ]




#  MET GAM
MSS_primary_met<-clinical_final%>%filter(sample_type3 == "Primary")%>% filter(any_ttm_event==1)%>%filter(any_ttm < 6)%>% filter(stage2 =="Stage 4")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary_met<-MSS_primary_met$SAMPLE_ID
MSS_primary_met_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary_met, ]



#MSI Primary
MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats["Samples",]
MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats <- MSS_primary_stats %>% select(MSS_pri_WT, MSS_pri_Alt, MSS_pri_Alt_per)

#MSS mid primary
MSS_mid_stats<- data.frame(t(MSS_primary_met_GAM)) # transpose, each row = gene 
colnames(MSS_mid_stats)<-MSS_mid_stats["Samples",]
MSS_mid_stats <- MSS_mid_stats[rownames(MSS_mid_stats) != "Samples", ]
MSS_mid_stats <- MSS_mid_stats%>%mutate_all(as.numeric) #####

MSS_mid_stats <- MSS_mid_stats %>%mutate(MSS_mid_WT = rowSums(MSS_mid_stats == 0, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt= rowSums(across(!c(MSS_mid_WT))== 1, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt_per = MSS_mid_Alt/(MSS_mid_WT+MSS_mid_Alt))
MSS_mid_stats$MSS_mid_Alt_per[is.nan(MSS_mid_stats$MSS_mid_Alt_per)] <- 0
MSS_mid_stats <- MSS_mid_stats %>% select(MSS_mid_WT, MSS_mid_Alt, MSS_mid_Alt_per)

combined_df <- merge(MSS_primary_stats, MSS_mid_stats, by = "row.names", all = TRUE)
combined_df<- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per) 
colnames(combined_df)[1] <- "Gene" # df with MSS-primary and MSS_mid %Alt
rownames(combined_df)<-combined_df$Gene # rename rownames to Genes


for (gene in row.names(MSS_primary_stats)) {
  # Perform operations using the gene name
  contingency_table<-matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],MSS_mid_stats[[gene, "MSS_mid_Alt"]], MSS_mid_stats[[gene, "MSS_mid_WT"]]), nrow = 2, ncol = 2, byrow = TRUE)
  rownames(contingency_table) <- c("Primary", "Mid")
colnames(contingency_table) <- c("Altered", "Unaltered")
fisher_result <- fisher.test((contingency_table))
p_value <- fisher_result$p.value
combined_df[gene, "p_value"] <- p_value # add p_value to new column in df

}
######
#remove genes with 0% alteration for both conditions
combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per ==0 & combined_df$MSS_mid_Alt_per == 0))
#########
# Perform multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values


subset_data <- combined_df[order(combined_df$adjusted_p_value), ]
top_10_genes <- head(subset_data, 10) # top 10 most significant 


# Reshape data for plotting
primary_df<- top_10_genes%>% dplyr::select(Gene, MSS_pri_Alt_per)
colnames(primary_df)[2] <- "Percent"
mid_df<-top_10_genes%>% dplyr::select(Gene, MSS_mid_Alt_per)
colnames(mid_df)[2] <- "Percent"

plot_df_primary_mid <- rbind(transform(primary_df, Condition = "Never-Met"),
                     transform(mid_df, Condition = "Concurrent Met"))
plot_df_primary_mid$Percent <- as.numeric(plot_df_primary_mid$Percent)
plot_df_primary_mid$Condition <- factor(plot_df_primary_mid$Condition, levels = c("Never-Met", "Concurrent Met"))

# Create the bar plot
myplot<-ggplot(plot_df_primary_mid,aes(x = as.character(Gene), y =(Percent)*100, fill = Condition)) +
geom_bar(stat = "identity", position = "dodge")+labs(x = "Gene", y = "Percent Oncogenic Alterations") + theme_pubr()+scale_color_lancet() + scale_fill_lancet()
#+ theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))
myplot
#ggsave(filename = "my_plot.png", plot = myplot, width = 7, height = 7, dpi = 700)
top_MSS_genes <- combined_df[order(combined_df$MSS_pri_Alt_per, decreasing = TRUE), ]
top_MSS_genes<-head(top_MSS_genes, 20) #save this
top_MSS_genes<-top_MSS_genes%>% select(Gene)
```

Never vs Ever Met

```{r}
MSS_primary<-clinical_final%>%filter(sample_type3 == "Primary")%>% filter(any_ttm_event ==0)%>% filter(any_ttm >=24) %>% filter(stage2 == "Stage 1-3")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary<-MSS_primary$SAMPLE_ID
MSS_primary_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary, ]


later_met <- clinical_final %>% filter(any_ttm_event == 1) %>% filter(any_ttm >6) %>% filter(sample_type3 == "Primary") %>% filter(stage2 == "Stage 1-3")
later_met <- later_met$SAMPLE_ID
conc_met <- clinical_final %>% filter(any_ttm_event == 1) %>% filter(any_ttm <=6) %>% filter(sample_type3 == "Primary") %>% filter(stage2 == "Stage 4")
conc_met <- conc_met$SAMPLE_ID
MSS_primary_met_GAM<-GAM_final[GAM_final$Samples %in% c(later_met,conc_met), ]



#MSI Primary
MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats["Samples",]
MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats <- MSS_primary_stats %>% select(MSS_pri_WT, MSS_pri_Alt, MSS_pri_Alt_per)

#MSS mid primary
MSS_mid_stats<- data.frame(t(MSS_primary_met_GAM)) # transpose, each row = gene 
colnames(MSS_mid_stats)<-MSS_mid_stats["Samples",]
MSS_mid_stats <- MSS_mid_stats[rownames(MSS_mid_stats) != "Samples", ]
MSS_mid_stats <- MSS_mid_stats%>%mutate_all(as.numeric) #####

MSS_mid_stats <- MSS_mid_stats %>%mutate(MSS_mid_WT = rowSums(MSS_mid_stats == 0, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt= rowSums(across(!c(MSS_mid_WT))== 1, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt_per = MSS_mid_Alt/(MSS_mid_WT+MSS_mid_Alt))
MSS_mid_stats$MSS_mid_Alt_per[is.nan(MSS_mid_stats$MSS_mid_Alt_per)] <- 0
MSS_mid_stats <- MSS_mid_stats %>% select(MSS_mid_WT, MSS_mid_Alt, MSS_mid_Alt_per)

combined_df <- merge(MSS_primary_stats, MSS_mid_stats, by = "row.names", all = TRUE)
combined_df<- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per) 
colnames(combined_df)[1] <- "Gene" # df with MSS-primary and MSS_mid %Alt
rownames(combined_df)<-combined_df$Gene # rename rownames to Genes


for (gene in row.names(MSS_primary_stats)) {
  # Perform operations using the gene name
  contingency_table<-matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],MSS_mid_stats[[gene, "MSS_mid_Alt"]], MSS_mid_stats[[gene, "MSS_mid_WT"]]), nrow = 2, ncol = 2, byrow = TRUE)
  rownames(contingency_table) <- c("Primary", "Mid")
colnames(contingency_table) <- c("Altered", "Unaltered")
fisher_result <- fisher.test((contingency_table))
p_value <- fisher_result$p.value
combined_df[gene, "p_value"] <- p_value # add p_value to new column in df

}
######
#remove genes with 0% alteration for both conditions
combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per ==0 & combined_df$MSS_mid_Alt_per == 0))
#########
# Perform multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values


subset_data <- combined_df[order(combined_df$adjusted_p_value), ]
top_10_genes <- head(subset_data, 10) # top 10 most significant 


# Reshape data for plotting
primary_df<- top_10_genes%>% dplyr::select(Gene, MSS_pri_Alt_per)
colnames(primary_df)[2] <- "Percent"
mid_df<-top_10_genes%>% dplyr::select(Gene, MSS_mid_Alt_per)
colnames(mid_df)[2] <- "Percent"

plot_df_primary_mid <- rbind(transform(primary_df, Condition = "Never-Met"),
                     transform(mid_df, Condition = "Ever Met"))
plot_df_primary_mid$Percent <- as.numeric(plot_df_primary_mid$Percent)
plot_df_primary_mid$Condition <- factor(plot_df_primary_mid$Condition, levels = c("Never-Met", "Ever Met"))

# Create the bar plot
myplot<-ggplot(plot_df_primary_mid,aes(x = as.character(Gene), y =(Percent)*100, fill = Condition)) +
geom_bar(stat = "identity", position = "dodge")+labs(x = "Gene", y = "Percent Oncogenic Alterations") + theme_pubr()+scale_color_lancet() + scale_fill_lancet()
#+ theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))
myplot
#ggsave(filename = "my_plot.png", plot = myplot, width = 7, height = 7, dpi = 700)
top_MSS_genes <- combined_df[order(combined_df$MSS_pri_Alt_per, decreasing = TRUE), ]
top_MSS_genes<-head(top_MSS_genes, 20) #save this
top_MSS_genes<-top_MSS_genes%>% select(Gene)
```

nevervever, nevervever_path

## Ever-Met vs Met in Aggregate

```{r}



later_met <- clinical_final %>% filter(any_ttm_event == 1) %>% filter(any_ttm >6) %>% filter(sample_type3 == "Primary") %>% filter(stage2 == "Stage 1-3") 
later_met <- later_met$SAMPLE_ID
conc_met <- clinical_final %>% filter(any_ttm_event == 1) %>% filter(any_ttm <=6) %>% filter(sample_type3 == "Primary") %>% filter(stage2 == "Stage 4")
conc_met <- conc_met$SAMPLE_ID
MSS_primary_GAM<-GAM_final[GAM_final$Samples %in% c(later_met,conc_met), ]

MSS_primary_met<-clinical_final%>%filter(sample_type3 == "Metastasis") %>% filter(metsite %in% c("Adrenal gland", "Bone", "Brain", "Liver", "Lung", "Ovary", "Peritoneum"))%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary_met<-MSS_primary_met$SAMPLE_ID
MSS_primary_met_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary_met, ]

#MSI Primary
MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats["Samples",]
MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats <- MSS_primary_stats %>% select(MSS_pri_WT, MSS_pri_Alt, MSS_pri_Alt_per)

#MSS mid primary
MSS_mid_stats<- data.frame(t(MSS_primary_met_GAM)) # transpose, each row = gene 
colnames(MSS_mid_stats)<-MSS_mid_stats["Samples",]
MSS_mid_stats <- MSS_mid_stats[rownames(MSS_mid_stats) != "Samples", ]
MSS_mid_stats <- MSS_mid_stats%>%mutate_all(as.numeric) #####

MSS_mid_stats <- MSS_mid_stats %>%mutate(MSS_mid_WT = rowSums(MSS_mid_stats == 0, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt= rowSums(across(!c(MSS_mid_WT))== 1, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt_per = MSS_mid_Alt/(MSS_mid_WT+MSS_mid_Alt))
MSS_mid_stats$MSS_mid_Alt_per[is.nan(MSS_mid_stats$MSS_mid_Alt_per)] <- 0
MSS_mid_stats <- MSS_mid_stats %>% select(MSS_mid_WT, MSS_mid_Alt, MSS_mid_Alt_per)

combined_df <- merge(MSS_primary_stats, MSS_mid_stats, by = "row.names", all = TRUE)
combined_df<- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per) 
colnames(combined_df)[1] <- "Gene" # df with MSS-primary and MSS_mid %Alt
rownames(combined_df)<-combined_df$Gene # rename rownames to Genes


for (gene in row.names(MSS_primary_stats)) {
  # Perform operations using the gene name
  contingency_table<-matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],MSS_mid_stats[[gene, "MSS_mid_Alt"]], MSS_mid_stats[[gene, "MSS_mid_WT"]]), nrow = 2, ncol = 2, byrow = TRUE)
  rownames(contingency_table) <- c("Primary", "Mid")
colnames(contingency_table) <- c("Altered", "Unaltered")
fisher_result <- fisher.test((contingency_table))
p_value <- fisher_result$p.value
combined_df[gene, "p_value"] <- p_value # add p_value to new column in df

}
######
#remove genes with 0% alteration for both conditions
combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per ==0 & combined_df$MSS_mid_Alt_per == 0))
#########
# Perform multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values


subset_data <- combined_df[order(combined_df$adjusted_p_value), ]
top_10_genes <- head(subset_data, 10) # top 10 most significant 


# Reshape data for plotting
primary_df<- top_10_genes%>% dplyr::select(Gene, MSS_pri_Alt_per)
colnames(primary_df)[2] <- "Percent"
mid_df<-top_10_genes%>% dplyr::select(Gene, MSS_mid_Alt_per)
colnames(mid_df)[2] <- "Percent"

plot_df_primary_mid <- rbind(transform(primary_df, Condition = "Ever Met"),
                     transform(mid_df, Condition = "Met"))
plot_df_primary_mid$Percent <- as.numeric(plot_df_primary_mid$Percent)
plot_df_primary_mid$Condition <- factor(plot_df_primary_mid$Condition, levels = c("Ever Met", "Met"))
top_MSS_genes$Met <- combined_df[rownames(top_MSS_genes), "MSS_mid_Alt_per"]
top_MSS_genes$EM <- combined_df[rownames(top_MSS_genes), "MSS_pri_Alt_per"]
liver_heatmap_1 <- top_MSS_genes %>% select(-Gene) %>% mutate(across(Met:EM, ~ . * 100))
my_heat<-pheatmap(t(liver_heatmap_1),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         display_numbers = TRUE,
         fontsize = 10,
         cellwidth = 25,  
  cellheight = 25,
  legend = FALSE,
         scale = "none")  
# Create the bar plot
myplot<-ggplot(plot_df_primary_mid,aes(x = as.character(Gene), y =(Percent)*100, fill = Condition)) +
geom_bar(stat = "identity", position = "dodge")+labs(x = "Gene", y = "Percent Oncogenic Alterations") + theme_pubr()+scale_color_lancet() + scale_fill_lancet()
#+ theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))
myplot
#ggsave(filename = "my_plot.png", plot = myplot, width = 7, height = 7, dpi = 700)
top_MSS_genes <- combined_df[order(combined_df$MSS_pri_Alt_per, decreasing = TRUE), ]
top_MSS_genes<-head(top_MSS_genes, 20) #save this
top_MSS_genes<-top_MSS_genes%>% select(Gene)
```

evermetvmet

## Ever-Met primary vs Met by Site

do Ever_Met vs Met only for top 15 altered genes, not all - probably, none are significant

```{r}
# Create an empty dataframe to store the results
all_results <- data.frame(Gene = character(0), MSS_pri_Alt_per = numeric(0), MSS_mid_Alt_per = numeric(0), Metastatic_Site = character(0), p_value = numeric(0), adjusted_p_value=numeric(0))
results_basic <- list()
# Define metastatic sites
metastatic_sites <- c("Liver", "Lung", "Brain", "Peritoneum","Bone", "Ovary")
ttm_events <- c("liver_ttm_event", "lung_ttm_event", "brain_ttm_event", "perit_ttm_event","bone_ttm_event", "repr_ttm_event")

for (i in seq_along(metastatic_sites)) {
  site <- metastatic_sites[i]
  ttm_event <- ttm_events[i]
  
  if (site == "Ovary") {
    # Filter Primary samples for females only
    MSS_primary <- clinical_final %>% 
      filter(sample_type3 == "Primary") %>% 
      filter(get(ttm_event) == 1) %>%
      filter(SEX == "Female") %>%
      dplyr::select(SAMPLE_ID) 
  } 
  else {
    # Filter Primary samples for all genders
    MSS_primary <- clinical_final %>% 
      filter(sample_type3 == "Primary") %>% 
      filter(get(ttm_event) == 1) %>%
      dplyr::select(SAMPLE_ID) 
  }
  
  
  MSS_primary <- MSS_primary$SAMPLE_ID
  
  MSS_primary_GAM <- GAM_final[GAM_final$Samples %in% MSS_primary, ]
  
  # Filter Metastasis samples
  MSS_met <- clinical_final %>%
     filter(sample_type3 == "Metastasis") %>% 
     filter(metsite == site) %>% 
     dplyr::select(SAMPLE_ID)
  MSS_met <- MSS_met$SAMPLE_ID
  
  MSS_met_GAM <- GAM_final[GAM_final$Samples %in% MSS_met, ]
  
  # Calculate statistics for Primary samples
  MSS_primary_stats <- data.frame(t(MSS_primary_GAM))
  colnames(MSS_primary_stats) <- MSS_primary_stats["Samples",]
  MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
  MSS_primary_stats <- MSS_primary_stats %>% mutate_all(as.numeric)
  
  MSS_primary_stats <- MSS_primary_stats %>%
    mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE),
           MSS_pri_Alt = rowSums(across(!c(MSS_pri_WT)) == 1, na.rm = TRUE),
           MSS_pri_Alt_per = MSS_pri_Alt / (MSS_pri_WT + MSS_pri_Alt))
  
  MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
  
  # Calculate statistics for Metastasis samples
  MSS_met_stats <- data.frame(t(MSS_met_GAM))
  colnames(MSS_met_stats) <- MSS_met_stats["Samples",]
  MSS_met_stats <- MSS_met_stats[rownames(MSS_met_stats) != "Samples", ]
  MSS_met_stats <- MSS_met_stats %>% mutate_all(as.numeric)
  
  MSS_met_stats <- MSS_met_stats %>%
    mutate(MSS_mid_WT = rowSums(MSS_met_stats == 0, na.rm = TRUE),
           MSS_mid_Alt = rowSums(across(!c(MSS_mid_WT)) == 1, na.rm = TRUE),
           MSS_mid_Alt_per = MSS_mid_Alt / (MSS_mid_WT + MSS_mid_Alt))
  
  MSS_met_stats$MSS_mid_Alt_per[is.nan(MSS_met_stats$MSS_mid_Alt_per)] <- 0
  
  # Merge statistics for Primary and Metastasis samples
  combined_df <- merge(MSS_primary_stats, MSS_met_stats, by = "row.names", all = TRUE)
  combined_df <- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per)
  colnames(combined_df)[1] <- "Gene"
  rownames(combined_df) <- combined_df$Gene
  
  for (gene in row.names(MSS_primary_stats)) {
    # Perform Fisher's exact test
    contingency_table <- matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],
                                   MSS_met_stats[[gene, "MSS_mid_Alt"]], MSS_met_stats[[gene, "MSS_mid_WT"]]), 
                                nrow = 2, ncol = 2, byrow = TRUE)
    rownames(contingency_table) <- c("Primary", "Mid")
    colnames(contingency_table) <- c("Altered", "Unaltered")
    fisher_result <- fisher.test(contingency_table)
    p_value <- fisher_result$p.value
    combined_df[gene, "p_value"] <- p_value
  }
  
  # Remove genes with 0% alteration for both conditions
  combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per == 0 & combined_df$MSS_mid_Alt_per == 0))

#####
top_MSS_genes$Met <- combined_df[rownames(top_MSS_genes), "MSS_mid_Alt_per"]
top_MSS_genes$EM <- combined_df[rownames(top_MSS_genes), "MSS_pri_Alt_per"]
liver_heatmap_1 <- top_MSS_genes %>% select(-Gene) %>% mutate(across(Met:EM, ~ . * 100))
myplot<-pheatmap(t(liver_heatmap_1),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         display_numbers = TRUE,
         fontsize = 10,
         cellwidth = 25,  
  cellheight = 25,
  legend = FALSE,
         scale = "none")  
#####
# Append Metastatic site to the dataframe
results_basic[[site]] <- list(heatmap = myplot, df = combined_df)
combined_df$Metastatic_Site <- site
  
combined_df <- combined_df%>%filter(Gene %in% top_MSS_genes$Gene)


combined_df <- combined_df[order(combined_df$p_value), ]
#combined_df <- head(combined_df, 20) # top 20 most significant 
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values
  # Bind the results for this site to the overall results
all_results <- rbind(all_results, combined_df)
}

all_results$LogRatio <- log2(all_results$MSS_mid_Alt_per / all_results$MSS_pri_Alt_per)

ggplot(data = all_results, aes(x = LogRatio, y = -log(adjusted_p_value), color = Metastatic_Site, fill = Metastatic_Site)) +
          geom_point(size = 2, aes(fill = Metastatic_Site)) +
         scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
          geom_text_repel(data = subset(all_results, adjusted_p_value < 0.051), aes(label = Gene), size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
         labs(x = "Log2 Ratio", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
        theme_classic() +xlim(-4, 4)

```

all_EMvMet

rectum_EMvMet

left_EMvMet

right_EMvMet

Pathway

```{r}
all_results <- data.frame(Gene = character(0), MSS_pri_Alt_per = numeric(0), MSS_mid_Alt_per = numeric(0), Metastatic_Site = character(0), p_value = numeric(0), adjusted_p_value=numeric(0))
results_basic <- list()
# Define metastatic sites
metastatic_sites <- c("Liver", "Lung", "Brain", "Peritoneum", "Bone", "Ovary")
ttm_events <- c("liver_ttm_event", "lung_ttm_event", "brain_ttm_event", "perit_ttm_event", "bone_ttm_event", "repr_ttm_event")

for (i in seq_along(metastatic_sites)) {
  site <- metastatic_sites[i]
  ttm_event <- ttm_events[i]
  
  if (site == "Ovary") {
    # Filter Primary samples for females only
    MSS_primary <- clinical_final %>% #filter(sidedness_mpt =="Rectum")%>%
      filter(sample_type3 == "Primary") %>% 
      filter(get(ttm_event) == 1) %>%
      filter(SEX == "Female") %>%
      dplyr::select(SAMPLE_ID) 
  } 
  else {
    # Filter Primary samples for all genders
    MSS_primary <- clinical_final %>% 
      filter(sample_type3 == "Primary") %>% #filter(sidedness_mpt == "Rectum")%>%
      filter(get(ttm_event) == 1) %>%
      dplyr::select(SAMPLE_ID) 
  }
  
  
  MSS_primary <- MSS_primary$SAMPLE_ID
  
  MSS_primary_GAM <- pathway_GAM_final[pathway_GAM_final$Samples %in% MSS_primary, ]
  
  # Filter Metastasis samples
  MSS_met <- clinical_final %>% #filter(sidedness_mpt == "Rectum")%>%
     filter(sample_type3 == "Metastasis") %>% 
     filter(metsite == site) %>% 
     dplyr::select(SAMPLE_ID)
  MSS_met <- MSS_met$SAMPLE_ID
  
  MSS_met_GAM <- pathway_GAM_final[pathway_GAM_final$Samples %in% MSS_met, ]
  
  # Calculate statistics for Primary samples
  MSS_primary_stats <- data.frame(t(MSS_primary_GAM))
  colnames(MSS_primary_stats) <- MSS_primary_stats["Samples",]
  MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
  MSS_primary_stats <- MSS_primary_stats %>% mutate_all(as.numeric)
  
  MSS_primary_stats <- MSS_primary_stats %>%
    mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE),
           MSS_pri_Alt = rowSums(across(!c(MSS_pri_WT)) == 1, na.rm = TRUE),
           MSS_pri_Alt_per = MSS_pri_Alt / (MSS_pri_WT + MSS_pri_Alt))
  
  MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
  
  # Calculate statistics for Metastasis samples
  MSS_met_stats <- data.frame(t(MSS_met_GAM))
  colnames(MSS_met_stats) <- MSS_met_stats["Samples",]
  MSS_met_stats <- MSS_met_stats[rownames(MSS_met_stats) != "Samples", ]
  MSS_met_stats <- MSS_met_stats %>% mutate_all(as.numeric)
  
  MSS_met_stats <- MSS_met_stats %>%
    mutate(MSS_mid_WT = rowSums(MSS_met_stats == 0, na.rm = TRUE),
           MSS_mid_Alt = rowSums(across(!c(MSS_mid_WT)) == 1, na.rm = TRUE),
           MSS_mid_Alt_per = MSS_mid_Alt / (MSS_mid_WT + MSS_mid_Alt))
  
  MSS_met_stats$MSS_mid_Alt_per[is.nan(MSS_met_stats$MSS_mid_Alt_per)] <- 0
  
  # Merge statistics for Primary and Metastasis samples
  combined_df <- merge(MSS_primary_stats, MSS_met_stats, by = "row.names", all = TRUE)
  combined_df <- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per)
  colnames(combined_df)[1] <- "Gene"
  rownames(combined_df) <- combined_df$Gene
  
  for (gene in row.names(MSS_primary_stats)) {
    # Perform Fisher's exact test
    contingency_table <- matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],
                                   MSS_met_stats[[gene, "MSS_mid_Alt"]], MSS_met_stats[[gene, "MSS_mid_WT"]]), 
                                nrow = 2, ncol = 2, byrow = TRUE)
    rownames(contingency_table) <- c("Primary", "Mid")
    colnames(contingency_table) <- c("Altered", "Unaltered")
    fisher_result <- fisher.test(contingency_table)
    p_value <- fisher_result$p.value
    combined_df[gene, "p_value"] <- p_value
  }
  
  # Remove genes with 0% alteration for both conditions
  combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per == 0 & combined_df$MSS_mid_Alt_per == 0))

#####
top_MSS_pathway$Met <- combined_df[rownames(top_MSS_pathway), "MSS_mid_Alt_per"]
top_MSS_pathway$EM <- combined_df[rownames(top_MSS_pathway), "MSS_pri_Alt_per"]
liver_heatmap_1 <- top_MSS_pathway %>% select(-Gene) %>% mutate(across(Met:EM, ~ . * 100))
myplot<-pheatmap(t(liver_heatmap_1),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         display_numbers = TRUE,
         fontsize = 10,
         cellwidth = 25,  
  cellheight = 25,
  legend = FALSE,
         scale = "none")  
#####
# Append Metastatic site to the dataframe
results_basic[[site]] <- list(heatmap = myplot, df = combined_df)
combined_df$Metastatic_Site <- site
  


combined_df <- combined_df[order(combined_df$p_value), ]
#combined_df <- head(combined_df, 20) # top 20 most significant 
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values
  # Bind the results for this site to the overall results
all_results <- rbind(all_results, combined_df)
}

all_results$LogRatio <- log(all_results$MSS_mid_Alt_per / all_results$MSS_pri_Alt_per)

ggplot(data = all_results, aes(x = LogRatio, y = -log(adjusted_p_value), color = Metastatic_Site, fill = Metastatic_Site)) +
          geom_point(size = 2, aes(fill = Metastatic_Site)) +
         scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
          geom_text_repel(data = subset(all_results, adjusted_p_value < 0.051), aes(label = Gene), size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
         labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
        theme_classic() 

```

all_EMvMet_path

for left, none significant

for right, none

for rectum, only hippo for peritoneum 0.009 to 0.108, q=0.02, log2 = 2.4

```{r}
all_results <- data.frame(Gene = character(0), MSS_pri_Alt_per = numeric(0), MSS_mid_Alt_per = numeric(0), Metastatic_Site = character(0), p_value = numeric(0), adjusted_p_value=numeric(0))
results_basic <- list()
# Define metastatic sites
metastatic_sites <- c("Liver", "Lung", "Brain", "Peritoneum","Bone", "Reproductive")
ttm_events <- c("liver_ttm_event", "lung_ttm_event", "brain_ttm_event", "perit_ttm_event","bone_ttm_event", "repr_ttm_event")

for (i in seq_along(metastatic_sites)) {
  site <- metastatic_sites[i]
  ttm_event <- ttm_events[i]
  
 
    # Filter Primary samples for all genders
    MSS_primary <- clinical_final %>% 
      filter(sample_type3 == "Primary") %>% filter(sidedness_mpt == "Rectum")%>%
      filter(get(ttm_event) != 1) %>% filter(SAMPLE_ID %in% c(conc_met, later_met)) %>%
      dplyr::select(SAMPLE_ID) 
  
  
  
  MSS_primary <- MSS_primary$SAMPLE_ID
  
  MSS_primary_GAM <- GAM_final[GAM_final$Samples %in% MSS_primary, ]
  ##
  
    # Filter Primary samples for all genders
    MSS_met <- clinical_final %>% 
      filter(sample_type3 == "Primary") %>% filter(sidedness_mpt == "Rectum")%>%
      filter(get(ttm_event) == 1) %>% filter(SAMPLE_ID %in% c(conc_met, later_met))%>%
      dplyr::select(SAMPLE_ID) 
  
  ##
  
  MSS_met <- MSS_met$SAMPLE_ID
  
  MSS_met_GAM <- GAM_final[GAM_final$Samples %in% MSS_met, ]
  
  # Calculate statistics for Primary samples
  MSS_primary_stats <- data.frame(t(MSS_primary_GAM))
  colnames(MSS_primary_stats) <- MSS_primary_stats["Samples",]
  MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
  MSS_primary_stats <- MSS_primary_stats %>% mutate_all(as.numeric)
  
  MSS_primary_stats <- MSS_primary_stats %>%
    mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE),
           MSS_pri_Alt = rowSums(across(!c(MSS_pri_WT)) == 1, na.rm = TRUE),
           MSS_pri_Alt_per = MSS_pri_Alt / (MSS_pri_WT + MSS_pri_Alt))
  
  MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
  
  # Calculate statistics for Metastasis samples
  MSS_met_stats <- data.frame(t(MSS_met_GAM))
  colnames(MSS_met_stats) <- MSS_met_stats["Samples",]
  MSS_met_stats <- MSS_met_stats[rownames(MSS_met_stats) != "Samples", ]
  MSS_met_stats <- MSS_met_stats %>% mutate_all(as.numeric)
  
  MSS_met_stats <- MSS_met_stats %>%
    mutate(MSS_mid_WT = rowSums(MSS_met_stats == 0, na.rm = TRUE),
           MSS_mid_Alt = rowSums(across(!c(MSS_mid_WT)) == 1, na.rm = TRUE),
           MSS_mid_Alt_per = MSS_mid_Alt / (MSS_mid_WT + MSS_mid_Alt))
  
  MSS_met_stats$MSS_mid_Alt_per[is.nan(MSS_met_stats$MSS_mid_Alt_per)] <- 0
  
  # Merge statistics for Primary and Metastasis samples
  combined_df <- merge(MSS_primary_stats, MSS_met_stats, by = "row.names", all = TRUE)
  combined_df <- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per)
  colnames(combined_df)[1] <- "Gene"
  rownames(combined_df) <- combined_df$Gene
  
  for (gene in row.names(MSS_primary_stats)) {
    # Perform Fisher's exact test
    contingency_table <- matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],
                                   MSS_met_stats[[gene, "MSS_mid_Alt"]], MSS_met_stats[[gene, "MSS_mid_WT"]]), 
                                nrow = 2, ncol = 2, byrow = TRUE)
    rownames(contingency_table) <- c("Primary", "Mid")
    colnames(contingency_table) <- c("Altered", "Unaltered")
    fisher_result <- fisher.test(contingency_table)
    p_value <- fisher_result$p.value
    combined_df[gene, "p_value"] <- p_value
  }
  
  # Remove genes with 0% alteration for both conditions
  combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per == 0 & combined_df$MSS_mid_Alt_per == 0))

#####
top_MSS_genes$Met <- combined_df[rownames(top_MSS_genes), "MSS_mid_Alt_per"]
top_MSS_genes$EM <- combined_df[rownames(top_MSS_genes), "MSS_pri_Alt_per"]
liver_heatmap_1 <- top_MSS_genes %>% select(-Gene) %>% mutate(across(Met:EM, ~ . * 100))
myplot<-pheatmap(t(liver_heatmap_1),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         display_numbers = TRUE,
         fontsize = 10,
         cellwidth = 25,  
  cellheight = 25,
  legend = FALSE,
         scale = "none")  
#####
# Append Metastatic site to the dataframe
results_basic[[site]] <- list(heatmap = myplot, df = combined_df)
combined_df$Metastatic_Site <- site
  
combined_df <- combined_df%>%filter(Gene %in% top_MSS_genes$Gene)


combined_df <- combined_df[order(combined_df$p_value), ]
#combined_df <- head(combined_df, 20) # top 20 most significant 
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values
  # Bind the results for this site to the overall results
all_results <- rbind(all_results, combined_df)
}

all_results$LogRatio <- log2(all_results$MSS_mid_Alt_per / all_results$MSS_pri_Alt_per)

ggplot(data = all_results, aes(x = LogRatio, y = -log(adjusted_p_value), color = Metastatic_Site, fill = Metastatic_Site)) +
          geom_point(size = 2, aes(fill = Metastatic_Site)) +
         scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
          geom_text_repel(data = subset(all_results, adjusted_p_value < 0.051), aes(label = Gene), size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
         labs(x = "Log2 Ratio", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
        theme_classic() +xlim(-4, 4)
```

ALL gene pri %. mid%. pval

|             |        |            |            |              |              |              |              |
|-------------|--------|------------|------------|--------------|--------------|--------------|--------------|
|             |        |            |            |              |              |              |              |
| **APC**     | APC    | 0.67230169 | 0.79325121 | 1.260034e-10 | Liver        | 2.520068e-09 | 0.238669031  |
| **APC3**    | APC    | 0.79794521 | 0.70833333 | 1.069814e-07 | Peritoneum   | 1.175959e-06 | -0.171861245 |
| **SMAD43**  | SMAD4  | 0.13013699 | 0.20748299 | 1.175959e-07 | Peritoneum   | 1.175959e-06 | 0.672962038  |
| **KRAS1**   | KRAS   | 0.40175953 | 0.50340980 | 3.530749e-07 | Lung         | 7.061497e-06 | 0.325401040  |
| **BRAF3**   | BRAF   | 0.06164384 | 0.10544218 | 5.424319e-05 | Peritoneum   | 3.616213e-04 | 0.774423523  |
| **APC5**    | APC    | 0.77771994 | 0.70489510 | 1.502451e-04 | Reproductive | 3.004903e-03 | -0.141842137 |
| **SMAD45**  | SMAD4  | 0.15044248 | 0.20279720 | 1.713560e-03 | Reproductive | 1.713560e-02 | 0.430825780  |
| **SRC3**    | SRC    | 0.04109589 | 0.02040816 | 2.513713e-03 | Peritoneum   | 1.256856e-02 | -1.009847786 |
| **DNMT3B3** | DNMT3B | 0.04383562 | 0.02380952 | 5.391492e-03 | Peritoneum   | 1.972915e-02 | -0.880564769 |
| **TCF7L23** | TCF7L2 | 0.08637640 | 0.05726872 | 5.918745e-03 | Peritoneum   | 1.972915e-02 | -0.592889844 |
| **PIK3CA5** | PIK3CA | 0.17126497 | 0.12867133 | 8.437266e-03 | Reproductive | 5.624844e-02 |              |

|       |     |     |     |     |     |     |     |
|------:|-----|-----|-----|-----|-----|-----|-----|
| Left: |     |     |     |     |     |     |     |
|       |     |     |     |     |     |     |     |
|       |     |     |     |     |     |     |     |
|       |     |     |     |     |     |     |     |
|       |     |     |     |     |     |     |     |
|       |     |     |     |     |     |     |     |
|       |     |     |     |     |     |     |     |
|       |     |     |     |     |     |     |     |
|       |     |     |     |     |     |     |     |

|         |     |            |             |             |       |            |             |
|--------:|-----|------------|-------------|-------------|-------|------------|-------------|
| **APC** | APC | 0.71120690 | 0.810413885 | 0.001757918 | Liver | 0.03515837 | 0.188389579 |

Left:

|          |     |            |            |             |              |            |               |
|---------:|-----|------------|------------|-------------|--------------|------------|---------------|
|  **APC** | APC | 0.71120690 | 0.81041389 | 0.001757918 | Liver        | 0.03515837 | 0.1883895787  |
| **APC5** | APC | 0.80997305 | 0.71548117 | 0.002649683 | Reproductive | 0.05299366 | -0.1789600972 |
| **APC3** | APC | 0.82653061 | 0.74745418 | 0.002992632 | Peritoneum   | 0.05985264 | -0.1450831202 |

Right

|             |        |             |             |              |            |              |               |
|------------:|--------|-------------|-------------|--------------|------------|--------------|---------------|
|     **APC** | APC    | 0.534161491 | 0.765784114 | 5.026215e-08 | Liver      | 1.005243e-06 | 0.5196617608  |
|    **APC3** | APC    | 0.807560137 | 0.628808864 | 6.695781e-07 | Peritoneum | 1.339156e-05 | -0.3609481433 |
|  **SMAD43** | SMAD4  | 0.134020619 | 0.240997230 | 6.585618e-04 | Peritoneum | 6.585618e-03 | 0.8465615930  |
| **DNMT3B3** | DNMT3B | 0.034364261 | 0.005540166 | 7.662305e-03 | Peritoneum | 3.831152e-02 | -2.6329077789 |
|    **SRC3** | SRC    | 0.034364261 | 0.005540166 | 7.662305e-03 | Peritoneum | 3.831152e-02 | -2.6329077789 |

Rectum

|            |       |            |             |              |       |              |             |
|-----------:|-------|------------|-------------|--------------|-------|--------------|-------------|
|  **KRAS1** | KRAS  | 0.32960894 | 0.513687601 | 2.712775e-08 | Lung  | 5.425550e-07 | 0.640135883 |
| **AMER11** | AMER1 | 0.01675978 | 0.053140097 | 5.863283e-03 | Lung  | 5.863283e-02 | 1.664797938 |
|    **APC** | APC   | 0.72131148 | 0.797716150 | 7.606226e-03 | Liver | 1.521245e-01 | 0.145253110 |

```{r}
all_results <- data.frame(Gene = character(0), MSS_pri_Alt_per = numeric(0), MSS_mid_Alt_per = numeric(0), Metastatic_Site = character(0), p_value = numeric(0), adjusted_p_value=numeric(0))
results_basic <- list()
# Define metastatic sites
metastatic_sites <- c("Liver", "Lung", "Brain", "Peritoneum","Bone", "Reproductive")
ttm_events <- c("liver_ttm_event", "lung_ttm_event", "brain_ttm_event", "perit_ttm_event","bone_ttm_event", "repr_ttm_event")

for (i in seq_along(metastatic_sites)) {
  site <- metastatic_sites[i]
  ttm_event <- ttm_events[i]
  
 
    # Filter Primary samples for all genders
    MSS_primary <- clinical_final %>% 
      filter(sample_type3 == "Primary") %>% filter(stage2 == "Stage 1-3") %>% filter(any_ttm_event==TRUE)%>%filter(sidedness_mpt == "Right")%>%
    filter(get(ttm_event) != 1) %>% #filter(SAMPLE_ID %in% c(conc_met, later_met)) %>%
      dplyr::select(SAMPLE_ID) 
  
  
  
  MSS_primary <- MSS_primary$SAMPLE_ID
  
  MSS_primary_GAM <- pathway_GAM_final[pathway_GAM_final$Samples %in% MSS_primary, ]
  ##
  
    # Filter Primary samples for all genders
    MSS_met <- clinical_final %>% 
      filter(sample_type3 == "Primary") %>% filter(sidedness_mpt == "Right")%>%
      filter(get(ttm_event) == 1) %>%filter(stage2 == "Stage 1-3") %>%#filter(SAMPLE_ID %in% c(conc_met, later_met))%>%
      dplyr::select(SAMPLE_ID) 
  
  ##
  
  MSS_met <- MSS_met$SAMPLE_ID
  
  MSS_met_GAM <- pathway_GAM_final[pathway_GAM_final$Samples %in% MSS_met, ]
  
  # Calculate statistics for Primary samples
  MSS_primary_stats <- data.frame(t(MSS_primary_GAM))
  colnames(MSS_primary_stats) <- MSS_primary_stats["Samples",]
  MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
  MSS_primary_stats <- MSS_primary_stats %>% mutate_all(as.numeric)
  
  MSS_primary_stats <- MSS_primary_stats %>%
    mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE),
           MSS_pri_Alt = rowSums(across(!c(MSS_pri_WT)) == 1, na.rm = TRUE),
           MSS_pri_Alt_per = MSS_pri_Alt / (MSS_pri_WT + MSS_pri_Alt))
  
  MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
  
  # Calculate statistics for Metastasis samples
  MSS_met_stats <- data.frame(t(MSS_met_GAM))
  colnames(MSS_met_stats) <- MSS_met_stats["Samples",]
  MSS_met_stats <- MSS_met_stats[rownames(MSS_met_stats) != "Samples", ]
  MSS_met_stats <- MSS_met_stats %>% mutate_all(as.numeric)
  
  MSS_met_stats <- MSS_met_stats %>%
    mutate(MSS_mid_WT = rowSums(MSS_met_stats == 0, na.rm = TRUE),
           MSS_mid_Alt = rowSums(across(!c(MSS_mid_WT)) == 1, na.rm = TRUE),
           MSS_mid_Alt_per = MSS_mid_Alt / (MSS_mid_WT + MSS_mid_Alt))
  
  MSS_met_stats$MSS_mid_Alt_per[is.nan(MSS_met_stats$MSS_mid_Alt_per)] <- 0
  
  # Merge statistics for Primary and Metastasis samples
  combined_df <- merge(MSS_primary_stats, MSS_met_stats, by = "row.names", all = TRUE)
  combined_df <- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per)
  colnames(combined_df)[1] <- "Gene"
  rownames(combined_df) <- combined_df$Gene
  
  for (gene in row.names(MSS_primary_stats)) {
    # Perform Fisher's exact test
    contingency_table <- matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],
                                   MSS_met_stats[[gene, "MSS_mid_Alt"]], MSS_met_stats[[gene, "MSS_mid_WT"]]), 
                                nrow = 2, ncol = 2, byrow = TRUE)
    rownames(contingency_table) <- c("Primary", "Mid")
    colnames(contingency_table) <- c("Altered", "Unaltered")
    fisher_result <- fisher.test(contingency_table)
    p_value <- fisher_result$p.value
    combined_df[gene, "p_value"] <- p_value
  }
  
  # Remove genes with 0% alteration for both conditions
  combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per == 0 & combined_df$MSS_mid_Alt_per == 0))

#####
top_MSS_pathway$Met <- combined_df[rownames(top_MSS_pathway), "MSS_mid_Alt_per"]
top_MSS_pathway$EM <- combined_df[rownames(top_MSS_pathway), "MSS_pri_Alt_per"]
liver_heatmap_1 <- top_MSS_pathway %>% select(-Gene) %>% mutate(across(Met:EM, ~ . * 100))
myplot<-pheatmap(t(liver_heatmap_1),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         display_numbers = TRUE,
         fontsize = 10,
         cellwidth = 25,  
  cellheight = 25,
  legend = FALSE,
         scale = "none")  
#####
# Append Metastatic site to the dataframe
results_basic[[site]] <- list(heatmap = myplot, df = combined_df)
combined_df$Metastatic_Site <- site
  
combined_df <- combined_df%>%filter(Gene %in% top_MSS_pathway$Gene)


combined_df <- combined_df[order(combined_df$p_value), ]
#combined_df <- head(combined_df, 20) # top 20 most significant 
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values
  # Bind the results for this site to the overall results
all_results <- rbind(all_results, combined_df)
}

all_results$LogRatio <- log2(all_results$MSS_mid_Alt_per / all_results$MSS_pri_Alt_per)

ggplot(data = all_results, aes(x = LogRatio, y = -log(adjusted_p_value), color = Metastatic_Site, fill = Metastatic_Site)) +
          geom_point(size = 2, aes(fill = Metastatic_Site)) +
         scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
          geom_text_repel(data = subset(all_results, adjusted_p_value < 0.051), aes(label = Gene), size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
         labs(x = "Log2 Ratio", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
        theme_classic() +xlim(-4, 4)
```

ALL:

|              |         |              |             |              |              |              |              |
|-------------:|---------|--------------|-------------|--------------|--------------|--------------|--------------|
|    **TGFB3** | TGFB    | 0.1910958904 | 0.284013605 | 2.437482e-08 | Peritoneum   | 2.437482e-07 | 0.571663290  |
|      **WNT** | WNT     | 0.7334200260 | 0.826459561 | 1.085124e-07 | Liver        | 1.085124e-06 | 0.172304570  |
| **RTK_RAS1** | RTK_RAS | 0.6138807429 | 0.714197148 | 1.157902e-07 | Lung         | 1.157902e-06 | 0.218363959  |
|     **WNT5** | WNT     | 0.8198854763 | 0.744055944 | 2.427802e-05 | Reproductive | 2.427802e-04 | -0.140011306 |
|     **WNT3** | WNT     | 0.8287671233 | 0.762755102 | 3.120695e-05 | Peritoneum   | 1.560347e-04 | -0.119746848 |
| **RTK_RAS3** | RTK_RAS | 0.6486301370 | 0.708333333 | 1.268772e-03 | Peritoneum   | 4.229239e-03 | 0.127032379  |
|    **TGFB5** | TGFB    | 0.2165538782 | 0.275524476 | 1.842497e-03 | Reproductive | 9.212487e-03 | 0.347454473  |
|     **TP53** | TP53    | 0.7698309493 | 0.813069095 | 1.359657e-02 | Liver        | 6.798285e-02 | 0.078836286  |

Left:

|              |         |             |             |             |              |            |              |
|-------------:|---------|-------------|-------------|-------------|--------------|------------|--------------|
|     **WNT5** | WNT     | 0.836927224 | 0.744769874 | 0.002118267 | Reproductive | 0.02118267 | -0.168307459 |
|     **WNT3** | WNT     | 0.853061224 | 0.775967413 | 0.002315796 | Peritoneum   | 0.01261280 | -0.136653220 |
|    **TGFB3** | TGFB    | 0.177551020 | 0.258655804 | 0.002522559 | Peritoneum   | 0.01261280 | 0.542799916  |
|      **WNT** | WNT     | 0.750000000 | 0.834445928 | 0.004980121 | Liver        | 0.04980121 | 0.153927970  |
| **RTK_RAS5** | RTK_RAS | 0.579514825 | 0.677824268 | 0.007727702 | Reproductive | 0.03863851 | 0.226065722  |
|   **NOTCH3** | NOTCH   | 0.148979592 | 0.097759674 | 0.015314296 | Peritoneum   | 0.05104765 | -0.607803333 |

Right:

|              |         |             |             |              |              |              |              |
|-------------:|---------|-------------|-------------|--------------|--------------|--------------|--------------|
|     **WNT3** | WNT     | 0.862542955 | 0.731301939 | 4.440412e-05 | Peritoneum   | 0.0004440412 | -0.238129119 |
|      **WNT** | WNT     | 0.683229814 | 0.824847251 | 2.178536e-04 | Liver        | 0.0021785361 | 0.271756048  |
|    **TGFB3** | TGFB    | 0.230240550 | 0.335180055 | 4.044924e-03 | Peritoneum   | 0.0202246210 | 0.541794363  |
| **RTK_RAS1** | RTK_RAS | 0.783582090 | 0.869791667 | 5.199112e-03 | Lung         | 0.0519911221 | 0.150585465  |
|     **WNT5** | WNT     | 0.808823529 | 0.694444444 | 9.711575e-03 | Reproductive | 0.0971157460 | -0.219965684 |
|     **WNT1** | WNT     | 0.746268657 | 0.820312500 | 2.473904e-02 | Lung         | 0.1236952185 | 0.136478518  |
|     **MYC3** | MYC     | 0.041237113 | 0.083102493 | 3.637706e-02 | Peritoneum   | 0.1212568585 | 1.010948411  |

Rectum:

|              |         |            |             |              |              |              |              |
|-------------:|---------|------------|-------------|--------------|--------------|--------------|--------------|
| **RTK_RAS1** | RTK_RAS | 0.53631285 | 0.695652174 | 8.830007e-07 | Lung         | 7.947006e-06 | 0.375291320  |
|    **TGFB4** | TGFB    | 0.18181818 | 0.269480519 | 2.276819e-03 | Bone         | 2.049137e-02 | 0.567684509  |
|     **WNT2** | WNT     | 0.80853518 | 0.678571429 | 2.662670e-03 | Brain        | 2.396403e-02 | -0.252809859 |
|    **TGFB3** | TGFB    | 0.18397626 | 0.265573770 | 5.026575e-03 | Peritoneum   | 4.523918e-02 | 0.529593041  |
|   **hippo2** | hippo   | 0.01614764 | 0.062500000 | 6.322354e-03 | Brain        | 2.845059e-02 | 1.952533261  |
|    **TGFB5** | TGFB    | 0.18344156 | 0.253443526 | 1.158725e-02 | Reproductive | 8.033784e-02 | 0.466343796  |
|    **TP535** | TP53    | 0.85064935 | 0.790633609 | 1.785285e-02 | Reproductive | 8.033784e-02 | -0.105555272 |

```{r}
my_data_frame_final <- clinical_final %>% select(PATIENT_ID, SAMPLE_ID,sample_type3, sidedness_mpt, tmb2, fga, facets_fga, bone_ttm_event, repr_ttm_event, liver_ttm_event, lung_ttm_event, perit_ttm_event, pleura_ttm_event, adren_ttm_event, brain_ttm_event, best_unique_samp, best_unique_prim, os, os_event, os_evaluable, stage2, any_ttm_event )

metastatic_site_columns <- c("bone_ttm_event", "repr_ttm_event", "liver_ttm_event", "lung_ttm_event", "perit_ttm_event", "pleura_ttm_event", "adren_ttm_event", "brain_ttm_event")
my_data_frame_final <- my_data_frame_final %>%
  mutate(total = rowSums(select(., metastatic_site_columns)))
#duplicates



# Create an empty list to store the results
proportions_list <- list()

# Loop through the columns
for (site_column in metastatic_site_columns) {
  # Subset the data frame for the current metastatic site
  subset_data <- subset(my_data_frame_final, get(site_column) == 1)
  
  # Calculate proportions
  proportions_data <- subset_data %>%
    group_by(totals_group = ifelse(total >= 3, "Greater than 3", as.character(total))) %>%
    summarize(Proportion = n() / nrow(subset_data)) %>%
    mutate(organ = site_column)
  
  # Store the result in the list
  proportions_list[[site_column]] <- proportions_data
}

# Combine the results into one data frame
proportions_combined <- bind_rows(proportions_list)

# Print or view the combined data frame
#print(proportions_combined)

bar_chart <- ggplot(data = proportions_combined, aes(x = organ, y = Proportion, fill = totals_group)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Site") +
  ylab("Patients (%)") +
  ggtitle("Metastatic Burden by Sites") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
bar_chart
```

```{r}
never_met_df<-clinical_final%>%filter(sample_type3 == "Primary")%>% filter(any_ttm_event ==0)%>% filter(any_ttm >=24) %>% filter(stage2 == "Stage 1-3")%>%dplyr::select(SAMPLE_ID, tmb2, fga, facets_fga, purity, facets_purity, sidedness_mpt, metsite, sample_type3, os, os_event, os_evaluable) %>% filter(tmb2 <30) # get sample names 
never_met_df$TUMOR_MET_CLASSIFICATION <- "Never Met"

later_met_df <- clinical_final %>% filter(any_ttm_event == 1) %>% filter(any_ttm >6) %>% filter(sample_type3 == "Primary") %>% filter(stage2 == "Stage 1-3")%>%dplyr::select(SAMPLE_ID, tmb2, fga, facets_fga, purity, facets_purity, sidedness_mpt, metsite, sample_type3, os, os_event, os_evaluable)
later_met_df$TUMOR_MET_CLASSIFICATION <- "Later Met"
conc_met_df <- clinical_final %>% filter(any_ttm_event == 1) %>% filter(any_ttm <=6) %>% filter(sample_type3 == "Primary") %>% filter(stage2 == "Stage 4")%>%dplyr::select(SAMPLE_ID, tmb2, fga, facets_fga, purity, facets_purity, sidedness_mpt, metsite, sample_type3, os, os_event, os_evaluable) %>% filter(tmb2 <30)
conc_met_df$TUMOR_MET_CLASSIFICATION <- "Current Met"
MSS_primary_met<-clinical_final%>%filter(sample_type3 == "Metastasis") %>% filter(metsite %in% c("Adrenal gland", "Bone", "Brain", "Liver", "Lung", "Ovary", "Peritoneum"))%>%dplyr::select(SAMPLE_ID, tmb2, fga, facets_fga, purity, facets_purity, sidedness_mpt, metsite, sample_type3, os, os_event, os_evaluable)
MSS_primary_met$TUMOR_MET_CLASSIFICATION <- "Metastasis"
clinical_polished <- rbind(never_met_df, later_met_df, conc_met_df, MSS_primary_met)
#clinical_polished$TUMOR_MET_CLASSIFICATION <- factor(clinical_polished$TUMOR_MET_CLASSIFICATION, levels = c("Never Met","Later Met","Current Met" ,"Metastasis"))
```

```{r}
df<-clinical_polished
df$TUMOR_MET_CLASSIFICATION <- ifelse(df$TUMOR_MET_CLASSIFICATION %in% c("Later Met", "Current Met"), "Ever Met", df$TUMOR_MET_CLASSIFICATION)
df$TUMOR_MET_CLASSIFICATION <- factor(df$TUMOR_MET_CLASSIFICATION, levels = c("Never Met","Ever Met" ,"Metastasis"))

p1<-ggplot(df, aes(x = TUMOR_MET_CLASSIFICATION, y = tmb2, fill = TUMOR_MET_CLASSIFICATION)) +
 geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
  labs( x=NULL,y = "TMB") +  # Specify colors for each category
  theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+ylim(0, 30)+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))

df_left <- df%>%filter(sidedness_mpt == "Left")
p2<-ggplot(df_left, aes(x = TUMOR_MET_CLASSIFICATION, y = tmb2, fill = TUMOR_MET_CLASSIFICATION)) +
 geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
  labs(x=NULL,y = NULL) +  # Specify colors for each category
  theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+ylim(0, 30)+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))

df_rectum <- df%>%filter(sidedness_mpt == "Rectum")
p3<-ggplot(df_rectum, aes(x = TUMOR_MET_CLASSIFICATION, y = tmb2, fill = TUMOR_MET_CLASSIFICATION)) +
 geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
  labs( x=NULL,y = NULL) +  # Specify colors for each category
  theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+ylim(0, 30)+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))

df_right <- df%>%filter(sidedness_mpt == "Right")
p4<-ggplot(df_right, aes(x = TUMOR_MET_CLASSIFICATION, y = tmb2, fill = TUMOR_MET_CLASSIFICATION)) +
 geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
  labs(x=NULL,y = NULL) +  # Specify colors for each category
  theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+ylim(0, 30)+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))



p5<-ggplot(df, aes(x = TUMOR_MET_CLASSIFICATION, y = facets_fga, fill = TUMOR_MET_CLASSIFICATION)) +
 geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
  labs(x=NULL,y = "FACETS FGA") +  # Specify colors for each category
  theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+ylim(0, 1)+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))

p6<-ggplot(df_left, aes(x = TUMOR_MET_CLASSIFICATION, y = facets_fga, fill = TUMOR_MET_CLASSIFICATION)) +
 geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
  labs( x=NULL,y = NULL) +  # Specify colors for each category
  theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+ylim(0, 1)+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))

p7<-ggplot(df_rectum, aes(x = TUMOR_MET_CLASSIFICATION, y = facets_fga, fill = TUMOR_MET_CLASSIFICATION)) +
 geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
  labs(x=NULL, y = NULL) +  # Specify colors for each category
  theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+ylim(0, 1)+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))

p8<-ggplot(df_right, aes(x = TUMOR_MET_CLASSIFICATION, y = facets_fga, fill = TUMOR_MET_CLASSIFICATION)) +
 geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
  labs(x=NULL, y = NULL) +  # Specify colors for each category
  theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet() +ylim(0, 1)+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))


```

only Ever_met v Met in Left TMB has significant(0.00366) 5.62 vs 6.02. No rectum or Right

\<fct\> \<dbl\>\

Never Met 5.69\
Ever Met 5.62

Metastasis 6.02

tmb : In ALL: 0.006 (6.07 vs 6.33) (two sided wilcox test)

FGA:

in all, Met has significantly higher facets_fga p\<0.000001 to both never and ever

Never Met 0.525 2 Ever Met 0.529 3 Metastasis 0.617

same for LEFT:

Never Met 0.557 2 Ever Met 0.548 3 Metastasis 0.625

same of Right

Never Met 0.458 2 Ever Met 0.485 3 Metastasis 0.579

sma efor Rectum:\
Never Met 0.525 2 Ever Met 0.537 3 Metastasis 0.639

trend most pronounced for rectum.

For facets purity, primary samples have lower purity compared to metastasis .

1Never Met 0.473 2 Ever Met 0.441 3 Metastasis 0.516

Never met v Met: p-value = 2.995e-05

Ever met v Met: p-value \< 2.2e-16

anova_result \<- aov(tmb2 \~ TUMOR_MET_CLASSIFICATION, data = df_rectum) summary(anova_result)

posthoc_result \<- TukeyHSD(anova_result) print(posthoc_result)

wilcox.test(tmb2 \~ TUMOR_MET_CLASSIFICATION, data = filter(df_left, TUMOR_MET_CLASSIFICATION %in% c("Ever Met", "Metastasis")), alternative = "two.sided")

avg_tmb \<- df %\>% + group_by(TUMOR_MET_CLASSIFICATION) %\>% + summarise(avg_tmb2 = mean(tmb2, na.rm = TRUE)) \> \> \# Print average TMB values \> print(avg_tmb)

```{r warning=FALSE}
df1<- df %>% filter(metsite %in% c("Liver", "Lung", "Brain", "Ovary", "Peritoneum", "Bone"))
p9<-ggplot(df1, aes(x = metsite, y = facets_fga, fill = metsite)) +
     geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
     labs(x = NULL, y = "FACETS FGA") +  # Specify colors for each category
     theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))
p10<-ggplot(df1, aes(x = metsite, y = tmb2, fill = metsite)) +
     geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
     labs(x = NULL, y = "TMB") +  # Specify colors for each category
     theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))
p11<-ggplot(df1, aes(x = metsite, y = facets_purity, fill = metsite)) +
     geom_violin(width=0.5) +  geom_boxplot(width=0.3)+
     labs(x = NULL, y = "FACETS Purity") +  # Specify colors for each category
     theme_pubr(base_size = 8) + scale_color_lancet() + scale_fill_lancet()+theme(legend.position = "none")+ theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1))

grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11, ncol = 4)

```

```{r}
length(clinical_final$SAMPLE_ID)

table(clinical_final$stage2_det)
table(clinical_final$sidedness_mpt)
mean(clinical_final$age_at_seq,na.rm = TRUE)
table(clinical_final$SEX)
table(clinical_final$sample_type3, clinical_final$sidedness_mpt)

mean(clinical_final$age_at_seq[clinical_final$sidedness_mpt == "Left"], na.rm = TRUE)

mean(clinical_final$age_at_seq[clinical_final$sidedness_mpt == "Right"], na.rm = TRUE)

mean(clinical_final$age_at_seq[clinical_final$sidedness_mpt == "Rectum"], na.rm = TRUE)

```

```{r warning=FALSE}
merged_data_final <- my_data_frame_final %>% select(-facets_fga) %>% filter(best_unique_samp == TRUE) %>% filter(sample_type3 == "Primary")
#merged_data_final<- na.omit(merged_data_final)

proportions_list <- list()

# Loop through the columns
for (site_column in metastatic_site_columns) {
  # Subset the data frame for the current metastatic site
  subset_data <- subset(merged_data_final, get(site_column) == 1)
  
  # Calculate proportions
  proportions_data <- subset_data %>%
    group_by(sidedness_mpt) %>%
    summarize(Proportion = n() / nrow(subset_data)) %>%
    mutate(organ = site_column)
  
  # Store the result in the list
  proportions_list[[site_column]] <- proportions_data
}

# Combine the results into one data frame
proportions_combined <- bind_rows(proportions_list)

# Print or view the combined data frame
print(proportions_combined)

bar_chart <- ggplot(data = proportions_combined, aes(x = organ, y = Proportion, fill = sidedness_mpt)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Site") +
  ylab("Patients (%)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
bar_chart

violin_plot <- ggplot(data = merged_data_final, aes(x = sidedness_mpt, y = total, fill = sidedness_mpt)) +
  geom_violin(color = "black", alpha = 0.7) +
  geom_boxplot(width = 0.2, color = "black", fill = "white", outlier.shape = NA, alpha = 0.2) +
  xlab("Primary Tumor Location") +
  ylab("Metastatic Burden") 
violin_plot
```

```{r}
data <- my_data_frame_final %>% select(sidedness_mpt, bone_ttm_event, repr_ttm_event, liver_ttm_event, lung_ttm_event, perit_ttm_event, pleura_ttm_event, adren_ttm_event, brain_ttm_event, best_unique_samp)
data <- na.omit(data)
# Reshape data from wide to long format
data_long <- pivot_longer(data, cols = c(bone_ttm_event, repr_ttm_event, liver_ttm_event, lung_ttm_event, perit_ttm_event, pleura_ttm_event, adren_ttm_event, brain_ttm_event), names_to = "Organ", values_to = "Metastasized")

# Calculate the total number of occurrences for each side-organ combination
data_percent <- data_long %>%
  group_by(sidedness_mpt, Organ) %>%
  summarise(Count = sum(Metastasized)) %>%
  ungroup()

# Calculate the percentage of occurrences for each side-organ combination
data_percent <- data_percent %>%
  group_by(sidedness_mpt) %>%
  mutate(Percent = (Count / sum(Count)) * 100) %>%
  ungroup()

ggplot(data_percent, aes(fill=Organ, y=Percent, x=sidedness_mpt)) + 
  geom_bar(position='stack', stat='identity')
```

```{r}


data <- data %>% filter(best_unique_samp == TRUE) %>%
  group_by(sidedness_mpt) %>% 
  summarise(
    mean_liver = mean(liver_ttm_event),
    mean_lung = mean(lung_ttm_event),
    mean_brain = mean(brain_ttm_event),
    mean_bone = mean(bone_ttm_event),
    mean_repr = mean(repr_ttm_event),
    mean_perit = mean(perit_ttm_event),
    mean_adrn = mean(adren_ttm_event),
    mean_pler = mean(pleura_ttm_event)




  )

data_long <- pivot_longer(data, 
                                 cols = starts_with("mean"), 
                                 names_to = "Organ", 
                                 values_to = "Mean")

# Create the bar plot
ggplot(data_long, aes(x = Organ, y = Mean, fill = Organ)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ sidedness_mpt, scales = "fixed") +
  labs(title = "Mean Metastasis by Organ and sidedness_mpt",
       x = "Organ",
       y = "Mean Metastasis") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
burden_1<- my_data_frame_final %>% filter(total == 1) %>% select(PATIENT_ID, fga, sample_type3, facets_fga, tmb2) %>% mutate(Burden = "1")
burden_2<- my_data_frame_final %>% filter(total == 2) %>% select(PATIENT_ID, fga, sample_type3, facets_fga, tmb2) %>% mutate(Burden = "2")
burden_3 <- my_data_frame_final %>% filter(total == 3) %>% select(PATIENT_ID, fga, sample_type3, facets_fga, tmb2) %>% mutate(Burden = "3")
burden_many<- my_data_frame_final %>% filter(total > 3) %>% select(PATIENT_ID, fga, sample_type3, facets_fga, tmb2) %>% mutate(Burden = "4+")
combined_burden <- bind_rows(burden_1, burden_2, burden_3, burden_many)
combined_burden <- combined_burden %>% filter(sample_type3 == "Metastasis") ######
#df1 <- df1 %>% select(PATIENT_ID, facets_fga, fga) 
#combined_burden <- na.omit(combined_burden)

combined_burden <- subset(combined_burden, !is.na(fga)) #####
#combined_burden$fga <- as.numeric(combined_burden$fga)

# Create a violin plot with different colors for each organ
violin_plot <- ggplot(data = combined_burden, aes(x = Burden, y = fga, fill = Burden)) +
  geom_violin(color = "black", alpha = 0.7) +
  geom_boxplot(width = 0.2, color = "black", fill = "white", outlier.shape = NA, alpha = 0.2) +
  xlab("Burden") +
  ylab(" FGA") +
  ggtitle("Violin Plot of Met  FGA")
violin_plot
anova_result <- aov(fga ~ Burden, data = combined_burden)
summary(anova_result)

# Perform post-hoc tests (Tukey's HSD)
posthoc_result <- TukeyHSD(anova_result)
print(posthoc_result)
```

# Time to Met Analysis

\> table(left_trunc1\$facets_wgd)

\> table(left_trunc1\$os_eval)

## Univariate without left truncation

```{r}

left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event==0 | any_ttm>6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID ,any_ttm,  from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, brain_ttm, brain_ttm_event )

GAM_ttm <- GAM_final %>% filter(Samples %in% left_trunc$SAMPLE_ID)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]


colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")


#temp.obj <- Surv(left_trunc$any_ttm, left_trunc$from_sequencing_to_ttm_interval_months, left_trunc$any_ttm_event)
#Warning message:
#In Surv(left_trunc$any_ttm, left_trunc$from_sequencing_to_ttm_interval_months,  :
  #Stop time must be > start time, NA created
#temp.obj <- Surv(left_trunc$from_sequencing_to_ttm_interval_months,left_trunc$any_ttm,  left_trunc$any_ttm_event) #####

covariates <- c("MUTYH", "APC", "ATM", "TP53", "PIK3CA", "FBXW7", "AMER1", "SMAD4", "KRAS",   "ERBB2", "NRAS", "SOX9", "CCND2", "PTEN", "ARID1A", "TCF7L2", "DNMT3B", "GNAS", "IRS2", "BRAF",   "SMAD3", "SMAD2", "TOP1", "SRC", "FGFR1", "RNF43", "CDK8", "PIK3R1", "NKX3-1", "AURKA", "MYC","BCL2L1")



#covariates<-c("TP53","APC","KRAS","SMAD4", "PIK3CA", "FBXW7","SOX9","TCF7L2","BCL2L1", "BRAF", "DNMT3B","SRC", "MYC" , "ARID1A" , "CDK8",  "PMAIP1" ,"RNF43" , "NKX3-1", "YES1",   "KDM6A" , "AGO2","TOP1", "EGFR", "AKT1", "ATM", "PTEN", "NRAS", "SMARCA4", "STK11", "CDKN2A", "ERBB2")
univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste0('Surv(any_ttm, any_ttm_event) ~ `',x, '`')))
                        
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = GAM_ttm)})
# Extract data 
univ_results <- lapply(univ_models,
                       function(x){ 
                          x <- summary(x)
                          p.value<-signif(x$wald["pvalue"], digits=2)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          HR <-signif(x$coef[2], digits=2);#exp(beta)
                          HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                          HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                          HR <- paste0(HR) 
                          Lower<-paste0(HR.confint.lower) 
                          Upper<-paste0(HR.confint.upper)
                          res<-c(beta, HR, Lower, Upper, wald.test, p.value)
                          names(res)<-c("beta", "HR","Lower", "Upper", "wald.test", 
                                        "p.value")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res <- t(as.data.frame(univ_results, check.names = FALSE))
res<-as.data.frame(res)

res$HR <- as.numeric(res$HR)
res$Lower <- as.numeric(res$Lower)
res$Upper <- as.numeric(res$Upper)
res$p.value <- as.numeric(res$p.value)
res <- res[order(res$p.value), ]

# Keep only the top 10 significant genes
top_genes <- res[1:15, ]

forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot
```

## Univariate (genes only)

already pval adjusted

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event==0 | any_ttm>6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1), sidedness_mpt == "Right")

left_trunc <- left_trunc %>% select(SAMPLE_ID ,any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, lung_ttm, lung_ttm_event )

GAM_ttm <- GAM_final %>% filter(Samples %in% left_trunc$SAMPLE_ID)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones), "CCND2", "DNMT3B", "IRS2", "TOP1", "SRC", "AURKA")  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]


colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")


covariates <- c("MUTYH", "APC", "ATM", "TP53", "PIK3CA", "FBXW7", "AMER1", "SMAD4", "KRAS",   "ERBB2", "NRAS", "SOX9", "CCND2", "PTEN", "ARID1A", "TCF7L2", "DNMT3B", "GNAS", "IRS2", "BRAF",   "SMAD3", "SMAD2", "TOP1", "SRC", "FGFR1", "RNF43", "CDK8", "PIK3R1", "AURKA", "MYC","BCL2L1")
univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste0('Surv( any_ttm-from_sequencing_to_ttm_interval_months, lung_ttm, lung_ttm_event ) ~ `',x, '`')))
                        
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = GAM_ttm)})
# Extract data 
univ_results <- lapply(univ_models,
                       function(x){ 
                          x <- summary(x)
                          p.value<-signif(x$wald["pvalue"], digits=2)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          HR <-signif(x$coef[2], digits=2);#exp(beta)
                          HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                          HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                          HR <- paste0(HR) 
                          Lower<-paste0(HR.confint.lower) 
                          Upper<-paste0(HR.confint.upper)
                          res<-c(beta, HR, Lower, Upper, wald.test, p.value)
                          names(res)<-c("beta", "HR","Lower", "Upper", "wald.test", 
                                        "p.value")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res <- t(as.data.frame(univ_results, check.names = FALSE))
res<-as.data.frame(res)

res$HR <- as.numeric(res$HR)
res$Lower <- as.numeric(res$Lower)
res$Upper <- as.numeric(res$Upper)
res$p.value <- as.numeric(res$p.value)
res <- res[order(res$p.value), ]
adjusted_p_values <- p.adjust(res$p.value, method = "fdr")
res$p.value <- adjusted_p_values
# Keep only the top 10 significant genes
top_genes <- res[1:25, ]

forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

```

## Univariate (genes + clinical)

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event==0 | any_ttm>6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID, SEX, sidedness_mpt, age_at_seq, facets_wgd,facets_fga, tmb2, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing )
left_trunc <- na.omit(left_trunc)

left_trunc$SEX <- ifelse(left_trunc$SEX == "Male", 1, 0)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)

GAM_ttm <- GAM_final %>% filter(Samples %in% left_trunc$SAMPLE_ID)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]
colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")





#GAM_ttm <- na.omit(GAM_ttm)

covariates<-c("APC", "ATM", "TP53", "PIK3CA", "FBXW7", "AMER1", "SMAD4", "KRAS",   "ERBB2", "NRAS", "SOX9", "CCND2", "PTEN", "ARID1A", "TCF7L2", "DNMT3B", "IRS2", "BRAF",   "SMAD3", "SMAD2", "TOP1", "SRC", "FGFR1", "RNF43", "CDK8", "PIK3R1", "NKX3-1", "AURKA", "MYC","BCL2L1", "SEX", "age_at_seq", "facets_fga","tmb2","facets_wgd", "sidedness_mptRectum", "sidedness_mptRight"  )
univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste0('Surv( any_ttm-from_sequencing_to_ttm_interval_months, any_ttm, any_ttm_event) ~ `',x, '`')))
                        
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = GAM_ttm)})
# Extract data 
univ_results <- lapply(univ_models,
                       function(x){ 
                          x <- summary(x)
                          p.value<-signif(x$wald["pvalue"], digits=2)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          HR <-signif(x$coef[2], digits=2);#exp(beta)
                          HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                          HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                          HR <- paste0(HR) 
                          Lower<-paste0(HR.confint.lower) 
                          Upper<-paste0(HR.confint.upper)
                          res<-c(beta, HR, Lower, Upper, wald.test, p.value)
                          names(res)<-c("beta", "HR","Lower", "Upper", "wald.test", 
                                        "p.value")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res <- t(as.data.frame(univ_results, check.names = FALSE))
res<-as.data.frame(res)

res$HR <- as.numeric(res$HR)
res$Lower <- as.numeric(res$Lower)
res$Upper <- as.numeric(res$Upper)
res$p.value <- as.numeric(res$p.value)
res <- res %>% select(HR, Lower, Upper, p.value)

res <- res[order(res$p.value), ]
adjusted_p_values <- p.adjust(res$p.value, method = "fdr")
res$p.value <- adjusted_p_values
top_genes <- res[1:39, ]
top_genes$p.value <- round(top_genes$p.value, 4)


res <- res[order(res$p.value), ]

res <- res %>% filter(Lower !=0)
#if (nrow(res) > 20) {
    # Keep only the top 20 rows
#    res <- head(res, 20)
#} else {
    # If the data frame has fewer than 20 rows, keep all rows
#}
adjusted_p_values <- p.adjust(res$p.value, method = "fdr")
 res$p.value <- adjusted_p_values 
  res <- res[order(res$p.value), ]

     top_genes <- res

top_genes$p.value <- round(top_genes$p.value, 3)
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
```

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event==0 | any_ttm>6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID,tmb2,facets_fga,facets_purity,facets_wgd,  any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing )
left_trunc <- na.omit(left_trunc)

#left_trunc$SEX <- ifelse(left_trunc$SEX == "Male", 1, 0)
#left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
#one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
#left_trunc <- cbind(left_trunc, one_hot_encoded)
#left_trunc$RACE <- as.factor(left_trunc$RACE)
#one_hot_encoded <- as.data.frame(model.matrix(~RACE - 1, data = left_trunc))
#left_trunc <- cbind(left_trunc, one_hot_encoded)
#left_trunc <- left_trunc %>% select(-RACEUNKNOWN, -`RACENATIVE AMERICAN-AM IND/ALASKA`, 
#-RACEOTHER, -`RACEPT REFUSED TO ANSWER`, -`RACENATIVE HAWAIIAN OR PACIFIC ISL`,            -RACE          )

GAM_ttm <- left_trunc





#GAM_ttm <- na.omit(GAM_ttm)

covariates<-c( "tmb2", "facets_fga", "facets_wgd" )
univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste0('Surv( any_ttm-from_sequencing_to_ttm_interval_months, any_ttm, any_ttm_event) ~ `',x, '`')))
                        
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = GAM_ttm)})
# Extract data 
univ_results <- lapply(univ_models,
                       function(x){ 
                          x <- summary(x)
                          p.value<-signif(x$wald["pvalue"], digits=2)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          HR <-signif(x$coef[2], digits=2);#exp(beta)
                          HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                          HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                          HR <- paste0(HR) 
                          Lower<-paste0(HR.confint.lower) 
                          Upper<-paste0(HR.confint.upper)
                          res<-c(beta, HR, Lower, Upper, wald.test, p.value)
                          names(res)<-c("beta", "HR","Lower", "Upper", "wald.test", 
                                        "p.value")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res <- t(as.data.frame(univ_results, check.names = FALSE))
res<-as.data.frame(res)

res$HR <- as.numeric(res$HR)
res$Lower <- as.numeric(res$Lower)
res$Upper <- as.numeric(res$Upper)
res$p.value <- as.numeric(res$p.value)
res <- res %>% select(HR, Lower, Upper, p.value)

res <- res[order(res$p.value), ]
adjusted_p_values <- p.adjust(res$p.value, method = "fdr")
res$p.value <- adjusted_p_values
top_genes <- res[1:39, ]
top_genes$p.value <- round(top_genes$p.value, 4)


res <- res[order(res$p.value), ]

res <- res %>% filter(Lower !=0)
#if (nrow(res) > 20) {
    # Keep only the top 20 rows
#    res <- head(res, 20)
#} else {
    # If the data frame has fewer than 20 rows, keep all rows
#}
adjusted_p_values <- p.adjust(res$p.value, method = "fdr")
 res$p.value <- adjusted_p_values 
  res <- res[order(res$p.value), ]

     top_genes <- res

top_genes$p.value <- round(top_genes$p.value, 3)
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
```

## MultiVariate Genes only

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event==0 | any_ttm>6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID, SEX, sidedness_mpt, age_at_seq, n_scans, diag_to_first_radiology_interval, any_ttm, brain_ttm, brain_ttm_event, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing )
left_trunc$SEX <- ifelse(left_trunc$SEX == "Male", 1, 0)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
### removed NKX3-1, YES1
GAM_ttm <- GAM_final[, c("Samples","TP53","APC","KRAS","SMAD4", "PIK3CA", "FBXW7","SOX9","TCF7L2","BCL2L1", "BRAF", "DNMT3B","SRC", "MYC" , "ARID1A" , "CDK8", "PMAIP1" ,"RNF43",   "KDM6A" ,"TOP1", "EGFR", "AKT1", "ATM", "PTEN", "NRAS", "SMARCA4", "CDKN2A", "ERBB2")]
colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- GAM_ttm %>% mutate(diag_to_seq = any_ttm-from_sequencing_to_ttm_interval_months )
GAM_ttm <- na.omit(GAM_ttm)
res.cox <- coxph(Surv(any_ttm-from_sequencing_to_ttm_interval_months, brain_ttm, brain_ttm_event) ~ TP53 + APC + KRAS + SMAD4 + PIK3CA + FBXW7 + SOX9 + TCF7L2 + BCL2L1 + BRAF + DNMT3B + SRC + MYC + ARID1A+CDK8+PMAIP1+RNF43+KDM6A+TOP1+EGFR+AKT1+ATM+PTEN+NRAS+SMARCA4+CDKN2A+ERBB2, data =GAM_ttm)
res.cox.summary<-summary(res.cox)

# remove STK11
                        
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

# Keep only the top 10 significant genes
top_genes <- res[1:27, ]
#adjusted_p_values <- p.adjust(combined_df$p.value, method = "fdr")
# Add the adjusted p-values to combined_df
#top_genes$p.value <- adjusted_p_values
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
```

## Multivariate 3% cutoff, genes only, sidedness (as factor; 1 colum)

```{r}
left_trunc <- left_trunc1 %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, sidedness_mpt, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing )

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
GAM_ttm <- GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 3)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
percentage_na <- colMeans(is.na(GAM_ttm)) * 100
percentage_na <- as.data.frame(percentage_na)
GAM_ttm <- GAM_ttm[, colnames(GAM_ttm) != "AGO2"]
#GAM_ttm <- GAM_ttm %>% mutate(diag_to_seq = any_ttm-from_sequencing_to_ttm_interval_months )
GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
res.cox <- coxph(Surv(any_ttm-from_sequencing_to_ttm_interval_months, any_ttm,any_ttm_event) ~ sidedness_mpt+TP53 + APC + KRAS + SMAD4 + PIK3CA + FBXW7 + SOX9 + TCF7L2 + BCL2L1 + BRAF + DNMT3B + SRC + MYC +ARID1A+CDK8+TOP1+AMER1+ATM+PTEN+NRAS+SMAD3+SMAD2+ERBB2+AURKA+PIK3R1+`NKX3-1`, data =GAM_ttm)
res.cox.summary<-summary(res.cox)

# remove STK11
                        
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

# Keep only the top 10 significant genes
top_genes <- res#[1:27, ]
#adjusted_p_values <- p.adjust(combined_df$p.value, method = "fdr")
# Add the adjusted p-values to combined_df
#top_genes$p.value <- adjusted_p_values
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
```

## Multi-Variate with all clinical features

```{r}
#left_trunc1 <- read_excel("clinical_mss_anonymous_20240116.xlsx")
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event==0 | any_ttm>6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID, SEX, sidedness_mpt, age_at_seq, facets_wgd,facets_fga, tmb2, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing )
left_trunc$SEX <- ifelse(left_trunc$SEX == "Male", 1, 0)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
### removed NKX3-1, YES1
GAM_ttm <- GAM_final[, c("Samples","APC"  ,  "ATM"  ,  "TP53"  , "PIK3CA", "FBXW7",  "AMER1",  "SMAD4",  "KRAS" ,  "ERBB2",  "NRAS",   "AGO2" ,  "SOX9" ,  "CCND2" , "PTEN",   "ARID1A", "TCF7L2", "DNMT3B" ,"BRAF",   "SMAD3",  "SMAD2",  "TOP1",   "SRC",    "FGFR1",  "RNF43",  "CDK8" ,  "PIK3R1", "NKX3-1", "AURKA", "MYC",    "BCL2L1")]
colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- GAM_ttm %>% mutate(diag_to_seq = any_ttm-from_sequencing_to_ttm_interval_months )
GAM_ttm <- na.omit(GAM_ttm)
res.cox <- coxph(Surv(any_ttm-from_sequencing_to_ttm_interval_months, any_ttm, any_ttm_event) ~ SEX+tmb2+facets_fga+facets_wgd+ sidedness_mptRectum + sidedness_mptLeft + sidedness_mptRight + age_at_seq + TP53 + APC + KRAS + SMAD4 + PIK3CA + FBXW7 + SOX9 + TCF7L2 + BCL2L1 + BRAF + DNMT3B + SRC + MYC + ARID1A+CDK8+RNF43+TOP1+ATM+PTEN+NRAS+ERBB2, data =GAM_ttm)
res.cox.summary<-summary(res.cox)

# remove STK11
                        
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

# Keep only the top 10 significant genes
top_genes <- res
#adjusted_p_values <- p.adjust(combined_df$p.value, method = "fdr")
# Add the adjusted p-values to combined_df
#top_genes$p.value <- adjusted_p_values
top_genes$p.value <- round(top_genes$p.value, 3)


top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
```

```{r}
#library(grid)
#library(forestploter)

```

## Regularized Multivariate Cox

```{r}
#library(glmnet)
left_trunc <- left_trunc1 %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing )

left_trunc <- na.omit(left_trunc)
#left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
GAM_ttm <- GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 3)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
percentage_na <- colMeans(is.na(GAM_ttm)) * 100
percentage_na <- as.data.frame(percentage_na)
GAM_ttm <- GAM_ttm[, colnames(GAM_ttm) != "AGO2"]
#GAM_ttm <- GAM_ttm %>% mutate(diag_to_seq = any_ttm-from_sequencing_to_ttm_interval_months )
GAM_ttm <- na.omit(GAM_ttm) # removed AGO2





x <- GAM_ttm
xy <- x %>% select(APC:BCL2L1)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$any_ttm,  x$any_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)
```

```{r}
cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
```

```{r}
# Example data


# Number of folds
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)

```

```{r}
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
```

```{r}
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)


 
 

 
left_trunc <- left_trunc1 %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing )

left_trunc <- na.omit(left_trunc)

GAM_ttm <- GAM_final



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
percentage_na <- colMeans(is.na(GAM_ttm)) * 100
percentage_na <- as.data.frame(percentage_na)
#GAM_ttm <- GAM_ttm %>% mutate(diag_to_seq = any_ttm-from_sequencing_to_ttm_interval_months )
#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
res.cox <- coxph(Surv(any_ttm-from_sequencing_to_ttm_interval_months, any_ttm,any_ttm_event) ~ MYC+KRAS+BRAF+TCF7L2+SMAD4+TP53+ERBB2+CDK8+AMER1+ARID1A+AURKA+BCL2L1+PTEN+DNMT3B+APC+PIK3CA+ATM+TOP1 + FBXW7 + SMAD3 , data =GAM_ttm)
res.cox.summary<-summary(res.cox)


res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)

```

## FINAL Lasso feeding with sidedness

### GENES + Side

#### All with Side

```{r}


left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter (os_evaluable== TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$any_ttm,  x$any_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
```

```{r}
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))%>% filter(os_evaluable== TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, sidedness_mpt )
left_trunc <- na.omit(left_trunc)

left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)


GAM_ttm <- GAM_final



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
GAM_ttm<-rename(GAM_ttm,  NKX3.1 =`NKX3-1`  )
#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, any_ttm, any_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
all_df <- res %>% select(HR, p.value)
all_df$Site <- "All"
```

#### Liver

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))%>% filter(os_evaluable== TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, liver_ttm, any_ttm, from_sequencing_to_ttm_interval_months, liver_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final# %>% rename(NKX3.1 = `NKX3-1`)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")# %>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$liver_ttm,  x$liver_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
###############
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#################
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID") #%>% rename(NKX3.1 = `NKX3-1`)

#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
#selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, liver_ttm, liver_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
liver_df <- res %>% select(HR, p.value)
liver_df$Site <- "Liver"
```

#### Lung

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable == TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, lung_ttm, any_ttm, from_sequencing_to_ttm_interval_months, lung_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final# %>% rename(NKX3.1 = `NKX3-1`)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")# %>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$lung_ttm,  x$lung_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
###############
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#################
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID") %>% rename(NKX3.1 = `NKX3-1`)

#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, lung_ttm, lung_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
lung_df <- res %>% select(HR, p.value)
lung_df$Site <- "Lung"
```

#### Brain

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable== TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, brain_ttm, any_ttm, from_sequencing_to_ttm_interval_months, brain_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final# %>% rename(NKX3.1 = `NKX3-1`)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")# %>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$brain_ttm,  x$brain_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
###############
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#################
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)



#selected_columns <- c("Samples", rownames(final_genes), "sidedness_mptRectum")  # Adjust as needed
selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID") %>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
#selected_columns <- c(rownames(final_genes)) #############
selected_columns <- c(rownames(percentage_ones), "sidedness_mptRectum") ############
selected_columns <- selected_columns[selected_columns != "AGO2"]
selected_columns <- selected_columns[selected_columns != "AMER1"]############
selected_columns <- selected_columns[selected_columns != "PIK3CA"] ###########
selected_columns <- selected_columns[selected_columns != "SMAD3"] ###########
selected_columns <- selected_columns[selected_columns != "PTEN"] ###########

selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, brain_ttm, brain_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res %>% filter(Lower !=0) ###############
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
brain_df <- res %>% select(HR, p.value)
brain_df$Site <- "Brain"
```

Due to too few brain metastasis events (n=34 in best primary cohort with filters), we are unable to come to any robust or meaningful conclusions

#### Peritoneum

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable==TRUE )

left_trunc <- left_trunc %>% select(SAMPLE_ID, lung_ttm, pleura_ttm, adren_ttm, repr_ttm, perit_ttm, bone_ttm, pleura_ttm_event, adren_ttm_event, repr_ttm_event, perit_ttm_event, bone_ttm_event, any_ttm, from_sequencing_to_ttm_interval_months, lung_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final# %>% rename(NKX3.1 = `NKX3-1`)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")# %>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$perit_ttm,  x$perit_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
###############
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#################
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID") #%>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
#selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, perit_ttm, perit_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]
top_genes <- res %>% filter(Lower !=0) ###############

top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
perit_df <- res %>% select(HR, p.value)
perit_df$Site <- "Peritoneum"
```

#### Bone

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable == TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, lung_ttm, pleura_ttm, adren_ttm, repr_ttm, perit_ttm, bone_ttm, pleura_ttm_event, adren_ttm_event, repr_ttm_event, perit_ttm_event, bone_ttm_event, any_ttm, from_sequencing_to_ttm_interval_months, lung_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final# %>% rename(NKX3.1 = `NKX3-1`)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)
selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")# %>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$bone_ttm,  x$bone_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
###############
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#################
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID") 
if ("NKX3-1" %in% colnames(GAM_ttm)) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
  GAM_ttm <- GAM_ttm %>% rename(NKX3.1 = `NKX3-1`)
}

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
if ("NKX3-1" %in% selected_columns) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)
}

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, bone_ttm, bone_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]
top_genes <- res %>% filter(Lower !=0) ###############

top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
bone_df <- res %>% select(HR, p.value)
bone_df$Site <- "Bone"
```

#### Adrenal

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID, lung_ttm, pleura_ttm, adren_ttm, repr_ttm, perit_ttm, bone_ttm, pleura_ttm_event, adren_ttm_event, repr_ttm_event, perit_ttm_event, bone_ttm_event, any_ttm, from_sequencing_to_ttm_interval_months, lung_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final# %>% rename(NKX3.1 = `NKX3-1`)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)
selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")# %>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$adren_ttm,  x$adren_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
###############
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#################
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID") 
if ("NKX3-1" %in% colnames(GAM_ttm)) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
  GAM_ttm <- GAM_ttm %>% rename(NKX3.1 = `NKX3-1`)
}

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
if ("NKX3-1" %in% selected_columns) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)
}

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, adren_ttm, adren_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]
top_genes <- res %>% filter(Lower !=0) ###############

top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
adrenal_df <- res %>% select(HR, p.value)
adrenal_df$Site <- "Adrenal"
```

Too few to do meaningful statistics

#### Reproductive

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, lung_ttm, pleura_ttm, adren_ttm, repr_ttm, perit_ttm, bone_ttm, pleura_ttm_event, adren_ttm_event, repr_ttm_event, perit_ttm_event, bone_ttm_event, any_ttm, from_sequencing_to_ttm_interval_months, lung_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final# %>% rename(NKX3.1 = `NKX3-1`)

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)
selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")# %>% rename(NKX3.1 = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$repr_ttm,  x$repr_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
###############
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#################
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID") 
if ("NKX3-1" %in% colnames(GAM_ttm)) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
  GAM_ttm <- GAM_ttm %>% rename(NKX3.1 = `NKX3-1`)
}

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
if ("NKX3-1" %in% selected_columns) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)
}

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, repr_ttm, repr_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]
top_genes <- res %>% filter(Lower !=0) ###############

top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
Repr_df <- res %>% select(HR, p.value)
Repr_df$Site <- "Reproductive"
```

unable to do pleura.

```{r}

add_gene_column <- function(df) {
  df$gene <- rownames(df)
  return(df)
}

# Apply the function to each data frame
bone_df <- add_gene_column(bone_df)
all_df <- add_gene_column(all_df)
liver_df <- add_gene_column(liver_df)
lung_df <- add_gene_column(lung_df)
perit_df <- add_gene_column(perit_df)
Repr_df <- add_gene_column(Repr_df)
brain_df <- add_gene_column(brain_df)
#adrenal_df <- add_gene_column(adrenal_df)
volcano_plot_all <- rbind(all_df, bone_df, liver_df, lung_df, perit_df, Repr_df, brain_df)
volcano_plot_all$neg_log_pvalue <- -log10(volcano_plot_all$p.value)
volcano_plot_all <- volcano_plot_all %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_all$gene <- ifelse(volcano_plot_all$gene == "sidedness_mptRectum", "Rectum", volcano_plot_all$gene)

genes_side_data <- volcano_plot_all


genes_side_plot <- ggplot(data = volcano_plot_all, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) + # Set y-axis limits and ticks
  geom_text_repel(data = subset(volcano_plot_all, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + 
  scale_color_lancet() + scale_fill_lancet() +
  theme_classic() 
ggsave(
  filename = "genes_side_plot.pdf",
  plot = genes_side_plot,width = 5,  height = 4, dpi = 900)
```

### PATHWAY + Side

#### ALL

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable == TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- pathway_GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$any_ttm,  x$any_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))%>% filter(os_evaluable ==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, sidedness_mpt )
left_trunc <- na.omit(left_trunc)

left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)


GAM_ttm <- pathway_GAM_final



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed

# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, any_ttm, any_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
ggsave(filename = "All_pathways_sided.png", plot = p, width = 6, height = 6, dpi = 900)
ggsave(filename = "All_pathways_sided.pdf", plot = p, width = 6, height = 6, dpi = 900)

all_pathway_df <- res %>% select(HR, p.value)
all_pathway_df$Site <- "All"
```

#### Test

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, sidedness_mpt, adren_ttm, adren_ttm_event)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- pathway_GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2

selected_columns <- selected_columns[selected_columns != "Samples"]

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, adren_ttm, adren_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res %>% filter(Lower !=0) ###############
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
liver_pathway_df <- res %>% select(HR, p.value)
liver_pathway_df$Site <- "Liver"
```

#### Sites Pathway with Side

```{r, warning=FALSE}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(os_evaluable == TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, sidedness_mpt,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
    one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
    left_trunc <- cbind(left_trunc, one_hot_encoded)
    GAM_ttm <- pathway_GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable == TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, sidedness_mpt, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)

left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)


GAM_ttm <- pathway_GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
    selected_columns <- c(rownames(final_genes))
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot
```

```{r}
# Accessing the results:
# For example, to access the result for the "bone" site:
bone_result <- results[["bone"]]
bone_res <- bone_result$res
bone_res$Site <- "Bone"
bone_forest_plot <- bone_result$forest_plot
bone_lasso_plot <- bone_result$lasso_plot


liver_result <- results[["liver"]]
liver_res <- liver_result$res
liver_forest_plot <- liver_result$forest_plot
liver_lasso_plot <- liver_result$lasso_plot

brain_result <- results[["brain"]]
brain_res <- brain_result$res
brain_forest_plot <- brain_result$forest_plot
brain_lasso_plot <- brain_result$lasso_plot

lung_result <- results[["lung"]]
lung_res <- lung_result$res
lung_forest_plot <- lung_result$forest_plot
lung_lasso_plot <- lung_result$lasso_plot

perit_result <- results[["perit"]]
perit_res <- perit_result$res
perit_forest_plot <- perit_result$forest_plot
perit_lasso_plot <- perit_result$lasso_plot

repr_result <- results[["repr"]]
repr_res <- repr_result$res
repr_forest_plot <- repr_result$forest_plot
repr_lasso_plot <- repr_result$lasso_plot
liver_res$Site <- "Liver"

# Update brain_res dataframe
brain_res$Site <- "Brain"
# Update lung_res dataframe
lung_res$Site <- "Lung"

# Update perit_res dataframe
perit_res$Site <- "Peritoneum"

# Update repr_res dataframe
repr_res$Site <- "Reproductive"
liver_res$Site <- "Liver"
bone_res <- add_gene_column(bone_res)
all_pathway_df <- add_gene_column(all_pathway_df)
liver_res <- add_gene_column(liver_res)
lung_res <- add_gene_column(lung_res)
perit_res <- add_gene_column(perit_res)
repr_res <- add_gene_column(repr_res)
brain_res <- add_gene_column(brain_res)

volcano_plot_pathways_all <- rbind(all_pathway_df, bone_res, liver_res, lung_res, perit_res, repr_res, brain_res)
volcano_plot_pathways_all$neg_log_pvalue <- -log10(volcano_plot_pathways_all$p.value)
volcano_plot_pathways_all <- volcano_plot_pathways_all %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_pathways_all$gene <- ifelse(volcano_plot_pathways_all$gene == "sidedness_mptRectum", "Rectum", volcano_plot_pathways_all$gene)
pathway_side_data <- volcano_plot_pathways_all

pathway_side_plot <- genes_side_plot <- ggplot(data = volcano_plot_pathways_all, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
  scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) + # Set y-axis limits and ticks
  geom_text_repel(data = subset(volcano_plot_pathways_all, p.value < 0.051), aes(label = gene), size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + 
  scale_color_lancet() + scale_fill_lancet() +
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_side/pathways_side_volc_plot.pdf",
  plot = pathway_side_plot,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_side/pathways_side_volc_plot.png",
  plot = pathway_side_plot,width = 5,  height = 4,  units = "in", dpi = 900)

forest_plots_list <- list(
  repr_forest_plot, 
  perit_forest_plot, 
  liver_forest_plot, 
  lung_forest_plot, 
  brain_forest_plot, 
  bone_forest_plot
)

pathway_names <- c("repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_side/", pathway_names[i], "_forest_plot_pathways_side.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_side/", pathway_names[i], "_forest_plot_pathways_side.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### GENES Only

#### All Genes only

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_competing, any_ttm_event)
left_trunc$any_ttm_competing <- as.factor(left_trunc$any_ttm_competing)
left_trunc <- na.omit(left_trunc)

GAM_ttm <- GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$any_ttm,  x$any_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
#######################
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
##################
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)
GAM_ttm <- GAM_final

selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
GAM_ttm <- GAM_ttm %>% rename(`NKX3.1` = `NKX3-1`)

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2

selected_columns <- c(rownames(final_genes))
selected_columns <- gsub("NKX3-1", "NKX3.1", (selected_columns))

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, any_ttm, any_ttm_competing) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_only/any_site_genes_only.png",
  plot = p, width = 6,  height = 6,   dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_only/any_site_genes_only.pdf",
  plot = p, width = 6,  height = 6,   dpi = 900)
all_genes_only_df <- res %>% select(HR, p.value)
all_genes_only_df$Site <- "All"
```

#### Sites Genes Only

```{r}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(os_evaluable == TRUE) #%>% filter(sidedness_mpt == "Left")
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)



GAM_ttm <- GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    selected_columns <- selected_columns[selected_columns != "AGO2"]

    GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    
    
    
    if ("NKX3-1" %in% colnames(GAM_ttm)) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
  GAM_ttm <- GAM_ttm %>% rename(NKX3.1 = `NKX3-1`)
}

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
if ("NKX3-1" %in% selected_columns) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)
}
    
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot
bone_result_genes_only <- results[["bone"]]
bone_res_genes_only <- bone_result_genes_only$res
bone_forest_plot_genes_only <- bone_result_genes_only$forest_plot
bone_lasso_plot_genes_only <- bone_result_genes_only$lasso_plot


liver_result_genes_only <- results[["liver"]]
liver_res_genes_only <- liver_result_genes_only$res
liver_forest_plot_genes_only <- liver_result_genes_only$forest_plot
liver_lasso_plot_genes_only <- liver_result_genes_only$lasso_plot

brain_result_genes_only <- results[["brain"]]
brain_res_genes_only <- brain_result_genes_only$res
brain_forest_plot_genes_only <- brain_result_genes_only$forest_plot
brain_lasso_plot_genes_only <- brain_result_genes_only$lasso_plot

lung_result_genes_only <- results[["lung"]]
lung_res_genes_only <- lung_result_genes_only$res
lung_forest_plot_genes_only <- lung_result_genes_only$forest_plot
lung_lasso_plot_genes_only <- lung_result_genes_only$lasso_plot

perit_result_genes_only <- results[["perit"]]
perit_res_genes_only <- perit_result_genes_only$res
perit_forest_plot_genes_only <- perit_result_genes_only$forest_plot
perit_lasso_plot_genes_only <- perit_result_genes_only$lasso_plot

repr_result_genes_only <- results[["repr"]]
repr_res_genes_only <- repr_result_genes_only$res
repr_forest_plot_genes_only <- repr_result_genes_only$forest_plot
repr_lasso_plot_genes_only <- repr_result_genes_only$lasso_plot

liver_res_genes_only$Site <- "Liver"
bone_res_genes_only$Site <- "Bone"
# Update brain_res_genes_only dataframe
brain_res_genes_only$Site <- "Brain"

# Update lung_res_genes_only dataframe
lung_res_genes_only$Site <- "Lung"

# Update perit_res_genes_only dataframe
perit_res_genes_only$Site <- "Peritoneum"

# Update repr_res_genes_only dataframe
repr_res_genes_only$Site <- "Reproductive"

########
bone_res_genes_only <- add_gene_column(bone_res_genes_only)
all_genes_only_df <- add_gene_column(all_genes_only_df)
liver_res_genes_only <- add_gene_column(liver_res_genes_only)
lung_res_genes_only <- add_gene_column(lung_res_genes_only)
perit_res_genes_only <- add_gene_column(perit_res_genes_only)
repr_res_genes_only <- add_gene_column(repr_res_genes_only)
brain_res_genes_only <- add_gene_column(brain_res_genes_only)

volcano_plot_genes_only_all <- rbind(all_genes_only_df, bone_res_genes_only, liver_res_genes_only, lung_res_genes_only, perit_res_genes_only, repr_res_genes_only, brain_res_genes_only)
volcano_plot_genes_only_all$neg_log_pvalue <- -log10(volcano_plot_genes_only_all$p.value)
volcano_plot_genes_only_all <- volcano_plot_genes_only_all %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_genes_only_all$gene <- ifelse(volcano_plot_genes_only_all$gene == "sidedness_mptRectum", "Rectum", volcano_plot_genes_only_all$gene)
genes_only_data <- volcano_plot_genes_only_all

genes_only_plot <- ggplot(data = volcano_plot_genes_only_all, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
    scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
  geom_text_repel(data = subset(volcano_plot_genes_only_all, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_only/genes_only_volc_plot.pdf",
  plot = genes_only_plot,width = 5,  height = 4,  units = "in", dpi = 900)

forest_plots_list <- list(
  repr_forest_plot_genes_only, 
  perit_forest_plot_genes_only, 
  liver_forest_plot_genes_only, 
  lung_forest_plot_genes_only, 
  brain_forest_plot_genes_only, 
  bone_forest_plot_genes_only
)

pathway_names <- c("repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Genes_only/", pathway_names[i], "_forest_plot_genes_only.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Genes_only/", pathway_names[i], "_forest_plot_genes_only.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### PATHWAY Only

#### All Pathway only

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event)

left_trunc <- na.omit(left_trunc)

GAM_ttm <- pathway_GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$any_ttm,  x$any_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing )
left_trunc <- na.omit(left_trunc)


GAM_ttm <- pathway_GAM_final



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed

# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, any_ttm, any_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
  geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
  geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
  geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
  geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
  labs(title = "Time to Metastasis",
       x = "Hazard Ratio (HR)",
       y = "Covariates") +
  theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
ggsave(filename = "/Users/krisa/Desktop/Final Figures/Pathways_only/all_pathway_only_forest.png", plot = p, width = 6, height = 6, dpi = 900)
ggsave(filename = "/Users/krisa/Desktop/Final Figures/Pathways_only/all_pathway_only_forest.pdf", plot = p, width = 6, height = 6, dpi = 900)

all_pathway_only_df <- res %>% select(HR, p.value)
all_pathway_only_df$Site <- "All"
```

#### Sites Pathway

```{r}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(os_evaluable==TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- pathway_GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(os_evaluable == TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)




GAM_ttm <- pathway_GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
    selected_columns <- c(rownames(final_genes))
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot

bone_result_pathway_only <- results[["bone"]]
bone_res_pathway_only <- bone_result_pathway_only$res
bone_forest_plot_pathway_only<- bone_result_pathway_only$forest_plot
bone_lasso_plot_pathway_only<- bone_result_pathway_only$lasso_plot


liver_result_pathway_only <- results[["liver"]]
liver_res_pathway_only <- liver_result_pathway_only$res
liver_forest_plot_pathway_only <- liver_result_pathway_only$forest_plot
liver_lasso_plot_pathway_only <- liver_result_pathway_only$lasso_plot

brain_result_pathway_only <- results[["brain"]]
brain_res_pathway_only <- brain_result_pathway_only$res
brain_forest_plot_pathway_only <- brain_result_pathway_only$forest_plot
brain_lasso_plot_pathway_only <- brain_result_pathway_only$lasso_plot

lung_result_pathway_only <- results[["lung"]]
lung_res_pathway_only <- lung_result_pathway_only$res
lung_forest_plot_pathway_only <- lung_result_pathway_only$forest_plot
lung_lasso_plot_pathway_only <- lung_result_pathway_only$lasso_plot

perit_result_pathway_only <- results[["perit"]]
perit_res_pathway_only <- perit_result_pathway_only$res
perit_forest_plot_pathway_only <- perit_result_pathway_only$forest_plot
perit_lasso_plot_pathway_only <- perit_result_pathway_only$lasso_plot

repr_result_pathway_only <- results[["repr"]]
repr_res_pathway_only <- repr_result_pathway_only$res
repr_forest_plot_pathway_only <- repr_result_pathway_only$forest_plot
repr_lasso_plot_pathway_only <- repr_result_pathway_only$lasso_plot
bone_res_pathway_only$Site <- "Bone"
liver_res_pathway_only$Site <- "Liver"
# Update brain_res_pathway_only dataframe
brain_res_pathway_only$Site <- "Brain"

# Update lung_res_pathway_only dataframe
lung_res_pathway_only$Site <- "Lung"

# Update perit_res_pathway_only dataframe
perit_res_pathway_only$Site <- "Peritoneum"

# Update repr_res_pathway_only dataframe
repr_res_pathway_only$Site <- "Reproductive"

#all_pathway_only_df

#####
bone_res_pathway_only <- add_gene_column(bone_res_pathway_only)
all_pathway_only_df <- add_gene_column(all_pathway_only_df)
liver_res_pathway_only <- add_gene_column(liver_res_pathway_only)
lung_res_pathway_only <- add_gene_column(lung_res_pathway_only)
perit_res_pathway_only <- add_gene_column(perit_res_pathway_only)
repr_res_pathway_only <- add_gene_column(repr_res_pathway_only)
brain_res_pathway_only <- add_gene_column(brain_res_pathway_only)

volcano_plot_pathway_only_all <- rbind(all_pathway_only_df, bone_res_pathway_only, liver_res_pathway_only, lung_res_pathway_only, perit_res_pathway_only, repr_res_pathway_only, brain_res_pathway_only)
volcano_plot_pathway_only_all$neg_log_pvalue <- -log10(volcano_plot_pathway_only_all$p.value)
volcano_plot_pathway_only_all <- volcano_plot_pathway_only_all %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_pathway_only_all$gene <- ifelse(volcano_plot_pathway_only_all$gene == "sidedness_mptRectum", "Rectum", volcano_plot_pathway_only_all$gene)
pathway_only_data <- volcano_plot_pathway_only_all

pathway_only_plot <- ggplot(data = volcano_plot_pathway_only_all, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
    scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
  geom_text_repel(data = subset(volcano_plot_pathway_only_all, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_only/pathway_only_volc_plot.pdf",
  plot = pathway_only_plot,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_only/pathway_only_volc_plot.png",
  plot = pathway_only_plot,width = 5,  height = 4,  units = "in", dpi = 900)
lung_forest_plot_pathway_only<-lung_forest_pathway_only
brain_forest_plot_pathway_only<-brain_forest_pathway_only
forest_plots_list <- list(
  repr_forest_plot_pathway_only, 
  perit_forest_plot_pathway_only, 
  liver_forest_plot_pathway_only, 
  lung_forest_plot_pathway_only, 
  brain_forest_plot_pathway_only, 
  bone_forest_plot_pathway_only
)

pathway_names <- c("repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_only/", pathway_names[i], "_forest_plot_pathway_only.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_only/", pathway_names[i], "_forest_plot_pathway_only.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### Genes Only Left

```{r warning=FALSE}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(sidedness_mpt == "Left") %>% filter(os_evaluable==TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
#view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter (sidedness_mpt == "Left") %>% filter(os_evaluable == TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)



GAM_ttm <- GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    selected_columns <- selected_columns[selected_columns != "AGO2"]

    GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    
    
    
    if ("NKX3-1" %in% colnames(GAM_ttm)) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
  GAM_ttm <- GAM_ttm %>% rename(NKX3.1 = `NKX3-1`)
}

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
if ("NKX3-1" %in% selected_columns) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)
}
    
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("any","liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot
all_result_genes_only_left <- results[["any"]]
all_res_genes_only_left <- all_result_genes_only_left$res
all_forest_plot_genes_only_left <- all_result_genes_only_left$forest_plot
all_lasso_plot_genes_only_left <- all_result_genes_only_left$lasso_plot

bone_result_genes_only_left <- results[["bone"]]
bone_res_genes_only_left <- bone_result_genes_only_left$res
bone_forest_plot_genes_only_left <- bone_result_genes_only_left$forest_plot
bone_lasso_plot_genes_only_left <- bone_result_genes_only_left$lasso_plot

liver_result_genes_only_left <- results[["liver"]]
liver_res_genes_only_left <- liver_result_genes_only_left$res
liver_forest_plot_genes_only_left <- liver_result_genes_only_left$forest_plot
liver_lasso_plot_genes_only_left <- liver_result_genes_only_left$lasso_plot

brain_result_genes_only_left <- results[["brain"]]
brain_res_genes_only_left <- brain_result_genes_only_left$res
brain_forest_plot_genes_only_left <- brain_result_genes_only_left$forest_plot
brain_lasso_plot_genes_only_left <- brain_result_genes_only_left$lasso_plot

lung_result_genes_only_left <- results[["lung"]]
lung_res_genes_only_left <- lung_result_genes_only_left$res
lung_forest_plot_genes_only_left <- lung_result_genes_only_left$forest_plot
lung_lasso_plot_genes_only_left <- lung_result_genes_only_left$lasso_plot

perit_result_genes_only_left <- results[["perit"]]
perit_res_genes_only_left <- perit_result_genes_only_left$res
perit_forest_plot_genes_only_left <- perit_result_genes_only_left$forest_plot
perit_lasso_plot_genes_only_left <- perit_result_genes_only_left$lasso_plot

repr_result_genes_only_left <- results[["repr"]]
repr_res_genes_only_left <- repr_result_genes_only_left$res
repr_forest_plot_genes_only_left <- repr_result_genes_only_left$forest_plot
repr_lasso_plot_genes_only_left <- repr_result_genes_only_left$lasso_plot

all_res_genes_only_left$Site <- "All"
liver_res_genes_only_left$Site <- "Liver"
bone_res_genes_only_left$Site <- "Bone"
brain_res_genes_only_left$Site <- "Brain"
lung_res_genes_only_left$Site <- "Lung"
perit_res_genes_only_left$Site <- "Peritoneum"
repr_res_genes_only_left$Site <- "Reproductive"

liver_res_genes_only_left <- add_gene_column(liver_res_genes_only_left)
bone_res_genes_only_left <- add_gene_column(bone_res_genes_only_left)
all_res_genes_only_left <- add_gene_column(all_res_genes_only_left)
lung_res_genes_only_left <- add_gene_column(lung_res_genes_only_left)
perit_res_genes_only_left <- add_gene_column(perit_res_genes_only_left)
repr_res_genes_only_left <- add_gene_column(repr_res_genes_only_left)
brain_res_genes_only_left <- add_gene_column(brain_res_genes_only_left)

volcano_plot_genes_only_left <- rbind(all_res_genes_only_left, bone_res_genes_only_left, liver_res_genes_only_left, lung_res_genes_only_left, perit_res_genes_only_left, repr_res_genes_only_left, brain_res_genes_only_left)
volcano_plot_genes_only_left$neg_log_pvalue <- -log10(volcano_plot_genes_only_left$p.value)
volcano_plot_genes_only_left <- volcano_plot_genes_only_left %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_genes_only_left$gene <- ifelse(volcano_plot_genes_only_left$gene == "sidedness_mptRectum", "Rectum", volcano_plot_genes_only_left$gene)
genes_only_data_left <- volcano_plot_genes_only_left

genes_only_left_plot <- ggplot(data = volcano_plot_genes_only_left, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
     scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
  geom_text_repel(data = subset(volcano_plot_genes_only_left, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_left/genes_only_left_volc_plot.pdf",
  plot = genes_only_left_plot,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_left/genes_only_left_volc_plot.png",
  plot = genes_only_left_plot,width = 5,  height = 4,  units = "in", dpi = 900)
forest_plots_list <- list(
  all_forest_plot_genes_only_left,
  repr_forest_plot_genes_only_left, 
  perit_forest_plot_genes_only_left, 
  liver_forest_plot_genes_only_left, 
  lung_forest_plot_genes_only_left, 
  brain_forest_plot_genes_only_left, 
  bone_forest_plot_genes_only_left
)

pathway_names <- c("all","repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Genes_left/", pathway_names[i], "_forest_plot_genes_only_left.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Genes_left/", pathway_names[i], "_forest_plot_genes_only_left.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### Genes Only Right

```{r, warning=FALSE}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(sidedness_mpt == "Right") %>% filter(os_evaluable==TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
#view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter (sidedness_mpt == "Right") %>% filter(os_evaluable == TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)



GAM_ttm <- GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    selected_columns <- selected_columns[selected_columns != "AGO2"]

    GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    
    
    
    if ("NKX3-1" %in% colnames(GAM_ttm)) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
  GAM_ttm <- GAM_ttm %>% rename(NKX3.1 = `NKX3-1`)
}

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
if ("NKX3-1" %in% selected_columns) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)
}
    
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    res <- res[complete.cases(res), ]
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)
dim(GAM_ttm)
# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("any","liver","bone", "lung", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot
all_result_genes_only_right <- results[["any"]]
all_res_genes_only_right <- all_result_genes_only_right$res
all_forest_plot_genes_only_right <- all_result_genes_only_right$forest_plot
all_lasso_plot_genes_only_right <- all_result_genes_only_right$lasso_plot

bone_result_genes_only_right <- results[["bone"]]
bone_res_genes_only_right <- bone_result_genes_only_right$res
bone_forest_plot_genes_only_right <- bone_result_genes_only_right$forest_plot
bone_lasso_plot_genes_only_right <- bone_result_genes_only_right$lasso_plot

liver_result_genes_only_right <- results[["liver"]]
liver_res_genes_only_right <- liver_result_genes_only_right$res
liver_forest_plot_genes_only_right <- liver_result_genes_only_right$forest_plot
liver_lasso_plot_genes_only_right <- liver_result_genes_only_right$lasso_plot

#brain_result_genes_only_right <- results[["brain"]]
#brain_res_genes_only_right <- brain_result_genes_only_right$res
#brain_forest_plot_genes_only_right <- brain_result_genes_only_right$forest_plot
#brain_lasso_plot_genes_only_right <- brain_result_genes_only_right$lasso_plot

lung_result_genes_only_right <- results[["lung"]]
lung_res_genes_only_right <- lung_result_genes_only_right$res
lung_forest_plot_genes_only_right <- lung_result_genes_only_right$forest_plot
lung_lasso_plot_genes_only_right <- lung_result_genes_only_right$lasso_plot

perit_result_genes_only_right <- results[["perit"]]
perit_res_genes_only_right <- perit_result_genes_only_right$res
perit_forest_plot_genes_only_right <- perit_result_genes_only_right$forest_plot
perit_lasso_plot_genes_only_right <- perit_result_genes_only_right$lasso_plot

repr_result_genes_only_right <- results[["repr"]]
repr_res_genes_only_right <- repr_result_genes_only_right$res
repr_forest_plot_genes_only_right <- repr_result_genes_only_right$forest_plot
repr_lasso_plot_genes_only_right <- repr_result_genes_only_right$lasso_plot
all_res_genes_only_right$Site <- "All"
liver_res_genes_only_right$Site <- "Liver"
bone_res_genes_only_right$Site <- "Bone"
#brain_res_genes_only_right$Site <- "Brain"
lung_res_genes_only_right$Site <- "Lung"
perit_res_genes_only_right$Site <- "Peritoneum"
repr_res_genes_only_right$Site <- "Reproductive"

liver_res_genes_only_right <- add_gene_column(liver_res_genes_only_right)
bone_res_genes_only_right <- add_gene_column(bone_res_genes_only_right)
all_res_genes_only_right <- add_gene_column(all_res_genes_only_right)
lung_res_genes_only_right <- add_gene_column(lung_res_genes_only_right)
perit_res_genes_only_right <- add_gene_column(perit_res_genes_only_right)
repr_res_genes_only_right <- add_gene_column(repr_res_genes_only_right)
#brain_res_genes_only_right <- add_gene_column(brain_res_genes_only_right)

volcano_plot_genes_only_right <- rbind(all_res_genes_only_right, bone_res_genes_only_right, liver_res_genes_only_right, lung_res_genes_only_right, perit_res_genes_only_right, repr_res_genes_only_right)#, brain_res_genes_only_right)

volcano_plot_genes_only_right$neg_log_pvalue <- -log10(volcano_plot_genes_only_right$p.value)
volcano_plot_genes_only_right <- volcano_plot_genes_only_right %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_genes_only_right$gene <- ifelse(volcano_plot_genes_only_right$gene == "sidedness_mptRectum", "Rectum", volcano_plot_genes_only_right$gene)
genes_only_data_right <- volcano_plot_genes_only_right

genes_only_right_plot <- ggplot(data = volcano_plot_genes_only_right, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
     scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  # Set log scale for x-axis
  geom_text_repel(data = subset(volcano_plot_genes_only_right, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_right/genes_only_right_volc_plot.pdf",
  plot = genes_only_right_plot,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_right/genes_only_right_volc_plot.png",
  plot = genes_only_right_plot,width = 5,  height = 4,  units = "in", dpi = 900)

forest_plots_list <- list(
  
  all_forest_plot_genes_only_right,repr_forest_plot_genes_only_right,
perit_forest_plot_genes_only_right,
liver_forest_plot_genes_only_right,
lung_forest_plot_genes_only_right,
bone_forest_plot_genes_only_right
)

pathway_names <- c("all","repr", "perit", "liver", "lung", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Genes_right/", pathway_names[i], "_forest_plot_genes_only_right.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Genes_right/", pathway_names[i], "_forest_plot_genes_only_right.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### Genes Only Rectum

```{r}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(sidedness_mpt == "Rectum") %>% filter(os_evaluable == TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter (sidedness_mpt == "Rectum") %>% filter(os_evaluable==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)



GAM_ttm <- GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    selected_columns <- selected_columns[selected_columns != "AGO2"]

    GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    
    
    
    if ("NKX3-1" %in% colnames(GAM_ttm)) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
  GAM_ttm <- GAM_ttm %>% rename(NKX3.1 = `NKX3-1`)
}

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
if ("NKX3-1" %in% selected_columns) {
  # If "NKX3-1" is present, rename it to "NKX3.1"
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)
}
    
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("any","liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot
all_result_genes_only_rectum <- results[["any"]]
all_res_genes_only_rectum <- all_result_genes_only_rectum$res
all_forest_plot_genes_only_rectum <- all_result_genes_only_rectum$forest_plot
all_lasso_plot_genes_only_rectum <- all_result_genes_only_rectum$lasso_plot

bone_result_genes_only_rectum <- results[["bone"]]
bone_res_genes_only_rectum <- bone_result_genes_only_rectum$res
bone_forest_plot_genes_only_rectum <- bone_result_genes_only_rectum$forest_plot
bone_lasso_plot_genes_only_rectum <- bone_result_genes_only_rectum$lasso_plot

liver_result_genes_only_rectum <- results[["liver"]]
liver_res_genes_only_rectum <- liver_result_genes_only_rectum$res
liver_forest_plot_genes_only_rectum <- liver_result_genes_only_rectum$forest_plot
liver_lasso_plot_genes_only_rectum <- liver_result_genes_only_rectum$lasso_plot

brain_result_genes_only_rectum <- results[["brain"]]
brain_res_genes_only_rectum <- brain_result_genes_only_rectum$res
brain_forest_plot_genes_only_rectum <- brain_result_genes_only_rectum$forest_plot
brain_lasso_plot_genes_only_rectum <- brain_result_genes_only_rectum$lasso_plot

lung_result_genes_only_rectum <- results[["lung"]]
lung_res_genes_only_rectum <- lung_result_genes_only_rectum$res
lung_forest_plot_genes_only_rectum <- lung_result_genes_only_rectum$forest_plot
lung_lasso_plot_genes_only_rectum <- lung_result_genes_only_rectum$lasso_plot

perit_result_genes_only_rectum <- results[["perit"]]
perit_res_genes_only_rectum <- perit_result_genes_only_rectum$res
perit_forest_plot_genes_only_rectum <- perit_result_genes_only_rectum$forest_plot
perit_lasso_plot_genes_only_rectum <- perit_result_genes_only_rectum$lasso_plot

repr_result_genes_only_rectum <- results[["repr"]]
repr_res_genes_only_rectum <- repr_result_genes_only_rectum$res
repr_forest_plot_genes_only_rectum <- repr_result_genes_only_rectum$forest_plot
repr_lasso_plot_genes_only_rectum <- repr_result_genes_only_rectum$lasso_plot

all_res_genes_only_rectum$Site <- "All"
liver_res_genes_only_rectum$Site <- "Liver"
bone_res_genes_only_rectum$Site <- "Bone"
brain_res_genes_only_rectum$Site <- "Brain"
lung_res_genes_only_rectum$Site <- "Lung"
perit_res_genes_only_rectum$Site <- "Peritoneum"
repr_res_genes_only_rectum$Site <- "Reproductive"


liver_res_genes_only_rectum <- add_gene_column(liver_res_genes_only_rectum)
bone_res_genes_only_rectum <- add_gene_column(bone_res_genes_only_rectum)
all_res_genes_only_rectum <- add_gene_column(all_res_genes_only_rectum)
lung_res_genes_only_rectum <- add_gene_column(lung_res_genes_only_rectum)
perit_res_genes_only_rectum <- add_gene_column(perit_res_genes_only_rectum)
repr_res_genes_only_rectum <- add_gene_column(repr_res_genes_only_rectum)
brain_res_genes_only_rectum <- add_gene_column(brain_res_genes_only_rectum)

volcano_plot_genes_only_rectum <- rbind(all_res_genes_only_rectum, bone_res_genes_only_rectum, liver_res_genes_only_rectum, lung_res_genes_only_rectum, perit_res_genes_only_rectum, repr_res_genes_only_rectum, brain_res_genes_only_rectum)


volcano_plot_genes_only_rectum$neg_log_pvalue <- -log10(volcano_plot_genes_only_rectum$p.value)
volcano_plot_genes_only_rectum <- volcano_plot_genes_only_rectum %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_genes_only_rectum$gene <- ifelse(volcano_plot_genes_only_rectum$gene == "sidedness_mptRectum", "Rectum", volcano_plot_genes_only_rectum$gene)
genes_only_data_rectum <- volcano_plot_genes_only_rectum

genes_only_rectum_plot <- ggplot(data = volcano_plot_genes_only_rectum, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
     scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  # Set log scale for x-axis
  geom_text_repel(data = subset(volcano_plot_genes_only_rectum, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_rectum/genes_only_rectum_volc_plot.pdf",
  plot = genes_only_rectum_plot,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Genes_rectum/genes_only_rectum_volc_plot.png",
  plot = genes_only_rectum_plot,width = 5,  height = 4,  units = "in", dpi = 900)

forest_plots_list <- list(
  
  all_forest_plot_genes_only_rectum,
repr_forest_plot_genes_only_rectum,
perit_forest_plot_genes_only_rectum,
liver_forest_plot_genes_only_rectum,
lung_forest_plot_genes_only_rectum,
brain_forest_plot_genes_only_rectum,
bone_forest_plot_genes_only_rectum

)

pathway_names <- c("all","repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Genes_rectum/", pathway_names[i], "_forest_plot_genes_only_rectum.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 700
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Genes_rectum/", pathway_names[i], "_forest_plot_genes_only_rectum.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### Pathway Only Left

```{r warning=FALSE}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(sidedness_mpt == "Left") %>% filter(os_evaluable==TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- pathway_GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(sidedness_mpt== "Left") %>% filter(os_evaluable==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)




GAM_ttm <- pathway_GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
    selected_columns <- c(rownames(final_genes))
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("any","liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot

all_result_pathway_only_left <- results[["any"]]
all_res_pathway_only_left <- all_result_pathway_only_left$res
all_forest_plot_pathway_only_left <- all_result_pathway_only_left$forest_plot
all_lasso_plot_pathway_only_left <- all_result_pathway_only_left$lasso_plot

bone_result_pathway_only_left <- results[["bone"]]
bone_res_pathway_only_left <- bone_result_pathway_only_left$res
bone_forest_plot_pathway_only_left <- bone_result_pathway_only_left$forest_plot
bone_lasso_plot_pathway_only_left <- bone_result_pathway_only_left$lasso_plot

liver_result_pathway_only_left <- results[["liver"]]
liver_res_pathway_only_left <- liver_result_pathway_only_left$res
liver_forest_plot_pathway_only_left <- liver_result_pathway_only_left$forest_plot
liver_lasso_plot_pathway_only_left <- liver_result_pathway_only_left$lasso_plot

brain_result_pathway_only_left <- results[["brain"]]
brain_res_pathway_only_left <- brain_result_pathway_only_left$res
brain_forest_plot_pathway_only_left <- brain_result_pathway_only_left$forest_plot
brain_lasso_pathway_only_left <- brain_result_pathway_only_left$lasso_plot

lung_result_pathway_only_left <- results[["lung"]]
lung_res_pathway_only_left <- lung_result_pathway_only_left$res
lung_forest_plot_pathway_only_left <- lung_result_pathway_only_left$forest_plot
lung_lasso_pathway_only_left <- lung_result_pathway_only_left$lasso_plot

perit_result_pathway_only_left <- results[["perit"]]
perit_res_pathway_only_left <- perit_result_pathway_only_left$res
perit_forest_plot_pathway_only_left <- perit_result_pathway_only_left$forest_plot
perit_lasso_plot_pathway_only_left <- perit_result_pathway_only_left$lasso_plot

repr_result_pathway_only_left <- results[["repr"]]
repr_res_pathway_only_left <- repr_result_pathway_only_left$res
repr_forest_plot_pathway_only_left <- repr_result_pathway_only_left$forest_plot
repr_lasso_plot_pathway_only_left <- repr_result_pathway_only_left$lasso_plot

all_res_pathway_only_left$Site <- "All"
bone_res_pathway_only_left$Site <- "Bone"
liver_res_pathway_only_left$Site <- "Liver"
brain_res_pathway_only_left$Site <- "Brain"
lung_res_pathway_only_left$Site <- "Lung"
perit_res_pathway_only_left$Site <- "Peritoneum"
repr_res_pathway_only_left$Site <- "Reproductive"

liver_res_pathway_only_left <- add_gene_column(liver_res_pathway_only_left)
bone_res_pathway_only_left <- add_gene_column(bone_res_pathway_only_left)
all_res_pathway_only_left <- add_gene_column(all_res_pathway_only_left)
lung_res_pathway_only_left <- add_gene_column(lung_res_pathway_only_left)
perit_res_pathway_only_left <- add_gene_column(perit_res_pathway_only_left)
repr_res_pathway_only_left <- add_gene_column(repr_res_pathway_only_left)
brain_res_pathway_only_left <- add_gene_column(brain_res_pathway_only_left)

volcano_plot_pathway_only_left <- rbind(all_res_pathway_only_left, bone_res_pathway_only_left, liver_res_pathway_only_left, lung_res_pathway_only_left, perit_res_pathway_only_left, repr_res_pathway_only_left, brain_res_pathway_only_left)

volcano_plot_pathway_only_left$neg_log_pvalue <- -log10(volcano_plot_pathway_only_left$p.value)
volcano_plot_pathway_only_left <- volcano_plot_pathway_only_left %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_pathway_only_left$gene <- ifelse(volcano_plot_pathway_only_left$gene == "sidedness_mptRectum", "Rectum", volcano_plot_pathway_only_left$gene)
pathway_only_data_left <- volcano_plot_pathway_only_left

pathway_only_left_plot <- ggplot(data = volcano_plot_pathway_only_left, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
     scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  # Set log scale for x-axis
  geom_text_repel(data = subset(volcano_plot_pathway_only_left, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_left/pathways_only_left_volc_plot.pdf",
  plot = pathway_only_left_plot,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_left/pathways_only_left_volc_plot.png",
  plot = pathway_only_left_plot,width = 5,  height = 4,  units = "in", dpi = 900)
forest_plots_list <- list(
  all_forest_plot_pathway_only_left,
  repr_forest_plot_pathway_only_left,
  perit_forest_plot_pathway_only_left,
  liver_forest_plot_pathway_only_left,
  lung_forest_plot_pathway_only_left,
  brain_forest_plot_pathway_only_left,
  bone_forest_plot_pathway_only_left
)

pathway_names <- c("all","repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_left/", pathway_names[i], "_forest_plot_pathway_only_left.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_left/", pathway_names[i], "_forest_plot_pathway_only_left.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### Pathway Only Right

```{r}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(sidedness_mpt == "Right") %>% filter(os_evaluable ==TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- pathway_GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(sidedness_mpt== "Right") %>% filter(os_evaluable)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)




GAM_ttm <- pathway_GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
    selected_columns <- c(rownames(final_genes))
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("any","liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot

all_result_pathway_only_right <- results[["any"]]
all_res_pathway_only_right <- all_result_pathway_only_right$res
all_forest_plot_pathway_only_right <- all_result_pathway_only_right$forest_plot
all_lasso_plot_pathway_only_right <- all_result_pathway_only_right$lasso_plot

bone_result_pathway_only_right <- results[["bone"]]
bone_res_pathway_only_right <- bone_result_pathway_only_right$res
bone_forest_plot_pathway_only_right <- bone_result_pathway_only_right$forest_plot
bone_lasso_plot_pathway_only_right <- bone_result_pathway_only_right$lasso_plot

liver_result_pathway_only_right <- results[["liver"]]
liver_res_pathway_only_right <- liver_result_pathway_only_right$res
liver_forest_plot_pathway_only_right <- liver_result_pathway_only_right$forest_plot
liver_lasso_plot_pathway_only_right <- liver_result_pathway_only_right$lasso_plot

brain_result_pathway_only_right <- results[["brain"]]
brain_res_pathway_only_right <- brain_result_pathway_only_right$res
brain_forest_plot_pathway_only_right <- brain_result_pathway_only_right$forest_plot
brain_lasso_pathway_only_right <- brain_result_pathway_only_right$lasso_plot

lung_result_pathway_only_right <- results[["lung"]]
lung_res_pathway_only_right <- lung_result_pathway_only_right$res
lung_forest_plot_pathway_only_right <- lung_result_pathway_only_right$forest_plot
lung_lasso_pathway_only_right <- lung_result_pathway_only_right$lasso_plot

perit_result_pathway_only_right <- results[["perit"]]
perit_res_pathway_only_right <- perit_result_pathway_only_right$res
perit_forest_plot_pathway_only_right <- perit_result_pathway_only_right$forest_plot
perit_lasso_plot_pathway_only_right <- perit_result_pathway_only_right$lasso_plot

repr_result_pathway_only_right <- results[["repr"]]
repr_res_pathway_only_right <- repr_result_pathway_only_right$res
repr_forest_plot_pathway_only_right <- repr_result_pathway_only_right$forest_plot
repr_lasso_plot_pathway_only_right <- repr_result_pathway_only_right$lasso_plot

all_res_pathway_only_right$Site <- "All"
bone_res_pathway_only_right$Site <- "Bone"
liver_res_pathway_only_right$Site <- "Liver"
brain_res_pathway_only_right$Site <- "Brain"
lung_res_pathway_only_right$Site <- "Lung"
perit_res_pathway_only_right$Site <- "Peritoneum"
repr_res_pathway_only_right$Site <- "Reproductive"

liver_res_pathway_only_right <- add_gene_column(liver_res_pathway_only_right)
bone_res_pathway_only_right <- add_gene_column(bone_res_pathway_only_right)
all_res_pathway_only_right <- add_gene_column(all_res_pathway_only_right)
lung_res_pathway_only_right <- add_gene_column(lung_res_pathway_only_right)
perit_res_pathway_only_right <- add_gene_column(perit_res_pathway_only_right)
repr_res_pathway_only_right <- add_gene_column(repr_res_pathway_only_right)
brain_res_pathway_only_right <- add_gene_column(brain_res_pathway_only_right)


volcano_plot_pathway_only_right <- rbind(all_res_pathway_only_right, bone_res_pathway_only_right, liver_res_pathway_only_right, lung_res_pathway_only_right, perit_res_pathway_only_right, repr_res_pathway_only_right, brain_res_pathway_only_right)


volcano_plot_pathway_only_right$neg_log_pvalue <- -log10(volcano_plot_pathway_only_right$p.value)
volcano_plot_pathway_only_right <- volcano_plot_pathway_only_right %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_pathway_only_right$gene <- ifelse(volcano_plot_pathway_only_right$gene == "sidedness_mptRectum", "Rectum", volcano_plot_pathway_only_right$gene)
pathway_only_data_right <- volcano_plot_pathway_only_right

pathway_only_right_plot <- ggplot(data = volcano_plot_pathway_only_right, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
     scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  # Set log scale for x-axis
  geom_text_repel(data = subset(volcano_plot_pathway_only_right, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_right/pathways_only_right_volc_plot.pdf",
  plot = pathway_only_right_plot,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_right/pathways_only_right_volc_plot.png",
  plot = pathway_only_right_plot,width = 5,  height = 4,  units = "in", dpi = 900)

forest_plots_list <- list(
  all_forest_plot_pathway_only_right,
  repr_forest_plot_pathway_only_right,
  perit_forest_plot_pathway_only_right,
  liver_forest_plot_pathway_only_right,
  lung_forest_plot_pathway_only_right,
  brain_forest_plot_pathway_only_right,
  bone_forest_plot_pathway_only_right
)

pathway_names <- c("all","repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_right/", pathway_names[i], "_forest_plot_pathway_only_right.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_right/", pathway_names[i], "_forest_plot_pathway_only_right.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### Pathway Only Rectum

```{r}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(sidedness_mpt == "Rectum") %>% filter(os_evaluable==TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- pathway_GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv(x$any_ttm - x$from_sequencing_to_ttm_interval_months, x[[paste(site_name, "_ttm", sep = "")]],x[[paste(site_name, "_ttm_event", sep = "")]])

cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15)
#plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
  # Split data into training and test sets
  train_data <- xy[folds != fold, ]
  test_data <- xy[folds == fold, ]
  train_obj <- temp.obj[folds != fold]
  test_obj <- temp.obj[folds == fold]

  # Fit the Cox model
  cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)

  # Extract coefficients
  coefficients <- coef(cox_model, s = "lambda.min")

  # Store results in the data frame
 coefficients <- as.matrix(coefficients)
 
 coefficients_df <- cbind(coefficients_df, c( coefficients))
 

}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
  geom_point() +
geom_text_repel(
    box.padding = 0.5,   # Adjust box.padding to control label position
    force = 10,          # Adjust force to control label repelling strength
    min.segment.length = 0.1,  # Adjust min.segment.length to control line length
    segment.color = "grey50",  # Adjust segment.color for line color
    data = subset(coefficients_df)) +
     labs(title = "Scatter Plot of Count vs Average",
       x = "Average",
       y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
lasso_plot<-ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
  geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
  geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
  labs(title = "Coefficients vs. Variables",
       x = "Variable",
       y = "Coefficient") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)

 
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter(sidedness_mpt== "Rectum") %>% filter(os_evaluable==TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = "") )
left_trunc <- na.omit(left_trunc)




GAM_ttm <- pathway_GAM_final



    
    
    
    
    selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed
    GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]
    
    colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
    GAM_ttm <- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
    
    GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
    selected_columns <- c(rownames(final_genes))
    formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, ",paste(site_name, "_ttm", sep = ""), ", ", paste(site_name, "_ttm_event", sep = ""), ") ~", paste(selected_columns, collapse = "+")))

    
    # Fit the Cox proportional hazards model
    res.cox <- coxph(formula, data = GAM_ttm)
    res.cox.summary <- summary(res.cox)
    res <- as.data.frame(res.cox.summary$conf.int)
    res_temp <- as.data.frame(res.cox.summary$coefficients)
    res$p.value <- res_temp$`Pr(>|z|)`
    rm(res_temp)
    res <- res[-2]
    names(res) <- c("HR", "Lower", "Upper", "p.value")                          
    
    res <- res[order(res$p.value), ]
    top_genes <- res %>% filter(Lower !=0)
    top_genes$p.value <- round(top_genes$p.value, 3)
    
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list(lasso_plot = lasso_plot, res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("any","liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot
all_result_pathway_only_rectum <- results[["any"]]
all_res_pathway_only_rectum <- all_result_pathway_only_rectum$res
all_forest_plot_pathway_only_rectum <- all_result_pathway_only_rectum$forest_plot
all_lasso_plot_pathway_only_rectum <- all_result_pathway_only_rectum$lasso_plot

bone_result_pathway_only_rectum <- results[["bone"]]
bone_res_pathway_only_rectum <- bone_result_pathway_only_rectum$res
bone_forest_plot_pathway_only_rectum <- bone_result_pathway_only_rectum$forest_plot
bone_lasso_plot_pathway_only_rectum <- bone_result_pathway_only_rectum$lasso_plot

liver_result_pathway_only_rectum <- results[["liver"]]
liver_res_pathway_only_rectum <- liver_result_pathway_only_rectum$res
liver_forest_plot_pathway_only_rectum <- liver_result_pathway_only_rectum$forest_plot
liver_lasso_plot_pathway_only_rectum <- liver_result_pathway_only_rectum$lasso_plot

brain_result_pathway_only_rectum <- results[["brain"]]
brain_res_pathway_only_rectum <- brain_result_pathway_only_rectum$res
brain_forest_plot_pathway_only_rectum <- brain_result_pathway_only_rectum$forest_plot
brain_lasso_pathway_only_rectum <- brain_result_pathway_only_rectum$lasso_plot

lung_result_pathway_only_rectum <- results[["lung"]]
lung_res_pathway_only_rectum <- lung_result_pathway_only_rectum$res
lung_forest_plot_pathway_only_rectum <- lung_result_pathway_only_rectum$forest_plot
lung_lasso_pathway_only_rectum <- lung_result_pathway_only_rectum$lasso_plot

perit_result_pathway_only_rectum <- results[["perit"]]
perit_res_pathway_only_rectum <- perit_result_pathway_only_rectum$res
perit_forest_plot_pathway_only_rectum <- perit_result_pathway_only_rectum$forest_plot
perit_lasso_plot_pathway_only_rectum <- perit_result_pathway_only_rectum$lasso_plot

repr_result_pathway_only_rectum <- results[["repr"]]
repr_res_pathway_only_rectum <- repr_result_pathway_only_rectum$res
repr_forest_plot_pathway_only_rectum <- repr_result_pathway_only_rectum$forest_plot
repr_lasso_plot_pathway_only_rectum <- repr_result_pathway_only_rectum$lasso_plot

all_res_pathway_only_rectum$Site <- "All"
bone_res_pathway_only_rectum$Site <- "Bone"
liver_res_pathway_only_rectum$Site <- "Liver"
brain_res_pathway_only_rectum$Site <- "Brain"
lung_res_pathway_only_rectum$Site <- "Lung"
perit_res_pathway_only_rectum$Site <- "Peritoneum"
repr_res_pathway_only_rectum$Site <- "Reproductive"

liver_res_pathway_only_rectum <- add_gene_column(liver_res_pathway_only_rectum)
bone_res_pathway_only_rectum <- add_gene_column(bone_res_pathway_only_rectum)
all_res_pathway_only_rectum <- add_gene_column(all_res_pathway_only_rectum)
lung_res_pathway_only_rectum <- add_gene_column(lung_res_pathway_only_rectum)
perit_res_pathway_only_rectum <- add_gene_column(perit_res_pathway_only_rectum)
repr_res_pathway_only_rectum <- add_gene_column(repr_res_pathway_only_rectum)
brain_res_pathway_only_rectum <- add_gene_column(brain_res_pathway_only_rectum)



volcano_plot_pathway_only_rectum <- rbind(all_res_pathway_only_rectum, bone_res_pathway_only_rectum, liver_res_pathway_only_rectum, lung_res_pathway_only_rectum, perit_res_pathway_only_rectum, repr_res_pathway_only_rectum, brain_res_pathway_only_rectum)


volcano_plot_pathway_only_rectum$neg_log_pvalue <- -log10(volcano_plot_pathway_only_rectum$p.value)
volcano_plot_pathway_only_rectum <- volcano_plot_pathway_only_rectum %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_pathway_only_rectum$gene <- ifelse(volcano_plot_pathway_only_rectum$gene == "sidedness_mptRectum", "Rectum", volcano_plot_pathway_only_rectum$gene)
pathway_only_data_rectum <- volcano_plot_pathway_only_rectum

pathway_only_rectum_plot <- ggplot(data = volcano_plot_pathway_only_rectum, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
     scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  # Set log scale for x-axis
  geom_text_repel(data = subset(volcano_plot_pathway_only_rectum, p.value < 0.051), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_rectum/pathways_only_rectum_volc_plot.pdf",
  plot = pathway_only_rectum_plot,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/Pathways_rectum/pathways_only_rectum_volc_plot.png",
  plot = pathway_only_rectum_plot,width = 5,  height = 4,  units = "in", dpi = 900)

forest_plots_list <- list(
  all_forest_plot_pathway_only_rectum,
  repr_forest_plot_pathway_only_rectum,
  perit_forest_plot_pathway_only_rectum,
  liver_forest_plot_pathway_only_rectum,
  lung_forest_plot_pathway_only_rectum,
  brain_forest_plot_pathway_only_rectum,
  bone_forest_plot_pathway_only_rectum
)

pathway_names <- c("all","repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_rectum/", pathway_names[i], "_forest_plot_pathway_only_rectum.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/Pathways_rectum/", pathway_names[i], "_forest_plot_pathway_only_rectum.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}

```

**Conclusions**: The prognostic stratification and metastatic patterns of patients with MSS CRC is better described by the interplay of the sidedness and the genetic profile. Genetic alterations seem less impactful in patients with rectal cancers.

\

Genes Only Univariate

```{r, warning=FALSE}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(sidedness_mpt == "Rectum") %>% filter(os_evaluable == TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 3)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
covariates <- selected_columns
covariates <- selected_columns[selected_columns != "SAMPLE_ID"]

univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste0('Surv( any_ttm-from_sequencing_to_ttm_interval_months,', paste(site_name, '_ttm', sep = ''), ',', paste(site_name, '_ttm_event', sep = ''),' ) ~ `',x, '`')))

print(dim(GAM_ttm))
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = GAM_ttm)})
# Extract data 
univ_results <- lapply(univ_models,
                        function(x){ 
                            x <- summary(x)
                            p.value<-signif(x$wald["pvalue"], digits=2)
                            wald.test<-signif(x$wald["test"], digits=2)
                            beta<-signif(x$coef[1], digits=2);#coeficient beta
                            HR <-signif(x$coef[2], digits=2);#exp(beta)
                            HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                            HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                            HR <- paste0(HR) 
                            Lower<-paste0(HR.confint.lower) 
                            Upper<-paste0(HR.confint.upper)
                            res<-c(beta, HR, Lower, Upper, wald.test, p.value)
                            names(res)<-c("beta", "HR","Lower", "Upper", "wald.test", 
                                          "p.value")
                            return(res)
                            #return(exp(cbind(coef(x),confint(x))))
                        })
 res <- t(as.data.frame(univ_results, check.names = FALSE))
 res<-as.data.frame(res)
 res <- res %>% select(HR, Lower, Upper, p.value)
 names(res) <- c("HR", "Lower", "Upper", "p.value")                          
 res <- res[order(res$p.value), ]
  res$HR<- as.numeric(res$HR)
res$Lower<- as.numeric(res$Lower)
res$Upper<- as.numeric(res$Upper)
 res <- res[order(res$p.value), ]

res <- res %>% filter(Lower !=0)
if (nrow(res) > 20) {
    # Keep only the top 20 rows
    res <- head(res, 20)
} else {
    # If the data frame has fewer than 20 rows, keep all rows
}
adjusted_p_values <- p.adjust(res$p.value, method = "fdr")
 res$p.value <- adjusted_p_values 
  res <- res[order(res$p.value), ]

     top_genes <- res

top_genes$p.value <- round(top_genes$p.value, 3)
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list( res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("any","liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot
all_result_genes_only_left1 <- results[["any"]]
all_res_genes_only_left1 <- all_result_genes_only_left1$res
all_forest_plot_genes_only_left1 <- all_result_genes_only_left1$forest_plot

bone_result_genes_only_left1 <- results[["bone"]]
bone_res_genes_only_left1 <- bone_result_genes_only_left1$res
bone_forest_plot_genes_only_left1 <- bone_result_genes_only_left1$forest_plot

liver_result_genes_only_left1 <- results[["liver"]]
liver_res_genes_only_left1 <- liver_result_genes_only_left1$res
liver_forest_plot_genes_only_left1 <- liver_result_genes_only_left1$forest_plot

brain_result_genes_only_left1 <- results[["brain"]]
brain_res_genes_only_left1 <- brain_result_genes_only_left1$res
brain_forest_plot_genes_only_left1 <- brain_result_genes_only_left1$forest_plot

lung_result_genes_only_left1 <- results[["lung"]]
lung_res_genes_only_left1 <- lung_result_genes_only_left1$res
lung_forest_plot_genes_only_left1 <- lung_result_genes_only_left1$forest_plot

perit_result_genes_only_left1 <- results[["perit"]]
perit_res_genes_only_left1 <- perit_result_genes_only_left1$res
perit_forest_plot_genes_only_left1 <- perit_result_genes_only_left1$forest_plot

repr_result_genes_only_left1 <- results[["repr"]]
repr_res_genes_only_left1 <- repr_result_genes_only_left1$res
repr_forest_plot_genes_only_left1 <- repr_result_genes_only_left1$forest_plot

all_res_genes_only_left1$Site <- "All"
liver_res_genes_only_left1$Site <- "Liver"
bone_res_genes_only_left1$Site <- "Bone"
brain_res_genes_only_left1$Site <- "Brain"
lung_res_genes_only_left1$Site <- "Lung"
perit_res_genes_only_left1$Site <- "Peritoneum"
repr_res_genes_only_left1$Site <- "Reproductive"

liver_res_genes_only_left1 <- add_gene_column(liver_res_genes_only_left1)
bone_res_genes_only_left1 <- add_gene_column(bone_res_genes_only_left1)
all_res_genes_only_left1 <- add_gene_column(all_res_genes_only_left1)
lung_res_genes_only_left1 <- add_gene_column(lung_res_genes_only_left1)
perit_res_genes_only_left1 <- add_gene_column(perit_res_genes_only_left1)
repr_res_genes_only_left1 <- add_gene_column(repr_res_genes_only_left1)
brain_res_genes_only_left1 <- add_gene_column(brain_res_genes_only_left1)

volcano_plot_genes_only_left1 <- rbind(all_res_genes_only_left1, bone_res_genes_only_left1, liver_res_genes_only_left1, lung_res_genes_only_left1, perit_res_genes_only_left1, repr_res_genes_only_left1, brain_res_genes_only_left1)
volcano_plot_genes_only_left1$neg_log_pvalue <- -log10(volcano_plot_genes_only_left1$p.value)
volcano_plot_genes_only_left1 <- volcano_plot_genes_only_left1 %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_genes_only_left1$gene <- ifelse(volcano_plot_genes_only_left1$gene == "sidedness_mptRectum", "Rectum", volcano_plot_genes_only_left1$gene)
genes_only_data_left1 <- volcano_plot_genes_only_left1
 volcano_plot_genes_only_left1 <- volcano_plot_genes_only_left1[order(volcano_plot_genes_only_left1$p.value), ]

genes_only_left_plot1 <- ggplot(data = volcano_plot_genes_only_left1, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
     scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
  geom_text_repel(data = subset(volcano_plot_genes_only_left1, p.value < 0.055), aes(label = gene), 
                  size = 2.7, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/univariate/genes_only_left_volc_plot.pdf",
  plot = genes_only_left_plot1,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/univariate/genes_only_left_volc_plot.png",
  plot = genes_only_left_plot1,width = 5,  height = 4,  units = "in", dpi = 900)
forest_plots_list <- list(
  all_forest_plot_genes_only_left1,
  repr_forest_plot_genes_only_left1, 
  perit_forest_plot_genes_only_left1, 
  liver_forest_plot_genes_only_left1, 
  lung_forest_plot_genes_only_left1, 
  brain_forest_plot_genes_only_left1, 
  bone_forest_plot_genes_only_left1
)

pathway_names <- c("all","repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/univariate/", pathway_names[i], "_forest_plot_genes_only_left.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/univariate/", pathway_names[i], "_forest_plot_genes_only_left.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

### Pathway Univariate

```{r warning=FALSE}
perform_site_analysis <- function(site_name) {
    left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(sidedness_mpt == "Rectum") %>% filter(os_evaluable==TRUE)
    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing,paste(site_name, "_ttm", sep = ""),paste(site_name, "_ttm_event", sep = ""))
    
    left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- pathway_GAM_final
    
    
    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 3)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
covariates <- selected_columns
covariates <- selected_columns[selected_columns != "SAMPLE_ID"]

univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste0('Surv( any_ttm-from_sequencing_to_ttm_interval_months,', paste(site_name, '_ttm', sep = ''), ',', paste(site_name, '_ttm_event', sep = ''),' ) ~ `',x, '`')))

print(dim(GAM_ttm))
univ_models <- lapply( univ_formulas, function(x){coxph(x, data = GAM_ttm)})
# Extract data 
univ_results <- lapply(univ_models,
                        function(x){ 
                            x <- summary(x)
                            p.value<-signif(x$wald["pvalue"], digits=2)
                            wald.test<-signif(x$wald["test"], digits=2)
                            beta<-signif(x$coef[1], digits=2);#coeficient beta
                            HR <-signif(x$coef[2], digits=2);#exp(beta)
                            HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                            HR.confint.upper <- signif(x$conf.int[,"upper .95"],2)
                            HR <- paste0(HR) 
                            Lower<-paste0(HR.confint.lower) 
                            Upper<-paste0(HR.confint.upper)
                            res<-c(beta, HR, Lower, Upper, wald.test, p.value)
                            names(res)<-c("beta", "HR","Lower", "Upper", "wald.test", 
                                          "p.value")
                            return(res)
                            #return(exp(cbind(coef(x),confint(x))))
                        })
 res <- t(as.data.frame(univ_results, check.names = FALSE))
 res<-as.data.frame(res)
 res <- res %>% select(HR, Lower, Upper, p.value)
 names(res) <- c("HR", "Lower", "Upper", "p.value")                          
 res <- res[order(res$p.value), ]
  res$HR<- as.numeric(res$HR)
res$Lower<- as.numeric(res$Lower)
res$Upper<- as.numeric(res$Upper)
res$p.value<- as.numeric(res$p.value)

 res <- res[order(res$p.value), ]

res <- res %>% filter(Lower !=0)

#adjusted_p_values <- p.adjust(res$p.value, method = "fdr")
 #res$p.value <- adjusted_p_values 
  #res <- res[order(res$p.value), ]

     top_genes <- res

top_genes$p.value <- round(top_genes$p.value, 3)
    top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
forest_plot <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)
    
    return(list( res = res %>% select(HR, p.value), forest_plot = forest_plot))
}

# Call the function for different sites
sites <- c("any","liver","bone", "lung", "brain", "perit", "repr")
results <- list()

for (site in sites) {
    analysis_result <- perform_site_analysis(site)
    results[[site]] <- analysis_result
}

# Accessing the results:
# For example, to access the result for the "bone" site:
# bone_result <- results[["bone"]]
# bone_res <- bone_result$res
# bone_forest_plot <- bone_result$forest_plot
all_result_genes_only_left1 <- results[["any"]]
all_res_genes_only_left1 <- all_result_genes_only_left1$res
all_forest_plot_genes_only_left1 <- all_result_genes_only_left1$forest_plot

bone_result_genes_only_left1 <- results[["bone"]]
bone_res_genes_only_left1 <- bone_result_genes_only_left1$res
bone_forest_plot_genes_only_left1 <- bone_result_genes_only_left1$forest_plot

liver_result_genes_only_left1 <- results[["liver"]]
liver_res_genes_only_left1 <- liver_result_genes_only_left1$res
liver_forest_plot_genes_only_left1 <- liver_result_genes_only_left1$forest_plot

brain_result_genes_only_left1 <- results[["brain"]]
brain_res_genes_only_left1 <- brain_result_genes_only_left1$res
brain_forest_plot_genes_only_left1 <- brain_result_genes_only_left1$forest_plot

lung_result_genes_only_left1 <- results[["lung"]]
lung_res_genes_only_left1 <- lung_result_genes_only_left1$res
lung_forest_plot_genes_only_left1 <- lung_result_genes_only_left1$forest_plot

perit_result_genes_only_left1 <- results[["perit"]]
perit_res_genes_only_left1 <- perit_result_genes_only_left1$res
perit_forest_plot_genes_only_left1 <- perit_result_genes_only_left1$forest_plot

repr_result_genes_only_left1 <- results[["repr"]]
repr_res_genes_only_left1 <- repr_result_genes_only_left1$res
repr_forest_plot_genes_only_left1 <- repr_result_genes_only_left1$forest_plot

all_res_genes_only_left1$Site <- "All"
liver_res_genes_only_left1$Site <- "Liver"
bone_res_genes_only_left1$Site <- "Bone"
brain_res_genes_only_left1$Site <- "Brain"
lung_res_genes_only_left1$Site <- "Lung"
perit_res_genes_only_left1$Site <- "Peritoneum"
repr_res_genes_only_left1$Site <- "Reproductive"

liver_res_genes_only_left1 <- add_gene_column(liver_res_genes_only_left1)
bone_res_genes_only_left1 <- add_gene_column(bone_res_genes_only_left1)
all_res_genes_only_left1 <- add_gene_column(all_res_genes_only_left1)
lung_res_genes_only_left1 <- add_gene_column(lung_res_genes_only_left1)
perit_res_genes_only_left1 <- add_gene_column(perit_res_genes_only_left1)
repr_res_genes_only_left1 <- add_gene_column(repr_res_genes_only_left1)
brain_res_genes_only_left1 <- add_gene_column(brain_res_genes_only_left1)

volcano_plot_genes_only_left1 <- rbind(all_res_genes_only_left1, bone_res_genes_only_left1, liver_res_genes_only_left1, lung_res_genes_only_left1, perit_res_genes_only_left1, repr_res_genes_only_left1, brain_res_genes_only_left1)
volcano_plot_genes_only_left1$neg_log_pvalue <- -log10(volcano_plot_genes_only_left1$p.value)
volcano_plot_genes_only_left1 <- volcano_plot_genes_only_left1 %>% filter(HR > 6.119883e-02) %>% filter(HR < 6)
volcano_plot_genes_only_left1$gene <- ifelse(volcano_plot_genes_only_left1$gene == "sidedness_mptRectum", "Rectum", volcano_plot_genes_only_left1$gene)
genes_only_data_left1 <- volcano_plot_genes_only_left1
 volcano_plot_genes_only_left1 <- volcano_plot_genes_only_left1[order(volcano_plot_genes_only_left1$p.value), ]

genes_only_left_plot1 <- ggplot(data = volcano_plot_genes_only_left1, aes(x = HR, y = neg_log_pvalue, color = Site, fill = Site)) +
  geom_point(size = 2, aes(fill = Site)) +  # Adjust point size as needed
  scale_x_log10(breaks = c(0.25, 0.5, 1, 2, 4), limits = c(0.2, 5)) +  # Set log scale for x-axis with limits
     scale_y_continuous(limits = c(0, 6), breaks = seq(0, 6, 1)) +  
  geom_text_repel(data = subset(volcano_plot_genes_only_left1, p.value < 0.055), aes(label = gene), 
                  size = 2.4, nudge_y = 0.1) +  # Label only points with p-value < 0.051
  labs(x = "HR", y = "-log(P Value)", color = "Site") + scale_color_lancet()+scale_fill_lancet()+
  theme_classic() 

ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/univariate/genes_only_left_volc_plot.pdf",
  plot = genes_only_left_plot1,width = 5,  height = 4,  units = "in", dpi = 900)
ggsave(
  filename = "/Users/krisa/Desktop/Final Figures/univariate/genes_only_left_volc_plot.png",
  plot = genes_only_left_plot1,width = 5,  height = 4,  units = "in", dpi = 900)
forest_plots_list <- list(
  all_forest_plot_genes_only_left1,
  repr_forest_plot_genes_only_left1, 
  perit_forest_plot_genes_only_left1, 
  liver_forest_plot_genes_only_left1, 
  lung_forest_plot_genes_only_left1, 
  brain_forest_plot_genes_only_left1, 
  bone_forest_plot_genes_only_left1
)

pathway_names <- c("all","repr", "perit", "liver", "lung", "brain", "bone")

# Save each forest plot with filenames indicating the pathway and side
for (i in seq_along(forest_plots_list)) {
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/univariate/", pathway_names[i], "_forest_plot_genes_only_left.png"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
  ggsave(
    filename = paste0("/Users/krisa/Desktop/Final Figures/univariate/", pathway_names[i], "_forest_plot_genes_only_left.pdf"),
    plot = forest_plots_list[[i]],
    width = 6,
    height = 6,
    dpi = 900
  )
}
```

After finding significant genes in the time to met cohort, do survival analysis on OS within that group for mutant vs WT of that particular gene. Do OS plots of sidedness as well.

Survival Analysis:

```{r}
#library(survminer)
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(os_evaluable==TRUE)    
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, sidedness_mpt, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, os_event,os, os_m,OS_MONTHS, kras_wt_allele, kras2, lung_ttm, lung_ttm_event )
    
    #left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
left_trunc$kras_wt_allele <-as.factor(left_trunc$kras_wt_allele)
left_trunc$kras2 <-as.factor(left_trunc$kras2)
left_trunc$any_ttm_competing <-as.factor(left_trunc$any_ttm_competing)

    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
dim(GAM_ttm)    
fit1 <- survfit(Surv(any_ttm, any_ttm_event) ~ MYC, data = GAM_ttm)
surv_plot <-ggsurvplot(fit1, data = GAM_ttm, pval = TRUE, conf.int = TRUE, risk.table=TRUE, palette = "lancet",  legend.title = "MYC",  ylab = "Metastasis Probability", legend.labs=c("WT", "Mutant"))

print(surv_plot)
```

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(os_evaluable==TRUE)
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, sidedness_mpt, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, os_event,os, os_m,OS_MONTHS, kras_wt_allele, kras2, lung_ttm, lung_ttm_event, perit_ttm, perit_ttm_event, bone_ttm, bone_ttm_event, brain_ttm, brain_ttm_event,stage, stage_det,stage2, stage3_det )
    
    #left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- pathway_GAM_final
    
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
left_trunc$kras_wt_allele <-as.factor(left_trunc$kras_wt_allele)
left_trunc$kras2 <-as.factor(left_trunc$kras2)
left_trunc$any_ttm_competing <-as.factor(left_trunc$any_ttm_competing)

    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 3)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- pathway_GAM_final[, colnames(pathway_GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
dim(GAM_ttm)
fit1 <- survfit(Surv(brain_ttm, brain_ttm_event) ~ TGFB, data = GAM_ttm)
surv_plot <-ggsurvplot(fit1, data = GAM_ttm, pval = TRUE, conf.int = TRUE, risk.table=TRUE, palette = "lancet",legend.title = "TGFB",facet.by = "sidedness_mpt",legend.labs=c("WT", "Mutant"))

print(surv_plot)
```

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0, any_ttm_event == 0 | any_ttm > 6, best_unique_prim == TRUE, !(diag_to_first_radiology_interval == any_ttm & any_ttm_event == 1)) %>% filter(os_evaluable==TRUE) 
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, sidedness_mpt, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, os_event,os, os_m,OS_MONTHS, kras_wt_allele, kras2, lung_ttm, lung_ttm_event, brain_ttm, brain_ttm_event,perit_ttm, perit_ttm_event,repr_ttm, repr_ttm_event, bone_ttm, bone_ttm_event, stage, stage_det,stage2, stage3_det, kras_clon )
    
    #left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
#left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
left_trunc$kras_wt_allele <-as.factor(left_trunc$kras_wt_allele)
left_trunc$kras2 <-as.factor(left_trunc$kras2)
left_trunc$any_ttm_competing <-as.factor(left_trunc$any_ttm_competing)

    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 3)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
dim(GAM_ttm)
fit1 <- survfit(Surv(any_ttm, any_ttm_event) ~ stage, data = GAM_ttm)
surv_plot <-ggsurvplot(fit1, data = GAM_ttm, pval = TRUE, conf.int = TRUE, facet.by = "sidedness_mpt", risk.table=TRUE, palette = "lancet",legend.title = "BRAF", ylab = "Metastasis probability")

print(surv_plot)
```

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", sample_type3 == "Primary") %>% filter(os_evaluable==TRUE)  
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, sidedness_mpt, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, os_event,os, os_m,OS_MONTHS, kras_wt_allele, kras2, lung_ttm, lung_ttm_event, stage, stage_det,stage2, stage3_det, stage2_det )
    
    #left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
#left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
left_trunc$kras_wt_allele <-as.factor(left_trunc$kras_wt_allele)
left_trunc$kras2 <-as.factor(left_trunc$kras2)
left_trunc$any_ttm_competing <-as.factor(left_trunc$any_ttm_competing)

    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 3)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
dim(GAM_ttm)
fit1 <- survfit(Surv(os, os_event) ~ stage3_det, data = GAM_ttm)
surv_plot <-ggsurvplot(fit1, data = GAM_ttm, pval = TRUE, conf.int = TRUE, risk.table=TRUE,legend.title = "BRAF", palette = "lancet", legend.labs=c("WT", "Mutant"))

print(surv_plot)
```

```{r}
#library(gridExtra)

# Arrange the plots into a grid

temp5<-grid.arrange(kras_ttm, kras_os, myc_ttm, myc_os, braf_ttm, braf_os, pik3ca_ttm, pik3ca_os, apc_ttm, apc_os, tp53_ttm, tp53_os, smad4_ttm, smad4_os, 
            ncol = 2)
ggsave(plot = temp5, filename = "test.pdf", width = 8, height = 19, dpi = 900)
```

```{r}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type") %>% filter(os_evaluable==TRUE)  %>% filter(best_unique_samp == TRUE)
    left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, sidedness_mpt, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, os_event,os, os_m,OS_MONTHS, kras_wt_allele, kras2, lung_ttm, lung_ttm_event, stage, stage_det,stage2, stage3_det, stage2_det )
    
    #left_trunc <- na.omit(left_trunc)
    
    GAM_ttm <- GAM_final
    
#left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
left_trunc$kras_wt_allele <-as.factor(left_trunc$kras_wt_allele)
left_trunc$kras2 <-as.factor(left_trunc$kras2)
left_trunc$any_ttm_competing <-as.factor(left_trunc$any_ttm_competing)

    percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 3)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
selected_columns <- selected_columns[selected_columns != "AGO2"] ########
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
dim(GAM_ttm)
fit1 <- survfit(Surv(os, os_event) ~ stage2_det, data = GAM_ttm)
surv_plot <-ggsurvplot(fit1, data = GAM_ttm, pval = TRUE, conf.int = TRUE, risk.table=TRUE,legend.title = "Stage", palette = "lancet", legend.labs=c("1", "2", "3", "4"))

print(surv_plot)
```

repeat with whole cohort

perhaps filter purity \>=20?

"The higher rate of[distant metastases](https://www.sciencedirect.com/topics/medicine-and-dentistry/distant-metastasis "Learn more about distant metastases from ScienceDirect's AI-generated Topic Pages")in rectal cancer can be explained by the venous drainage of the rectum bypassing the liver straight into the[inferior vena cava](https://www.sciencedirect.com/topics/medicine-and-dentistry/inferior-vena-cava "Learn more about inferior vena cava from ScienceDirect's AI-generated Topic Pages")." Hugen N, van de Velde CJH, de Wilt JHW, Nagtegaal ID. Metastatic pattern in colorectal cancer is strongly influenced by histological subtype. Ann Oncol. 2014 Mar;25(3):651-657. also, rectum lacks serosa

kras_ttm

kras_os myc_os braf_ttm braf_os pik3ca_os, pik3ca_ttm apc_os apc_ttm tp53_os (only) smad4_os smad4_ttm, kras_sided_ttm

# Metastatic Burden

```{r, warning=FALSE}

percentage_ones <- colMeans(GAM_final == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 1)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]
GAM_ttm <- pathway_GAM_final

metastatic_burden_corr <-  my_data_frame_final%>% filter(best_unique_samp== TRUE)%>% mutate(total = ifelse(total >= 7, 6, total))%>% filter(sample_type3 =="Metastasis")
calculate_alteration_percent <- function(total_count, metastatic_burden_corr, Pathway_GAM) {
  # Filter MSS Primary
  MSS_primary <- metastatic_burden_corr %>%
    filter(total == total_count) %>%
    pull(SAMPLE_ID)
  
  # Filter MSS Primary GAM
  MSS_primary_GAM <- Pathway_GAM[Pathway_GAM$Samples %in% MSS_primary, ]
  
  # Convert GAM to stats
  MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats[1,]
MSS_primary_stats <- MSS_primary_stats[-1, ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats$Gene <-rownames(MSS_primary_stats)# rename rownames to Genes

MSS_primary_stats <- MSS_primary_stats %>% select(Gene, MSS_pri_Alt_per)

  return(MSS_primary_stats)
}
# Create an empty dataframe to store the results
combined_df <- data.frame(Gene = character(0))

# Iterate through total counts from 0 to 8
for (total_count in 1:6) {
  # Calculate alteration percent for the current total count
  MSS_primary_stats <- calculate_alteration_percent(total_count, metastatic_burden_corr, GAM_ttm)
  
  # Rename the MSS_pri_Alt_per column
  colnames(MSS_primary_stats)[2] <- paste0("Burden_", total_count)
  
  # Bind the MSS_pri_Alt_per column to the combined dataframe
  if (nrow(combined_df) == 0) {
    # If the combined dataframe is empty, directly add the MSS_pri_Alt_per column
    combined_df <- MSS_primary_stats
  } else {
    # If the combined dataframe already contains data, merge it with the new MSS_pri_Alt_per column
    combined_df <- merge(combined_df, MSS_primary_stats, by = "Gene", all = TRUE)
  }
}

# View the combined dataframe
#view(combined_df)
correlations <- numeric(nrow(combined_df))
p_values <- numeric(nrow(combined_df))
spearman <- numeric(nrow(combined_df))
upper <- numeric(nrow(combined_df))
lower <- numeric(nrow(combined_df))
x <- c(1, 2, 3, 4, 5, 6)

# Loop through each gene
for (i in 1:nrow(combined_df)) {
  gene_data <- unlist(combined_df[i, 2:7])  # Extract data for the current gene
  correlation <- cor.test(x, gene_data, method = "spearman")
  correlation_result <- SpearmanRho(x, gene_data, conf.level = 0.95)
  
  correlations[i] <- correlation$estimate  # Store the correlation value
  p_values[i] <- correlation$p.value  # Store the p-value
  spearman[i] <- correlation_result[[1]]
  upper[i]<- correlation_result[[2]]
  lower[i]<- correlation_result[[3]]
}

# Create a new data frame with gene names, correlation values, p-values, and confidence intervals
burden_results <- data.frame(
  Gene = combined_df$Gene,
  Spearman_Correlation = correlations,
  P_Value = p_values,
  spearmanrho = spearman,
  upper = upper,
  lower = lower
  
)
burden_results <- burden_results[order(burden_results$P_Value), ]
#burden_results <- head(burden_results, 15)
#adjusted_p_values <- p.adjust(burden_results$P_Value, method = "fdr")

# Add the adjusted p-values to combined_df
#burden_results$P_Value <- adjusted_p_values
burden_results$P_Value <- round(burden_results$P_Value, 3)

burden_results$P_Value <- ifelse(burden_results$P_Value == 0, "<0.001", burden_results$P_Value)
burden_results$` ` <- paste(rep(" ", 20), collapse = " ")
burden_results$`rho (95% CI)` <- ifelse(is.na(burden_results$spearmanrho), "",
                             sprintf("%.2f (%.2f to %.2f)",
                                     burden_results$spearmanrho, burden_results$lower, burden_results$upper))
burden_results <- burden_results[order(burden_results$P_Value), ]

p<-forest(burden_results[,c(1,8,7,3)],
       est = burden_results$spearmanrho,
       lower=burden_results$lower,
       upper = burden_results$upper,
       ci_column = 3,
       ref_line =0,
       xlim=c(-1,1),
       ticks_at = c(-1,-0.5, 0 , 0.5, 1))
       
 p     
```

(best_prim_samp ==TRUE) GENE+PATHWAY report min, avg, max freq using table

0 1 2 3 4 5 6

1148 816 778 553 404 182 112

overall ,left, right, rectum (early stage ttm cohort) GENE+PATHWAY (ma

overall ,left, right, rectum (best_samp ==TRUE) GENE+PATHWAY

0 1 2 3 4 5 6

55 315 421 396 268 153 81

surv plot of burden

```{r}
my_data_frame_final <- temp5
my_data_frame_final <- my_data_frame_final %>% filter(sidedness_mpt == "Rectum")
df <- my_data_frame_final %>% filter(best_unique_prim==TRUE)%>% mutate(total = ifelse(total >= 7, 6, total)) %>% filter(tmb2 <30) %>% filter(tmb2 > 0)
df <- df[complete.cases(df$total), ]

# Calculate Spearman correlation and p-value
 my_colors <- c("#800080")
 # Adjust transparency levels
 transparency <- c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7)
 
 # Apply transparency to colors
 my_colors_transparent <- paste0(my_colors, sprintf("%02X", round(255 * transparency)))
 print("TMB pri:")
 cor.test(df$tmb2, df$total, method = "spearman")

 tmb_pri<-ggplot(df, aes(x = as.factor(total), y = tmb2, fill = as.factor(total))) +
     geom_violin() +  # No need to specify fill color here
     geom_boxplot(width = 0.5) +
     scale_fill_manual(values = my_colors_transparent) +  # Apply custom fill colors
     labs(x = "Burden", y = "TMB")+theme_pubr(base_size = 10)+theme(legend.position = "none")
 
 
df <- my_data_frame_final %>% filter(best_unique_samp==TRUE)%>%filter(sample_type3=="Metastasis")%>% mutate(total = ifelse(total >= 7, 6, total)) %>% filter(tmb2 <30) %>% filter(tmb2 > 0) %>% filter(total >0)
df <- df[complete.cases(df$total), ]
 print("TMB met:")
 cor.test(df$tmb2, df$total, method = "spearman")

 tmb_met<-ggplot(df, aes(x = as.factor(total), y = tmb2, fill = as.factor(total))) +
     geom_violin() +  # No need to specify fill color here
     geom_boxplot(width = 0.5) +
     scale_fill_manual(values = my_colors_transparent) +  # Apply custom fill colors
     labs(x = "Burden", y = "TMB")+theme_pubr(base_size = 10)+theme(legend.position = "none")
 
  my_colors <- c("#008080")
  transparency <- c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7)
 
 # Apply transparency to colors
 my_colors_transparent <- paste0(my_colors, sprintf("%02X", round(255 * transparency)))
 
  print("FGA met:")
  cor.test(df$fga, df$total, method = "spearman")

  fga_met<-ggplot(df, aes(x = as.factor(total), y = fga, fill = as.factor(total))) +
     geom_violin() +  # No need to specify fill color here
     geom_boxplot(width = 0.5) +
     scale_fill_manual(values = my_colors_transparent) +  # Apply custom fill colors
     labs(x = "Burden", y = "FGA")+theme_pubr(base_size = 10)+theme(legend.position = "none")
  print("FFGA met:")
  cor.test(df$facets_fga, df$total, method = "spearman")
  
  ffga_met<-ggplot(df, aes(x = as.factor(total), y = facets_fga, fill = as.factor(total))) +
     geom_violin() +  # No need to specify fill color here
     geom_boxplot(width = 0.5) +
     scale_fill_manual(values = my_colors_transparent) +  # Apply custom fill colors
     labs(x = "Burden", y = "FACETS FGA")+theme_pubr(base_size = 10)+theme(legend.position = "none")
  print("FFGA met:")
  cor.test(df$facets_fga, df$total, method = "spearman")

  df <- my_data_frame_final %>% filter(best_unique_prim==TRUE)%>% mutate(total = ifelse(total >= 7, 6, total)) %>% filter(tmb2 <30) %>% filter(tmb2 > 0)
df <- df[complete.cases(df$total), ]
  fga_pri<-ggplot(df, aes(x = as.factor(total), y = fga, fill = as.factor(total))) +
     geom_violin() +  # No need to specify fill color here
     geom_boxplot(width = 0.5) +
     scale_fill_manual(values = my_colors_transparent) +  # Apply custom fill colors
     labs(x = "Burden", y = "FGA")+theme_pubr(base_size = 10)+theme(legend.position = "none")
  print("FGA pri:")
  cor.test(df$fga, df$total, method = "spearman")
ffga_pri<-ggplot(df, aes(x = as.factor(total), y = facets_fga, fill = as.factor(total))) +
     geom_violin() +  # No need to specify fill color here
     geom_boxplot(width = 0.5) +
     scale_fill_manual(values = my_colors_transparent) +  # Apply custom fill colors
     labs(x = "Burden", y = "FACETS FGA")+theme_pubr(base_size = 10)+theme(legend.position = "none")
  print("FFGA pri:")
  cor.test(df$facets_fga, df$total, method = "spearman")
 grid.arrange(tmb_pri, tmb_met, fga_pri, fga_met,ffga_pri, ffga_met, ncol = 2)

```

```{r}
metastatic_burden_corr_surv <-  my_data_frame_final%>% filter(best_unique_prim== TRUE)%>%filter(os_evaluable == TRUE) %>% mutate(total = ifelse(total >= 7, 6, total))#%>%filter(sidedness_mpt == "Rectum") #%>% filter(sample_type3 =="Metastasis")

dim(metastatic_burden_corr_surv)
fit1 <- survfit(Surv(os, os_event) ~ total, data = metastatic_burden_corr_surv)
surv_plot <-ggsurvplot(fit1, data = metastatic_burden_corr_surv, pval = TRUE, conf.int = TRUE, risk.table=TRUE,legend.title = "Burden", legend.labs=c(0,1,2,3,4,5,6) ,palette = "lancet")

print(surv_plot)
```

Right sided was strongly associated with lower OS (HR=1.41, p\<0.001) whereas Rectum was associated with slighly longer OS (HR:0.88, p=0.083). (this can go in thesis directly).

# Matched

```{r}
results_df <- clinical_final %>%
  group_by(PATIENT_ID) %>%
  filter(n() >= 2)
# Split the dataframe into two dataframes
results_pri <- results_df %>%
  filter(sample_type3 == "Primary")

results_met <- results_df %>%
  filter(sample_type3 == "Metastasis")

common_patient_ids <- intersect(results_pri$PATIENT_ID, results_met$PATIENT_ID)

# Filter the dataframes to keep only the common IDs
common_results_pri <- results_pri %>%
  filter(PATIENT_ID %in% common_patient_ids)

common_results_met <- results_met %>%
  filter(PATIENT_ID %in% common_patient_ids)
common_results_pri <- common_results_pri %>%
  group_by(PATIENT_ID) %>%
  arrange(desc(purity)) %>%
  slice(1) %>%
  ungroup()

# For common_results_met
common_results_met <- common_results_met %>%
  group_by(PATIENT_ID) %>%
  arrange(desc(purity)) %>%
  slice(1) %>%
  ungroup()
results_df <- bind_rows(common_results_pri, common_results_met)
rm(common_results_met)
rm(common_patient_ids)
rm(common_results_pri)
rm(results_met)
rm(results_pri)
GAM_matched_final <- GAM_final %>% filter(Samples %in% results_df$SAMPLE_ID)
results_df$sample_type3 <- factor(results_df$sample_type3, levels = c("Primary", "Metastasis"))



# Perform Statistical Test (Wilcoxon rank-sum test)
wilcox_test <- wilcox.test(purity ~ sample_type3, data = results_df)
print(wilcox_test)
```

tmb:0.00718 (5.69, 6.67)

fga p=5.779e-10 (0.19 vs 0.31)

facets_fga= 9.165e-06 (0.57, 0.69)

purity = 9.165e-06 (33.82, 42.75)

facets_purity = 5.293e-10 (0.44, 0.58)

```{r}


# Create individual plots
plot1 <- ggplot(results_df, aes(x = sample_type3, y = purity, fill = sample_type3)) +
  geom_boxplot() +
  labs(x = NULL, y = "Purity") +theme_pubr(base_size = 10) + scale_color_lancet() + scale_fill_lancet() + theme(legend.position = "none")

plot2 <- ggplot(results_df, aes(x = sample_type3, y = facets_purity, fill = sample_type3)) +
  geom_boxplot() +
  labs(x = NULL, y = "FACETS Purity") +theme_pubr(base_size = 10) + scale_color_lancet() + scale_fill_lancet()+ theme(legend.position = "none")

plot3 <- ggplot(results_df, aes(x = sample_type3, y = tmb2, fill = sample_type3)) +
  geom_boxplot() +
  labs(x = NULL, y = "TMB") +theme_pubr(base_size = 10) + scale_color_lancet() + scale_fill_lancet()+ theme(legend.position = "none")


plot5 <- ggplot(results_df, aes(x = sample_type3, y = facets_fga, fill = sample_type3)) +
  geom_boxplot() +
  labs(x = NULL, y = "FACETS FGA") +theme_pubr(base_size = 10) + scale_color_lancet() + scale_fill_lancet()+ theme(legend.position = "none")

plot6 <- ggplot(results_df, aes(x = sample_type3, y = fga, fill = sample_type3)) +
  geom_boxplot() +
  labs(x = NULL, y = "FGA") +theme_pubr(base_size = 10) + scale_color_lancet() + scale_fill_lancet()+ theme(legend.position = "none")

# Arrange plots in a single figure
combined_plot <- plot1 + plot2 + plot3  + plot5 + plot6

# Display the combined plot
print(combined_plot)
```

```{r}
GAM_matched_clonal <- GAM_matched_final %>%rename(NKX3.1 = `NKX3-1`)%>% select("Samples","TP53","APC","KRAS","SMAD4", "PIK3CA", "FBXW7","SOX9","TCF7L2","BCL2L1", "BRAF", "DNMT3B","SRC", "MYC" , "ARID1A" , "CDK8",  "PMAIP1" ,"RNF43" , "NKX3.1", "YES1",   "KDM6A" , "AGO2","TOP1", "EGFR", "AKT1", "ATM", "PTEN", "NRAS", "SMARCA4", "STK11", "CDKN2A", "ERBB2")
GAM_matched_clonal$PATIENT_ID <- sapply(strsplit(GAM_matched_clonal$Samples, "-"), function(x) paste(x[1], x[2], sep = "-"))
genes <- c("TP53","APC","KRAS","SMAD4", "PIK3CA", "FBXW7","SOX9","TCF7L2","BCL2L1", "BRAF", "DNMT3B","SRC", "MYC" , "ARID1A" , "CDK8",  "PMAIP1" ,"RNF43" , "NKX3.1", "YES1",   "KDM6A" , "AGO2","TOP1", "EGFR", "AKT1", "ATM", "PTEN", "NRAS", "SMARCA4", "STK11", "CDKN2A", "ERBB2")
results <- data.frame(gene = genes, Primary = 0, Shared = 0, Metastasis = 0, n=0)
MSS_primary<-results_df%>%filter(sample_type3 == "Primary")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary<-MSS_primary$SAMPLE_ID
MSS_primary_GAM<-GAM_matched_clonal[GAM_matched_clonal$Samples %in% MSS_primary, ]

MSS_primary_met<-results_df%>%filter(sample_type3 == "Metastasis")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary_met<-MSS_primary_met$SAMPLE_ID
MSS_primary_met_GAM<-GAM_matched_clonal[GAM_matched_clonal$Samples %in% MSS_primary_met, ]


# Function to calculate the proportions
calculate_proportions <- function(df) {
  df <- df[df[2] != 0 | df[3] != 0, ]  # Remove rows with 0s in both columns
  total_samples <- nrow(df)
  
  primary_only <- sum(df[2] == 1 & df[3] == 0) / total_samples
  shared <- sum(df[2] == 1 & df[3] == 1) / total_samples
  metastasis_only <- sum(df[2] == 0 & df[3] == 1) / total_samples
  proportions <- data.frame(
    Primary_Only = primary_only,
    Shared = shared,
    Metastasis_Only = metastasis_only,
    n=total_samples
  )
  
  return(proportions)
}

for (gene in genes){
  GAM_pri <- MSS_primary_GAM %>% select(all_of(c("PATIENT_ID", gene)))
  GAM_met <- MSS_primary_met_GAM %>% select(all_of(c("PATIENT_ID", gene)))
  df <- inner_join(GAM_pri, GAM_met, by="PATIENT_ID")
  df<- na.omit(df)
  proportions <- calculate_proportions(df)
  
  # Find the index of the gene in the results data frame
  gene_index <- which(results$gene == gene)
  
  # Update the proportions in the results data frame
  results[gene_index, "Primary"] <- proportions$Primary_Only
  results[gene_index, "Shared"] <- proportions$Shared
  results[gene_index, "Metastasis"] <- proportions$Metastasis_Only
  results[gene_index, "n"] <- proportions$n

}
results$gene <- paste(results$gene, " n=", results$n)
results_long <- results %>%
  pivot_longer(cols = c(Primary, Shared, Metastasis),
               names_to = "SampleType",
               values_to = "Proportion")
results_long$SampleType <- factor(results_long$SampleType, levels = c("Metastasis", "Shared","Primary"))

myplot<-ggplot(results_long, aes(y = gene, x = Proportion, fill = SampleType)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Primary" = "darkgreen", "Shared" = "darkgoldenrod1", "Metastasis" = "brown")) +
  labs(y = "Genes", x = "Proportion") +
  ggtitle("Proportion of shared and private mutations") +
  theme(legend.title=element_blank()) + theme_pubr()
#ggsave(filename = "my_plot.png", plot = myplot, width = 6, height = 8, dpi = 700)
myplot
```

n= is the number of patients with the mutated gene in any sample.

```{r}
MSS_primary<-results_df%>%filter(sample_type3 == "Primary")%>%dplyr::select(SAMPLE_ID, SAMPLE_TYPE)
MSS_primary <- MSS_primary %>%
  mutate(SAMPLE_ID = paste("mskimpact:", SAMPLE_ID, sep = ""))
MSS_primary_met<-results_df%>%filter(sample_type3 == "Metastasis")%>%dplyr::select(SAMPLE_ID, SAMPLE_TYPE)
MSS_primary_met <- MSS_primary_met %>%
  mutate(SAMPLE_ID = paste("mskimpact:", SAMPLE_ID, sep = ""))
write_csv(MSS_primary, "MSS_primary_matched_final.csv", col_names = TRUE)
write_csv(MSS_primary_met, "MSS_met_matched_final.csv", col_names = TRUE)

```

```{r}
MSS_primary<-results_df%>%filter(sample_type3 == "Primary")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary<-MSS_primary$SAMPLE_ID
#MSS_primary<-intersect(MSS_primary, clinical$`Sample ID`)
MSS_primary_GAM<-pathway_GAM_final[pathway_GAM_final$Samples %in% MSS_primary, ]




#  MET GAM
MSS_primary_met<-results_df%>%filter(sample_type3 == "Metastasis")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary_met<-MSS_primary_met$SAMPLE_ID
#MSS_primary_met<-intersect(MSS_primary_met, clinical$`Sample ID`)
MSS_primary_met_GAM<-pathway_GAM_final[pathway_GAM_final$Samples %in% MSS_primary_met, ]



#MSI Primary
MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats[1,]
MSS_primary_stats <- MSS_primary_stats[-1, ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats <- MSS_primary_stats %>% select(MSS_pri_WT, MSS_pri_Alt, MSS_pri_Alt_per)

#MSS mid primary
MSS_mid_stats<- data.frame(t(MSS_primary_met_GAM)) # transpose, each row = gene 
colnames(MSS_mid_stats)<-MSS_mid_stats[1,]
MSS_mid_stats <- MSS_mid_stats[-1, ]
MSS_mid_stats <- MSS_mid_stats%>%mutate_all(as.numeric) #####

MSS_mid_stats <- MSS_mid_stats %>%mutate(MSS_mid_WT = rowSums(MSS_mid_stats == 0, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt= rowSums(across(!c(MSS_mid_WT))== 1, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt_per = MSS_mid_Alt/(MSS_mid_WT+MSS_mid_Alt))
MSS_mid_stats$MSS_mid_Alt_per[is.nan(MSS_mid_stats$MSS_mid_Alt_per)] <- 0
MSS_mid_stats <- MSS_mid_stats %>% select(MSS_mid_WT, MSS_mid_Alt, MSS_mid_Alt_per)

combined_df <- merge(MSS_primary_stats, MSS_mid_stats, by = "row.names", all = TRUE)
#view(combined_df)
combined_df<- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per) 
colnames(combined_df)[1] <- "Gene" # df with MSS-primary and MSS_mid %Alt
rownames(combined_df)<-combined_df$Gene # rename rownames to Genes


for (gene in row.names(MSS_primary_stats)) {
  # Perform operations using the gene name
  contingency_table<-matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],MSS_mid_stats[[gene, "MSS_mid_Alt"]], MSS_mid_stats[[gene, "MSS_mid_WT"]]), nrow = 2, ncol = 2, byrow = TRUE)
  rownames(contingency_table) <- c("Primary", "Mid")
colnames(contingency_table) <- c("Altered", "Unaltered")
fisher_result <- fisher.test((contingency_table))
p_value <- fisher_result$p.value
combined_df[gene, "p_value"] <- p_value # add p_value to new column in df
mytable <- table(MSS_primary_GAM[, gene], MSS_primary_met_GAM[, gene])
if (dim(table(MSS_primary_GAM[, gene], MSS_primary_met_GAM[, gene]))[1] >1 & dim(table(MSS_primary_GAM[, gene], MSS_primary_met_GAM[, gene]))[2] >1 )
{combined_df[gene, "p_value_Mc"] <- mcnemar.test(mytable, correct = FALSE )$p.value}

}


# Perform multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values


subset_data <- combined_df[order(combined_df$p_value), ]
top_10_genes <- head(subset_data, 10) # top 10 most significant 


# Reshape data for plotting
primary_df<- top_10_genes%>% dplyr::select(Gene, MSS_pri_Alt_per)
colnames(primary_df)[2] <- "Percent"
mid_df<-top_10_genes%>% dplyr::select(Gene, MSS_mid_Alt_per)
colnames(mid_df)[2] <- "Percent"

plot_df_primary_mid <- rbind(transform(primary_df, Condition = "Primary"),
                     transform(mid_df, Condition = "Metastasis"))
plot_df_primary_mid$Percent <- as.numeric(plot_df_primary_mid$Percent)
plot_df_primary_mid$Condition <- factor(plot_df_primary_mid$Condition, levels = c("Primary", "Metastasis"))

# Create the bar plot
myplot1<-ggplot(plot_df_primary_mid,aes(x = as.character(Gene), y =(Percent)*100, fill = Condition)) +
geom_bar(stat = "identity", position = "dodge")+labs(x = "Pathway", y = "Percent Oncogenic Alterations")+theme_pubr()+scale_color_lancet() + scale_fill_lancet()
#ggsave(filename = "my_plot.png", plot = myplot, width = 7, height = 7, dpi = 700)
myplot1
```

Gene:

|            |        |             |             |             |             |     |
|------------|--------|-------------|-------------|-------------|-------------|-----|
|            |        |             |             | p           | p           |     |
| **YES1**   | YES1   | 0.000000000 | 0.039800995 | 0.007277191 | NA          | 1   |
| **AGO2**   | AGO2   | 0.036809816 | 0.117318436 | 0.008035876 | 0.004677735 | 1   |
| **MYC**    | MYC    | 0.044776119 | 0.119402985 | 0.010015590 | 0.001761702 | 1   |
| **SMAD2**  | SMAD2  | 0.004975124 | 0.049751244 | 0.010671377 | 0.006655605 | 1   |
| **NKX3-1** | NKX3-1 | 0.034825871 | 0.084577114 | 0.056120390 | 0.025347319 | 1   |
| **EGFR**   | EGFR   | 0.009950249 | 0.034825871 | 0.174759599 | 0.058781721 |     |

Pathway

|             |         |            |            |             |              |            |
|-------------|---------|------------|------------|-------------|--------------|------------|
|             |         |            |            |             |              |            |
| **MYC**     | MYC     | 0.05970149 | 0.14427861 | 0.007720664 | 0.0006738585 | 0.07720664 |
| **TGFB**    | TGFB    | 0.19402985 | 0.23880597 | 0.332609241 | 0.0832645167 | 1.00000000 |
| **RTK_RAS** | RTK_RAS | 0.66169154 | 0.70149254 | 0.453667292 | 0.1305700181 |            |

```{r warning=FALSE}
left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter (os_evaluable== TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")

GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
x <- GAM_ttm
xy <- x %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight) %>% select(-SAMPLE_ID)
xy <- as.matrix(xy)
temp.obj <- Surv( x$any_ttm-x$from_sequencing_to_ttm_interval_months,x$any_ttm,  x$any_ttm_event)
cv.fit <- cv.glmnet(xy, temp.obj, family = "cox", nfolds = 15, type.measure = "C")
plot(cv.fit)

cv.fit$lambda.min
coef(cv.fit, s = "lambda.min")
num_folds <- 50

# Split data into folds
folds <- sample(rep(1:num_folds, length.out = nrow(xy)))

# Initialize a data frame to store results

coefficients_df <- data.frame(matrix(nrow = ncol(xy), ncol = 0))
rownames(coefficients_df) <- c(colnames(xy))
# Perform manual cross-validation
for (fold in 1:num_folds) {
    # Split data into training and test sets
    train_data <- xy[folds != fold, ]
    test_data <- xy[folds == fold, ]
    train_obj <- temp.obj[folds != fold]
    test_obj <- temp.obj[folds == fold]
    
    # Fit the Cox model
    cox_model <- glmnet(train_data, train_obj, family = "cox", alpha = 1, lambda = cv.fit$lambda.min)
    
    # Extract coefficients
    coefficients <- coef(cox_model, s = "lambda.min")
    
    # Store results in the data frame
    coefficients <- as.matrix(coefficients)
    
    coefficients_df <- cbind(coefficients_df, c( coefficients))
    
    
}

# Add column names to the data frame
colnames(coefficients_df) <- c(1:num_folds)

# view the results
coefficients_df <- coefficients_df %>% mutate(Average = rowMeans(.)) %>% mutate(Count = (rowSums(select(., -Average) != 0))/num_folds)
tempus <- as.matrix(coef(cv.fit, s = "lambda.min"))
colnames(tempus)[colnames(tempus) == "1"] <- 'original'

coefficients_df <-  cbind (coefficients_df, tempus )
rm(tempus)
view(coefficients_df)
ggplot(coefficients_df, aes(x = Average, y = Count, label = ifelse(Count > 0.8, rownames(coefficients_df), ""))) +
    geom_point() +
    geom_text_repel(
        box.padding = 0.5,   # Adjust box.padding to control label position
        force = 10,          # Adjust force to control label repelling strength
        min.segment.length = 0.1,  # Adjust min.segment.length to control line length
        segment.color = "grey50",  # Adjust segment.color for line color
        data = subset(coefficients_df)) +
    labs(title = "Scatter Plot of Count vs Average",
         x = "Average",
         y = "Count")
coefficients_df$Variable <- rownames(coefficients_df)
coefficients_df <- coefficients_df[order(-coefficients_df$original), ]
ggplot(coefficients_df, aes(x = reorder(Variable, original))) +
    geom_bar(aes(y = original), stat = "identity", position = "identity", alpha=.3, fill='lightblue', color='lightblue4') +
    geom_bar(aes(y = Average), stat="identity", position="identity", alpha=.3, fill='pink', color='red') +
    labs(title = "Coefficients vs. Variables",
         x = "Variable",
         y = "Coefficient") +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
final_genes <- coefficients_df %>% filter(Count > 0) %>% select(Count, Average, original)
final_genes$genes <- rownames(final_genes)


left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1))%>% filter(os_evaluable== TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, any_ttm_competing, sidedness_mpt )
left_trunc <- na.omit(left_trunc)

left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)


GAM_ttm <- GAM_final



selected_columns <- c("Samples", rownames(final_genes))  # Adjust as needed

# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
GAM_ttm<-rename(GAM_ttm,  NKX3.1 =`NKX3-1`  )
#GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns <- c(rownames(final_genes))
selected_columns <- gsub("NKX3-1", "NKX3.1", selected_columns)

formula <- as.formula(paste("Surv(any_ttm - from_sequencing_to_ttm_interval_months, any_ttm, any_ttm_event) ~", paste(selected_columns, collapse = "+"), sep = " "))

# Fit the Cox proportional hazards model
res.cox <- coxph(formula, data = GAM_ttm)
res.cox.summary<-summary(res.cox)
res <- as.data.frame(res.cox.summary$conf.int)
res_temp <- as.data.frame(res.cox.summary$coefficients)
res$p.value <- res_temp$`Pr(>|z|)`
rm(res_temp)
res<-res[-2]
names(res)<-c("HR","Lower", "Upper", "p.value")                          



res <- res[order(res$p.value), ]

top_genes <- res
top_genes$p.value <- round(top_genes$p.value, 3)


forest_plot <- ggplot(top_genes, aes(x = HR, xmin = Lower, xmax = Upper, y = rownames(top_genes))) +
    geom_point(shape = 15, size = 3) + # Hazard Ratios as boxes
    geom_errorbarh(aes(xmin = Lower, xmax = Upper), height = 0.2) + # Confidence Intervals as error bars
    geom_text(aes(label = paste("HR =", HR), x = 0.12), size = 3, hjust = 0) + # Hazard Ratios on the left
    geom_text(aes(label = paste("p =" , p.value), x = 3), size = 3, hjust = 0) + # P-values on the right
    labs(title = "Time to Metastasis",
         x = "Hazard Ratio (HR)",
         y = "Covariates") +
    theme_minimal()  + scale_x_continuous(trans = "log10", limits = c(0.12, 4.0)) +theme(axis.title.y = element_blank(),
                                                                                         axis.text.y = element_text(size = 8),
                                                                                         axis.ticks.y = element_blank())

forest_plot

top_genes$Covariate<- rownames(top_genes)
# Add a blank column for the forest plot to display CI.
# Adjust the column width with space. 
top_genes$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
top_genes$`HR (95% CI)` <-sprintf("%.2f (%.2f to %.2f)",top_genes$HR, top_genes$Lower, top_genes$Upper)
#top_genes$p.value <- round(top_genes$p.value, 3)

top_genes$p.value <- ifelse(top_genes$p.value == 0, "<0.001", top_genes$p.value)

# Define theme
tm <- forest_theme(base_size = 7,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")
p <- forest(top_genes[,c("Covariate", " ","HR (95% CI)","p.value")],
            est = top_genes$HR,
            lower = top_genes$Lower, 
            upper = top_genes$Upper,
            lci = top_genes$Lower,  # Use lower confidence interval
            uci = top_genes$Upper,
            ci_column = 2,
            ref_line = 1,
            arrow_lab = c("Longer time to metastasis", "Shorter time to metastasis"),
            xlim = c(0.2, 8),
            ticks_at = c( 0.5, 1, 2, 3,4,7 ),
            x_trans = "log10",
            space = unit(0.5, "cm"),
            theme = tm)

# Print plot
plot(p)
```

```{r}
#library(caret)
#library(pec)
#library(SurvMetrics)
#library(randomForestSRC)
#library(survivalsvm)

left_trunc <- clinical_final %>% filter(pole_pat == "wild-type", n_scans > 0, from_sequencing_to_ttm_interval_months > 0,any_ttm_event==0 | any_ttm>6,  best_unique_prim == TRUE, !(diag_to_first_radiology_interval==any_ttm & any_ttm_event==1)) %>% filter (os_evaluable== TRUE)

left_trunc <- left_trunc %>% select(SAMPLE_ID, any_ttm, from_sequencing_to_ttm_interval_months, any_ttm_event, sidedness_mpt)

left_trunc <- na.omit(left_trunc)
left_trunc$sidedness_mpt <- as.factor(left_trunc$sidedness_mpt)
one_hot_encoded <- as.data.frame(model.matrix(~sidedness_mpt - 1, data = left_trunc))
left_trunc <- cbind(left_trunc, one_hot_encoded)
GAM_ttm <- GAM_final

percentage_ones <- colMeans(GAM_ttm == 1, na.rm = TRUE) * 100
percentage_ones <- as.data.frame(percentage_ones)
percentage_ones <- percentage_ones %>% filter(percentage_ones > 2)

selected_columns <- c("Samples", rownames(percentage_ones))  # Adjust as needed
selected_columns <- selected_columns[selected_columns != "AGO2"]
# Subset the data frame
GAM_ttm <- GAM_final[, colnames(GAM_final) %in% selected_columns]

colnames(GAM_ttm)[colnames(GAM_ttm) == "Samples"] <- "SAMPLE_ID"
GAM_ttm<- inner_join(GAM_ttm, left_trunc, by = "SAMPLE_ID")
GAM_ttm <- na.omit(GAM_ttm) # removed AGO2
selected_columns[selected_columns == "Samples"] <- "SAMPLE_ID"
GAM_ttm %>% select( selected_columns, sidedness_mptRectum, sidedness_mptRight, any_ttm, any_ttm_event) %>% select(-SAMPLE_ID)
index_data <- createDataPartition(GAM_ttm$any_ttm_event, p = 0.70, list = FALSE)

# Training set
train_data <- GAM_ttm[index_data, ]

# Testing set
test_data <- GAM_ttm[-index_data, ]

fitrsf <- rfsrc(Surv(any_ttm, 
    any_ttm_event) ~ MYC + BRAF + KRAS + sidedness_mptRectum + 
    TCF7L2 + CCND2 + RNF43 + CDK8 + TP53 + SMAD4 + ERBB2 + NRAS + 
    DNMT3B + SMAD3 + SMAD2 + PIK3R1 + BCL2L1 + sidedness_mptRight + 
    PTEN + FGFR1 + AURKA + FBXW7 + AMER1 + ARID1A + `NKX3-1` + 
    PIK3CA + APC + TOP1 + ATM ,data = train_data, nsplit = 3,ntree = 500)
mat_rsf <- predict(fitrsf, test_data)$survival

dis_time <- fitrsf$time.interest
fitcox <- coxph(Surv(any_ttm, 
    any_ttm_event) ~ MYC + BRAF + KRAS + sidedness_mptRectum + 
    TCF7L2 + CCND2 + RNF43 + CDK8 + TP53 + SMAD4 + ERBB2 + NRAS + 
    DNMT3B + SMAD3 + SMAD2 + PIK3R1 + BCL2L1 + sidedness_mptRight + 
    PTEN + FGFR1 + AURKA + FBXW7 + AMER1 + ARID1A + `NKX3-1` + 
    PIK3CA + APC + TOP1 + ATM ,data = train_data, x=TRUE)
mat_cox = predictSurvProb(fitcox, test_data, dis_time)
med_index <- median(1:length(dis_time))
surv_obj <- Surv(test_data$any_ttm, test_data$any_ttm_event)
fitcox$concordance[6]

Cindex(surv_obj, predicted = mat_cox[,med_index])
Cindex(surv_obj, predicted = mat_rsf[,med_index])

#ranger tree method
r_fit <- ranger(Surv(any_ttm, 
                     any_ttm_event) ~ MYC + BRAF + KRAS + sidedness_mptRectum + 
                    TCF7L2 + CCND2 + RNF43 + CDK8 + TP53 + SMAD4 + ERBB2 + NRAS + 
                    DNMT3B + SMAD3 + SMAD2 + PIK3R1 + BCL2L1 + sidedness_mptRight + 
                    PTEN + FGFR1 + AURKA + FBXW7 + AMER1 + ARID1A + 
                    PIK3CA + APC + TOP1 + ATM, data = train_data, mtry = 4, importance = "permutation", splitrule = "extratrees", verbose = TRUE)
1-r_fit$prediction.error


```

\
\

```{r}


MSS_primary<-clinical_final%>%filter(sample_type3 == "Metastasis")%>%filter(sidedness_mpt =="Rectum")%>% filter(metsite =="Brain")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary<-MSS_primary$SAMPLE_ID
MSS_primary_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary, ]




#  MET GAM
MSS_primary_met<-clinical_final%>%filter(sample_type3 == "Metastasis")%>%filter(sidedness_mpt =="Left")%>%filter(metsite =="Brain")%>%dplyr::select(SAMPLE_ID) # get sample names 
MSS_primary_met<-MSS_primary_met$SAMPLE_ID
MSS_primary_met_GAM<-GAM_final[GAM_final$Samples %in% MSS_primary_met, ]



#MSI Primary
MSS_primary_stats<- data.frame(t(MSS_primary_GAM)) # transpose, each row = gene 
colnames(MSS_primary_stats)<-MSS_primary_stats["Samples",]
MSS_primary_stats <- MSS_primary_stats[rownames(MSS_primary_stats) != "Samples", ]
MSS_primary_stats <- MSS_primary_stats%>%mutate_all(as.numeric) #####
MSS_primary_stats <- MSS_primary_stats %>%mutate(MSS_pri_WT = rowSums(MSS_primary_stats == 0, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt= rowSums(across(!c(MSS_pri_WT))== 1, na.rm = TRUE))
MSS_primary_stats <- MSS_primary_stats %>% mutate(MSS_pri_Alt_per = MSS_pri_Alt/(MSS_pri_WT+MSS_pri_Alt))
MSS_primary_stats$MSS_pri_Alt_per[is.nan(MSS_primary_stats$MSS_pri_Alt_per)] <- 0
MSS_primary_stats <- MSS_primary_stats %>% select(MSS_pri_WT, MSS_pri_Alt, MSS_pri_Alt_per)

#MSS mid primary
MSS_mid_stats<- data.frame(t(MSS_primary_met_GAM)) # transpose, each row = gene 
colnames(MSS_mid_stats)<-MSS_mid_stats["Samples",]
MSS_mid_stats <- MSS_mid_stats[rownames(MSS_mid_stats) != "Samples", ]
MSS_mid_stats <- MSS_mid_stats%>%mutate_all(as.numeric) #####

MSS_mid_stats <- MSS_mid_stats %>%mutate(MSS_mid_WT = rowSums(MSS_mid_stats == 0, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt= rowSums(across(!c(MSS_mid_WT))== 1, na.rm = TRUE))
MSS_mid_stats <- MSS_mid_stats %>% mutate(MSS_mid_Alt_per = MSS_mid_Alt/(MSS_mid_WT+MSS_mid_Alt))
MSS_mid_stats$MSS_mid_Alt_per[is.nan(MSS_mid_stats$MSS_mid_Alt_per)] <- 0
MSS_mid_stats <- MSS_mid_stats %>% select(MSS_mid_WT, MSS_mid_Alt, MSS_mid_Alt_per)

combined_df <- merge(MSS_primary_stats, MSS_mid_stats, by = "row.names", all = TRUE)
combined_df<- combined_df %>% select(Row.names, MSS_pri_Alt_per, MSS_mid_Alt_per) 
colnames(combined_df)[1] <- "Gene" # df with MSS-primary and MSS_mid %Alt
rownames(combined_df)<-combined_df$Gene # rename rownames to Genes


for (gene in row.names(MSS_primary_stats)) {
  # Perform operations using the gene name
  contingency_table<-matrix(c(MSS_primary_stats[[gene, "MSS_pri_Alt"]], MSS_primary_stats[[gene, "MSS_pri_WT"]],MSS_mid_stats[[gene, "MSS_mid_Alt"]], MSS_mid_stats[[gene, "MSS_mid_WT"]]), nrow = 2, ncol = 2, byrow = TRUE)
  rownames(contingency_table) <- c("Primary", "Mid")
colnames(contingency_table) <- c("Altered", "Unaltered")
fisher_result <- fisher.test((contingency_table))
p_value <- fisher_result$p.value
combined_df[gene, "p_value"] <- p_value # add p_value to new column in df

}
######
#remove genes with 0% alteration for both conditions
combined_df <- subset(combined_df, !(combined_df$MSS_pri_Alt_per ==0 & combined_df$MSS_mid_Alt_per == 0))
#########
# Perform multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(combined_df$p_value, method = "fdr")

# Add the adjusted p-values to combined_df
combined_df$adjusted_p_value <- adjusted_p_values


subset_data <- combined_df[order(combined_df$adjusted_p_value), ]
top_10_genes <- head(subset_data, 10) # top 10 most significant 


# Reshape data for plotting
primary_df<- top_10_genes%>% dplyr::select(Gene, MSS_pri_Alt_per)
colnames(primary_df)[2] <- "Percent"
mid_df<-top_10_genes%>% dplyr::select(Gene, MSS_mid_Alt_per)
colnames(mid_df)[2] <- "Percent"

plot_df_primary_mid <- rbind(transform(primary_df, Condition = "Never-Met"),
                     transform(mid_df, Condition = "Later_Met"))
plot_df_primary_mid$Percent <- as.numeric(plot_df_primary_mid$Percent)
plot_df_primary_mid$Condition <- factor(plot_df_primary_mid$Condition, levels = c("Never-Met", "Later_Met"))

# Create the bar plot
myplot<-ggplot(plot_df_primary_mid,aes(x = as.character(Gene), y =(Percent)*100, fill = Condition)) +
geom_bar(stat = "identity", position = "dodge")+labs(x = "Gene", y = "Percent Oncogenic Alterations") + theme_pubr()+scale_color_lancet() + scale_fill_lancet()
#+ theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))
myplot
#ggsave(filename = "my_plot.png", plot = myplot, width = 7, height = 7, dpi = 700)
#top_MSS_genes <- combined_df[order(combined_df$MSS_pri_Alt_per, decreasing = TRUE), ]
#top_MSS_genes<-head(top_MSS_genes, 20) #save this
#top_MSS_genes<-top_MSS_genes%>% select(Gene)
```

\
